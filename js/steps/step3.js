export function renderStep3(root) {
  root.innerHTML = `
    <h2 class="text-2xl font-semibold mb-4">${window.lang.step3.title}</h2>

    <!-- üïò L·ªãch s·ª≠ h·ªôi ch·ª©ng ƒë√£ ch·∫©n ƒëo√°n -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">${window.lang.step3.past_syndrome_title}</h3>
      <ul id="past-syndrome-list" class="list-disc list-inside text-gray-700 text-sm"></ul>
    </div>

    <!-- üß™ Ph√¢n t√≠ch h·ªôi ch·ª©ng hi·ªán t·∫°i -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div>
        <label class="font-semibold block mb-1">${window.lang.step3.approach_tree}</label>
        <button id="btn-auto-tree" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
          ${window.lang.step3.tree_btn}
        </button>
        <textarea id="syndrome-model" rows="3" class="w-full border rounded px-3 py-2" placeholder="${window.lang.step3.model_placeholder}"></textarea>
        <div id="tree-extra-questions" class="mt-4 space-y-3"></div>
      </div>
      <div>
        <label class="font-semibold block mb-1">${window.lang.step3.approach_gpt}</label>
        <button id="btn-auto-classic" class="bg-green-600 text-white px-4 py-2 rounded mt-2">
          ${window.lang.step3.gpt_btn}
        </button>
        <textarea id="syndrome-classic" rows="3" class="w-full border rounded px-3 py-2" placeholder="${window.lang.step3.classic_placeholder}"></textarea>
      </div>
      <div class="md:col-span-2">
        <label class="font-semibold block mb-1">${window.lang.step3.final_label}</label>
        <input id="syndrome-final" type="text" class="w-full border rounded px-3 py-2" placeholder="${window.lang.step3.final_placeholder}">
      </div>
    </div>

    <!-- ƒêi·ªÅu h∆∞·ªõng -->
    <div class="flex justify-between">
      <button id="btn-back-step2" class="bg-gray-500 text-white px-4 py-2 rounded">${window.lang.step3.back}</button>
      <button id="btn-save-next-step3" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">${window.lang.step3.next}</button>
    </div>
  `;

  populateStep3();

  document.getElementById("btn-back-step2").onclick = () => window.location.hash = "#/step2";
  document.getElementById("btn-save-next-step3").onclick = () => {
    saveStep3();
    window.location.hash = "#/step4";
  };

  document.getElementById("btn-auto-tree").onclick = autoGenerateDiagnosticTree;
  document.getElementById("btn-auto-classic").onclick = autoSuggestClassicSyndrome;
}

// ---------- LOGIC G·ªêC ----------

function populateStep3() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const history = data.steps?.step2?.history || [];

  // L·ªãch s·ª≠ h·ªôi ch·ª©ng
  const ul = document.getElementById("past-syndrome-list");
  ul.innerHTML = "";
  history.forEach((entry, index) => {
    const label = entry?.syndrome?.final || entry?.syndrome?.model || window.lang.step3.no_record;
    const li = document.createElement("li");
    li.textContent = `${window.lang.step3.time_label.replace("{n}", index + 1)} ‚Äì ${label}`;
    ul.appendChild(li);
  });

  // Field hi·ªán t·∫°i
  const current = data.steps?.step3 || {};
  document.getElementById("syndrome-model").value = current.model || "";
  document.getElementById("syndrome-classic").value = current.classic || "";
  document.getElementById("syndrome-final").value = current.final || "";
}

function saveStep3() {
  const model = document.getElementById("syndrome-model").value.trim();
  const classic = document.getElementById("syndrome-classic").value.trim();
  const final = document.getElementById("syndrome-final").value.trim();

  const key = localStorage.getItem("currentPatient");
  if (!key) return alert(window.lang.step3.alert_no_profile || "Ch∆∞a ch·ªçn h·ªì s∆°!");

  const data = JSON.parse(localStorage.getItem(key) || "{}");
  data.steps = data.steps || {};
  data.steps.step3 = { model, classic, final };

  localStorage.setItem(key, JSON.stringify(data));
  localStorage.setItem("currentData", JSON.stringify(data));
}

async function autoSuggestClassicSyndrome() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const rawText = data.steps?.step1?.symptoms || "";
  const outputBox = document.getElementById("syndrome-classic");

  if (!rawText.trim()) {
    alert("‚ö†Ô∏è Ch∆∞a c√≥ m√¥ t·∫£ tri·ªáu ch·ª©ng ·ªü b∆∞·ªõc 1.");
    return;
  }

  outputBox.value = "‚è≥ ƒêang ph√¢n t√≠ch b·∫±ng GPT, vui l√≤ng ch·ªù...";

  const prompt = `
B·∫°n l√† chuy√™n gia Y h·ªçc c·ªï truy·ªÅn.

D∆∞·ªõi ƒë√¢y l√† m√¥ t·∫£ b·ªánh c·∫£nh c·ªßa m·ªôt b·ªánh nh√¢n, bao g·ªìm h·ªèi b·ªánh, tri·ªáu ch·ª©ng v√† d·∫•u hi·ªáu l√¢m s√†ng:

"""
${rawText}
"""

üéØ Y√äU C·∫¶U:

1. D·ª±a tr√™n m√¥ t·∫£ tr√™n, h√£y x√°c ƒë·ªãnh **h·ªôi ch·ª©ng Y h·ªçc c·ªï truy·ªÅn ph√π h·ª£p nh·∫•t** (c√≥ th·ªÉ l√† 1 ho·∫∑c nhi·ªÅu h·ªôi ch·ª©ng ph·ªëi h·ª£p).
2. V·ªõi m·ªói h·ªôi ch·ª©ng, n√™u t√™n h·ªôi ch·ª©ng v√† gi·∫£i th√≠ch ng·∫Øn g·ªçn l√Ω do ch·ªçn (tri·ªáu ch·ª©ng n√†o d·∫´n ƒë·∫øn h·ªôi ch·ª©ng ƒë√≥).
3. Tr√¨nh b√†y k·∫øt qu·∫£ nh∆∞ sau (ch·ªâ vƒÉn b·∫£n, kh√¥ng m√£ h√≥a, kh√¥ng JSON):

üìå H·ªôi ch·ª©ng: ...
üîç L√Ω do: ...
üìå H·ªôi ch·ª©ng: ...
üîç L√Ω do: ...

‚ùóKh√¥ng th√™m b·∫•t k·ª≥ ph·∫ßn m·ªü ƒë·∫ßu, l·ªùi gi·∫£i th√≠ch n√†o ngo√†i k·∫øt qu·∫£.
`.trim();

  try {
    const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
      method: "POST",
      body: JSON.stringify({ prompt })
    });

    const gptJson = await res.json();
    const gptText = gptJson?.choices?.[0]?.message?.content || "";

    if (!gptText.trim()) {
      outputBox.value = "‚ö†Ô∏è GPT kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c h·ªôi ch·ª©ng ph√π h·ª£p.";
      return;
    }

    outputBox.value = gptText.trim();

    data.steps = data.steps || {};
    data.steps.step3 = {
      ...data.steps.step3,
      classic: gptText.trim()
    };
    localStorage.setItem("currentData", JSON.stringify(data));

  } catch (err) {
    outputBox.value = "‚ùå L·ªói khi g·ªçi GPT API.";
    console.error("‚ùå L·ªói khi g·ªçi GPT API:", err);
  }
}

async function autoGenerateDiagnosticTree() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const symptoms = data.steps?.step2?.symptoms || [];
  const rawSymptoms = data.steps?.step1?.symptoms || "";
  const outputBoxModel = document.getElementById("syndrome-model");

  if (!symptoms.length) {
    alert("‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu VAS t·ª´ b∆∞·ªõc 2.");
    return;
  }
  if (outputBoxModel) outputBoxModel.value = "‚è≥ ƒêang ph√¢n t√≠ch, vui l√≤ng ch·ªù...";

  // 1. L·∫•y danh s√°ch tri·ªáu ch·ª©ng + VAS, s·∫Øp x·∫øp gi·∫£m d·∫ßn
  const sorted = [...symptoms].sort((a, b) => b.vas - a.vas);
  const symptomList = sorted.map(s => `‚Äì ${s.symptom} (VAS: ${s.vas})`).join("\n");

  // 2. Thu th·∫≠p th√¥ng tin b·ªï sung n·∫øu c√≥
  const extraAnswers = collectExtraAnswers();
  let extraText = "";

  if (extraAnswers.length > 0) {
    extraText = "\n\nüî∂ **TH√îNG TIN B·ªî SUNG T·ª™ NG∆Ø·ªúI D√ôNG:**\n" +
                extraAnswers.map(e => `‚ñ´ ${e.question}: ${e.answer}`).join("\n");
  }

  // 3. Prompt ch√≠nh
  const basePrompt = `B·∫°n l√† m·ªôt b√°c sƒ© Y h·ªçc c·ªï truy·ªÅn c√≥ kinh nghi·ªám ch·∫©n ƒëo√°n b·ªánh theo bi·ªán ch·ª©ng lu·∫≠n tr·ªã.  
T√¥i s·∫Ω cung c·∫•p danh s√°ch c√°c tri·ªáu ch·ª©ng v√† ƒëi·ªÉm VAS (m·ª©c ƒë·ªô n·∫∑ng nh·∫π).  
H√£y l√†m theo c√°c b∆∞·ªõc sau ƒë·ªÉ x√¢y d·ª±ng s∆° ƒë·ªì bi·ªán ch·ª©ng 6 b∆∞·ªõc cho h·ªôi ch·ª©ng YHCT:

üî∂ **B∆Ø·ªöC 1: X√°c ƒë·ªãnh ch·ªß ch·ª©ng**  
‚Äì H√£y l·∫•y tri·ªáu ch·ª©ng c√≥ VAS cao nh·∫•t l√†m ch·ªß ch·ª©ng.  
‚Äì Cho bi·∫øt ch·ªß ch·ª©ng ƒë√≥ l√† c·∫•p, m·∫°n, hay c·∫•p tr√™n n·ªÅn m·∫°n?  
‚Äì N·∫øu thi·∫øu th√¥ng tin, h√£y h·ªèi r√µ:  
  ‚ñ´ Ch·ªß ch·ª©ng xu·∫•t hi·ªán g·∫ßn ƒë√¢y hay ƒë√£ l√¢u?  
  ‚ñ´ Tr∆∞·ªõc ƒë√¢y ƒë√£ t·ª´ng c√≥ tri·ªáu ch·ª©ng n√†y ch∆∞a?  

üî∂ **B∆Ø·ªöC 2: Ph√¢n bi·ªát H∆∞ ‚Äì Th·ª±c c·ªßa ch·ªß ch·ª©ng**  
‚Äì D·ª±a tr√™n:  
  ‚ñ´ Ho√†n c·∫£nh kh·ªüi ph√°t: ƒë·ªôt ng·ªôt (th·ª±c), t·ª´ t·ª´ (h∆∞)  
  ‚ñ´ M·ª©c ƒë·ªô: d·ªØ d·ªôi (th·ª±c), √¢m ·ªâ (h∆∞)  
  ‚ñ´ Th·ªùi gian: v√†i ng√†y (th·ª±c), nhi·ªÅu tu·∫ßn/th√°ng (h∆∞)  
  ‚ñ´ M·∫°ch: h·ªìng, tr∆∞·ªùng, kh·∫©n, ho·∫°t, s√°p, ƒë·∫°i, h·ªØu l·ª±c (th·ª±c) / t·∫ø, vi, nh∆∞·ª£c, v√¥ l·ª±c (h∆∞)  
  ‚ñ´ L∆∞·ª°i: l∆∞·ª°i ƒë·ªè t∆∞∆°i, l∆∞·ª°i t√≠m, l∆∞·ª°i ch·∫Øc, l∆∞·ª°i thon, r√™u d√†y (th·ª±c) / l∆∞·ª°i b·ªáu, l∆∞·ª°i c√≥ d·∫•u ·∫•n rƒÉng, l∆∞·ª°i nh·∫°t, h√¨nh th·ªÉ teo, √≠t r√™u, r√™u bong tr√≥c (h∆∞)  
‚Äì N·∫øu c√≤n thi·∫øu d·ªØ ki·ªán, h√£y ƒë·∫∑t t·ª´ng c√¢u h·ªèi c·ª• th·ªÉ cho ng∆∞·ªùi d√πng.

üî∂ **B∆Ø·ªöC 3: X√°c ƒë·ªãnh nh√≥m b·ªánh nguy√™n**

**N·∫øu l√† TH·ª∞C:**
‚Äì **L·ª•c d√¢m**: c√≥ bi·ªÉu hi·ªán ngo·∫°i c·∫£m nh∆∞ s·ª£ gi√≥, s·ª£ l·∫°nh, ƒëau m·ªèi th√¢n m√¨nh ho·∫∑c c√≥ d·∫•u hi·ªáu ƒë·∫∑c tr∆∞ng phong, h√†n, th·ª≠, th·∫•p, t√°o, h·ªèa  
‚Äì **Kh√≠ u·∫•t**: tri·ªáu ch·ª©ng tƒÉng khi u·∫•t ·ª©c, gi·∫£m khi th∆∞ gi√£n, n·∫øu ƒëau th√¨ ƒëau ki·ªÉu cƒÉng tr∆∞·ªõng t·ª©c, n·∫øu l√† h√≤n kh·ªëi th√¨ l√∫c c√≥ l√∫c kh√¥ng  
‚Äì **Huy·∫øt ·ª©**: ƒëau c·ªë ƒë·ªãnh, tƒÉng v·ªÅ ƒë√™m, l∆∞·ª°i t√≠m, c√≥ ban ·ª©, tƒ©nh m·∫°ch d∆∞·ªõi l∆∞·ª°i n·ªïi, n·∫øu c√≥ xu·∫•t huy·∫øt th√¨ c√≥ m√°u c·ª•c b·∫ßm ƒëen, n·∫øu s·ªù c√≥ kh·ªëi u th√¨ kh·ªëi u ƒë√≥ c·ª©ng ch·∫Øc  
‚Äì **H·ªèa u·∫•t**: tri·ªáu ch·ª©ng k√®m n√≥ng r√°t, di·ªÖn ti·∫øn nhanh, d·ªØ d·ªôi, v√πng t·ªïn th∆∞∆°ng s·∫Ω c√≥ m√†u ƒë·ªè, s·ªù n√≥ng, c√≥ th·ªÉ c√≥ l·ªü lo√©t, m·ª•n nh·ªçt c√≥ m·ªß  
‚Äì **ƒê√†m th·∫•p**: tri·ªáu ch·ª©ng n·∫∑ng n·ªÅ, b√†i ti·∫øt ra c√°ch ch·∫•t ti·∫øt ƒë·ª•c, d∆°, m√πi tanh h√¥i  

**N·∫øu l√† H∆Ø:**
‚Äì **Kh√≠ h∆∞**: tri·ªáu ch·ª©ng l√∫c c√≥ l√∫c kh√¥ng, n·∫∑ng l√™n khi g·∫Øng s·ª©c, bi·∫øng n√≥i, l∆∞·ªùi v·∫≠n ƒë·ªông, tay ch√¢n kh√¥ng c√≥ s·ª©c, th·ªü ng·∫Øn, n√≥i ng·∫Øt qu√£ng  
‚Äì **Huy·∫øt h∆∞**: tri·ªáu ch·ª©ng li√™n t·ª•c, v√πng b·ªã ·∫£nh h∆∞·ªüng c√≥ bi·ªÉu hi·ªán thi·∫øu nu√¥i d∆∞·ª°ng nh∆∞ da ni√™m nh·ª£t v√† kh√¥, l√¥ng th∆∞a, c∆° nh·ª•c teo, g√¢n co r√∫t co c·ª©ng, kh·ªõp kh√≥ co du·ªói 
‚Äì **Tinh b·∫•t t√∫c**: ng∆∞·ªùi g·∫ßy, l∆∞ng g·ªëi m·ªèi, gi·∫£m tr√≠ nh·ªõ, bi·ªÉu hi·ªán suy gi·∫£m c√¥ng nƒÉng cu·∫£ t·ªßy, n√£o  

‚Üí D·ª±a v√†o d·ªØ ki·ªán ƒë√£ c√≥, h√£y ch·ªçn nh√≥m ph√π h·ª£p v√† gi·∫£i th√≠ch l√Ω do. N·∫øu thi·∫øu, h·ªèi c·ª• th·ªÉ.

üî∂ **B∆Ø·ªöC 4: X√°c ƒë·ªãnh t·∫°ng ph·ªß ho·∫∑c kinh l·∫°c li√™n quan**  
‚Äì D·ª±a v√†o tri·ªáu ch·ª©ng c√≤n l·∫°i ƒë·ªÉ g·ª£i √Ω t·∫°ng ph·ªß ho·∫∑c ƒë∆∞·ªùng kinh ƒëang b·ªã t·ªïn th∆∞∆°ng.

üî∂ **B∆Ø·ªöC 5: Xem x√©t t√≠nh h·ª£p l√Ω v·ªÅ th·ª© t·ª± th·ªùi gian xu·∫•t hi·ªán tri·ªáu ch·ª©ng**  
‚Äì D·ª±a v√†o ƒë·∫∑c ƒëi·ªÉm v·ªÅ th·ªùi gian xu·∫•t hi·ªán c√°c tri·ªáu ch·ª©ng trong m√¥ t·∫£ k√®m theo, h√£y xem x√©t ƒë·∫øn t√≠nh h·ª£p l√Ω v·ªÅ m·∫∑t th·ª© t·ª± xu·∫•t hi·ªán c√°c tri·ªáu ch·ª©ng theo th·ªùi gian, ƒë·ªÉ xem li·ªáu r·∫±ng th·ª© t·ª± ƒë√≥ c√≥ h·ª£p l√Ω theo l√Ω lu·∫≠n y h·ªçc c·ªï truy·ªÅn hay kh√¥ng. V√≠ d·ª•: c√°c tri·ªáu ch·ª©ng c·ªßa Can h·ªèa th∆∞·ª£ng vi√™m ph·∫£i xu·∫•t hi·ªán sau tri·ªáu ch·ª©ng c·ªßa Can kh√≠ u·∫•t k·∫øt, v√¨ Can kh√≠ u·∫•t k·∫øt l√† nguy√™n nh√¢n g√¢y ra Can h·ªèa th∆∞·ª£ng vi√™m.
‚Äì N·∫øu c√≤n thi·∫øu d·ªØ ki·ªán, h√£y ƒë·∫∑t t·ª´ng c√¢u h·ªèi c·ª• th·ªÉ cho ng∆∞·ªùi d√πng l√† y√™u c·∫ßu ng∆∞·ªùi d√πng s·∫Øp x·∫øp th·ª© t·ª± tri·ªáu ch·ª©ng m√† b·∫°n c·∫ßn theo th·ªùi gian xu·∫•t hi·ªán t·ª´ qu√° kh·ª© ƒë·∫øn hi·ªán t·∫°i.

üî∂ **B∆Ø·ªöC 6: Gi·∫£i th√≠ch c√°c tri·ªáu ch·ª©ng c√≤n l·∫°i**  
‚Äì Sau khi c√≥ ch·∫©n ƒëo√°n h·ªôi ch·ª©ng ·ªü b∆∞·ªõc 4, h√£y d√πng h·ªôi ch·ª©ng ƒë√≥ ƒë·ªÉ ki·ªÉm tra xem c√≤n tri·ªáu ch·ª©ng n√†o c·ªßa b·ªánh nh√¢n ƒë√£ ƒë∆∞·ª£c m√¥ t·∫£ m√† kh√¥ng th·ªÉ ƒë∆∞·ª£c gi·∫£i th√≠ch m·ªôt c√°ch h·ª£p l√Ω b·ªüi h·ªôi ch·ª©ng ƒë√≥ kh√¥ng? N·∫øu c√≥, h√£y l·∫•y tri·ªáu ch·ª©ng ƒë√≥ l√†m ch·ªß ch·ª©ng th·ª© 2 ƒë·ªÉ l·∫∑p l·∫°i quy tr√¨nh ch·∫©n ƒëo√°n t·ª´ b∆∞·ªõc 1 ƒë·∫øn b∆∞·ªõc 5. C·ª© l√†m v√≤ng l·∫∑p nh∆∞ v·∫≠y cho ƒë·∫øn khi t·∫•t c·∫£ tri·ªáu ch·ª©ng ƒë·ªÅu c√≥ ch·∫©n ƒëo√°n h·ª£p l√Ω.
‚Äì N·∫øu c√≤n thi·∫øu d·ªØ ki·ªán, h√£y ƒë·∫∑t t·ª´ng c√¢u h·ªèi c·ª• th·ªÉ cho ng∆∞·ªùi d√πng ƒë·ªÉ cung c·∫•p th√™m th√¥ng tin cho bi·ªán lu·∫≠n ch·∫©n ƒëo√°n h·ªôi ch·ª©ng.

üî∑ **DANH S√ÅCH TRI·ªÜU CH·ª®NG V√Ä VAS:**  
${symptomList}
${rawSymptoms}
${extraText}`; // üëà G·ªôp ph·∫ßn b·ªï sung

  // 4. G·ª≠i GPT
const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({ prompt: basePrompt })
});

  const result = await res.json();
  const reply = result.choices?.[0]?.message?.content || "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ GPT.";
  const followupQuestions = reply
  .split("\n")
  .filter(line => line.trim().startsWith("‚ñ´") || line.trim().startsWith("‚ùì"))
  .map(line => ({
    question: line.replace(/^(\‚ñ´|‚ùì)\s*/, "").trim()
  }));

  renderExtraQuestions(followupQuestions);
  localStorage.setItem("extraFollowupQuestions", JSON.stringify(followupQuestions));
  const outputBox = document.getElementById("syndrome-model");
  if (outputBox) {
    outputBox.value = reply;
  } else {
    alert("‚ùå Kh√¥ng t√¨m th·∫•y √¥ hi·ªÉn th·ªã k·∫øt qu·∫£ (syndrome-model).");
  }
}

// Render c√°c c√¢u h·ªèi followup
function renderExtraQuestions(questions) {
  const container = document.getElementById("tree-extra-questions");
  container.innerHTML = "";
  if (!questions || !questions.length) return;

  questions.forEach((q, index) => {
    const wrapper = document.createElement("div");
    wrapper.className = "mb-3";

    const label = document.createElement("label");
    label.textContent = `‚ùì ${q.question}`;
    label.className = "block text-sm font-medium text-gray-700 mb-1";

    const input = document.createElement("input");
    input.type = "text";
    input.name = `extra-${index}`;
    input.className = "extra-question-input w-full border rounded px-3 py-1 focus:outline-none focus:ring focus:ring-blue-200";
    input.placeholder = "Nh·∫≠p c√¢u tr·∫£ l·ªùi...";

    wrapper.appendChild(label);
    wrapper.appendChild(input);
    container.appendChild(wrapper);
  });
}

// L·∫•y tr·∫£ l·ªùi c√°c c√¢u h·ªèi followup
function collectExtraAnswers() {
  const inputs = document.querySelectorAll(".extra-question-input");
  const answers = [];
  inputs.forEach((input, index) => {
    const questionLabel = input.previousElementSibling?.textContent || `C√¢u h·ªèi ${index + 1}`;
    const cleanQuestion = questionLabel.replace(/^‚ùì\s*/, "").trim();
    const answer = input.value.trim();
    if (answer) {
      answers.push({ question: cleanQuestion, answer });
    }
  });
  return answers;
}
