<!-- partials/step4.html -->
<div id="step-4" class="step-section">
  <h2 class="text-2xl font-semibold mb-4">🧪 Bước 4: Gợi ý bài thuốc theo mô hình 6S</h2>

  <!-- 1. Hội chứng YHCT -->
  <div class="mb-6">
    <label class="font-semibold block mb-1">📌 Hội chứng Y học cổ truyền:</label>
    <div id="confirmed-syndrome" class="bg-gray-100 border px-4 py-2 rounded text-gray-800"></div>
  </div>

  <div class="mb-6">
    <label class="font-semibold block mb-1">🔍 Các triệu chứng nổi bật (VAS cao):</label>
    <ul id="step4-top-symptom-list" class="list-disc list-inside text-gray-700"></ul>
  </div>
  
  <!-- 2. Pháp trị và Tra cứu đối dược -->
  <div class="mb-6 border-t pt-6">
    <div class="flex flex-col md:flex-row gap-6">
      <!-- GPT gợi ý pháp trị -->
      <div class="flex-1 flex flex-col">
        <button onclick="autoSuggestMethod()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mb-3 w-full">
          ⚙️ GPT gợi ý pháp trị
        </button>
        <textarea id="treatmethod-gpt" rows="6"
          class="w-full border rounded px-3 py-2 bg-gray-100 text-gray-800 flex-grow"
          placeholder="GPT sẽ hiển thị pháp trị phù hợp cho bệnh nhân tại đây..." readonly></textarea>
      </div>
      <!-- Tra cứu đối dược -->
      <div class="flex-1 flex flex-col">
        <label for="keyword-doiduoc" class="block font-semibold mb-1">🔍 Nhập từ khóa để tra cứu đối dược:</label>
        <div class="flex space-x-2 mb-3">
          <input type="text" id="keyword-doiduoc" class="flex-grow border rounded px-3 py-2"
            placeholder="Ví dụ: Đau lưng, Thoái hóa khớp...">
          <button onclick="searchDoiDuocByKeyword()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            🔎 Tra cứu
          </button>
        </div>
        <label for="result-doiduoc" class="block font-semibold mb-1">📋 Kết quả tra cứu:</label>
        <textarea id="result-doiduoc" rows="6"
          class="w-full border rounded px-3 py-2 bg-gray-100 text-gray-800 flex-grow"
          placeholder="Kết quả sẽ hiển thị tại đây..." readonly></textarea>
      </div>
    </div>
  </div>

  <!-- 3. Mô tả mức độ vị thuốc -->
  <div class="mt-8 flex flex-col items-center">
    <label for="effectSelector" class="font-semibold mb-2 text-center">
      🧪 Chọn pháp trị để xem biểu đồ vị thuốc:
    </label>
    <select id="effectSelector" class="border rounded px-2 py-1 mb-4"></select>
    <div id="herbChartWrapper" class="w-full overflow-x-auto">
      <div class="flex justify-center min-w-fit">
        <canvas id="herbBarChart" height="300"></canvas>
      </div>
    </div>
  </div>

  <!-- 4. Các ô nhập liệu 6S -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="font-semibold">S1 – Source:</label>
      <textarea id="sixs-source" rows="2" class="w-full border rounded px-3 py-2 mt-1"
        placeholder="Các vị thuốc điều trị trực tiếp vào tác nhân gây bệnh ..."></textarea>
    </div>
    <div>
      <label class="font-semibold">S2 – Symptom:</label>
      <textarea id="sixs-symptom" rows="2" class="w-full border rounded px-3 py-2 mt-1"
        placeholder="Các vị thuốc điều trị triệu chứng than phiền chính ..."></textarea>
    </div>
    <div>
      <label class="font-semibold">S3 – Site:</label>
      <textarea id="sixs-site" rows="2" class="w-full border rounded px-3 py-2 mt-1"
        placeholder="Các vị thuốc có vị trí tác động đặc hiệu ..."></textarea>
    </div>
    <div>
      <label class="font-semibold">S4 – Strength:</label>
      <textarea id="sixs-strength" rows="2" class="w-full border rounded px-3 py-2 mt-1"
        placeholder="Chọn vị thuốc có hiệu lực tương ứng ..."></textarea>
    </div>
    <div>
      <label class="font-semibold">S5 – Side-effect:</label>
      <textarea id="sixs-sideeffect" rows="2" class="w-full border rounded px-3 py-2 mt-1"
        placeholder="Các vị thuốc làm giảm/mất tác dụng phụ ..."></textarea>
    </div>
    <div>
      <label class="font-semibold">S6 – Secondary Prevention:</label>
      <textarea id="sixs-secondary" rows="2" class="w-full border rounded px-3 py-2 mt-1"
        placeholder="Các vị thuốc cắt đứt con đường diễn tiến tiếp theo ..."></textarea>
    </div>
  </div>

  <!-- 5. Toa tổng hợp -->
  <div class="mb-6 border-t pt-6 mt-6">
    <div class="mb-4">
      <button onclick="renderFinalGPTFormula()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mb-2">
        🤖 Tổng hợp và loại trùng
      </button>
      <textarea id="final-gpt-formula" rows="3" class="w-full border rounded px-3 py-2 bg-gray-100 text-gray-800"
                readonly placeholder="Toa thuốc tổng hợp từ mô hình GPT..."></textarea>
    </div>
    <div class="mb-4">
      <label class="font-semibold block mb-1">👨‍⚕️ Bác sĩ chỉnh sửa:</label>
      <textarea id="final-doctor-formula" rows="3" class="w-full border rounded px-3 py-2"
                placeholder="Bác sĩ hiệu chỉnh lại toa thuốc cuối cùng..."></textarea>
    </div>
  </div>

  <!-- Điều hướng -->
  <div class="flex justify-between">
    <button onclick="goToStep(3)" class="bg-gray-500 text-white px-4 py-2 rounded">⬅ Quay lại</button>
    <button onclick="saveStep4(); goToStep(5)" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Tiếp tục ➡</button>
  </div>
</div>
