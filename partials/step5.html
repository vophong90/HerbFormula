<!-- partials/step5.html -->
<div id="step-5" class="step-section">
  <h2 class="text-2xl font-semibold mb-4">🔧 Bước 5: Hiệu chỉnh toa thuốc</h2>

  <!-- LỊCH SỬ TOA CŨ -->
  <div class="mb-6">
    <h3 class="text-lg font-semibold mb-2">📜 Lịch sử toa thuốc</h3>
    <div id="previous-formulas" class="space-y-4"></div>
  </div>
  <hr class="my-6">

  <!-- HIỆU CHỈNH TOA HIỆN TẠI -->
  <div class="mb-6">
    <h3 class="text-lg font-semibold mb-2">✍️ Hiệu chỉnh toa thuốc lần này:</h3>

    <div class="mb-4">
      <label class="font-semibold block mb-1">📋 Toa bác sĩ đề xuất (từ bước 4):</label>
      <textarea id="step5-doctor-draft" class="w-full border rounded px-3 py-2 bg-gray-100" rows="3" readonly></textarea>
    </div>

    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">💊 Toa thuốc cuối cùng</h3>
      <div id="final-herb-list" class="space-y-2 mb-2" data-herbs="[]"></div>
      <div class="flex gap-2 mb-4">
        <input type="text" id="final-new-herb" placeholder="Tên vị thuốc" class="flex-1 border rounded px-3 py-2">
        <input type="text" id="final-new-dose" placeholder="Liều" class="w-24 border rounded px-3 py-2">
        <button onclick="addFinalHerb()" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          ➕ Thêm
        </button>
      </div>
    </div>

    <div class="mb-4">
      <label class="font-semibold block mb-1">💊 Cách dùng:</label>
      <textarea id="step5-usage" class="w-full border rounded px-3 py-2" rows="2"
                placeholder="Sắc 1 thang/ngày, chia 2 lần sau ăn..."></textarea>
    </div>

    <div class="mb-4">
      <button onclick="autoFillStep5Note()" class="text-blue-700 hover:underline mt-2">
        📝 Ghi chú thêm
      </button>
      <textarea id="step5-note" class="w-full border rounded px-3 py-2" rows="2"
                placeholder="Ghi chú về hiệu chỉnh: tăng liều X, giảm liều Y..."></textarea>
    </div>
  </div>

  <!-- PHÂN TÍCH TOA THUỐC -->
  <div id="formula-analysis-charts" class="mt-6 space-y-6">
    <!-- 1. Tứ khí -->
    <div class="my-4">
      <button id="btn-render-tukhi" class="text-left text-lg font-semibold text-blue-700 hover:text-blue-900 hover:underline">
        1️⃣ Phân tích Tứ khí
      </button>
      <canvas id="chart-temperature" width="1000" height="80" class="mt-2 border rounded shadow"></canvas>
    </div>
    <!-- 2-3. Ngũ vị và Quy kinh trên cùng một hàng -->
    <div class="my-4 grid grid-cols-2 gap-4">
      <!-- 2. Ngũ vị -->
      <div>
        <button id="btn-render-flavor" class="text-blue-700 hover:underline text-lg font-semibold mb-2">
          📊 Phân tích Ngũ vị
        </button>
        <canvas id="chart-flavor" class="border rounded shadow" style="width: 100%; height: 300px;"></canvas>
      </div>
      <!-- 3. Quy kinh -->
      <div>
        <button id="btn-render-meridian" class="text-blue-700 hover:underline text-lg font-semibold mb-2">
          📈 Phân tích Quy kinh
        </button>
        <canvas id="chart-meridian" class="border rounded shadow" style="width: 100%; height: 300px;"></canvas>
      </div>
    </div>
    <!-- 4–5. Thăng – Giáng – Phù – Trầm và Tác dụng YHCT -->
    <div class="my-4 grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- 4. Thăng – Giáng – Phù – Trầm -->
      <div class="flex flex-col">
        <div class="text-left mb-2">
          <button id="btn-render-direction" class="text-blue-700 hover:underline text-lg font-semibold">
            🧭 Phân tích Thăng – Giáng – Phù – Trầm
          </button>
        </div>
        <div class="w-full border rounded shadow overflow-hidden" style="height: 360px;">
          <canvas id="chart-direction" class="w-full h-full"></canvas>
        </div>
      </div>
      <!-- 5. Phân tích tác dụng YHCT -->
      <div class="flex flex-col">
        <div class="text-left mb-2">
          <button id="btn-render-effect" class="text-blue-700 hover:underline text-lg font-semibold">
            🌿 Phân tích Tác dụng YHCT
          </button>
        </div>
        <div class="w-full border rounded shadow overflow-hidden" style="height: 360px;">
          <canvas id="chart-effect" class="w-full h-full"></canvas>
        </div>
      </div>
    </div>
    <div class="flex justify-between">
      <button onclick="goToStep(4)" class="bg-gray-500 text-white px-4 py-2 rounded">⬅ Quay lại</button>
      <button onclick="saveStep5(); downloadCurrentDataAsJSON()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
        💾 Lưu hồ sơ
      </button>
    </div>
  </div>
</div>
