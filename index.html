<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>🌿Hỗ trợ lập phương YHCT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="herbal_list.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
  <script>Chart.register(window['chartjs-plugin-annotation']);</script>
  <script src="doi_duoc_data.js"></script>
  <script src="organ_effects.js"></script>
  <script src="strengherb.js"></script>

</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
<div class="flex-grow">
  <div class="max-w-5xl mx-auto px-4 py-6">
    <!-- Tiêu đề chính -->
    <h1 class="text-3xl font-bold text-center mb-6">🧾 Ứng dụng hỗ trợ lập phương Y học cổ truyền</h1>

    <!-- Thanh điều hướng bước -->
    <div class="w-full max-w-none flex justify-center gap-2 px-4 py-4 whitespace-nowrap">
      <button class="step-tab" onclick="goToStep(0)">B0: Hồ sơ</button>
      <button class="step-tab" onclick="goToStep(1)">B1: Lâm sàng</button>
      <button class="step-tab" onclick="goToStep(2)">B2: Đánh giá</button>
      <button class="step-tab" onclick="goToStep(3)">B3: Biện chứng</button>
      <button class="step-tab" onclick="goToStep(4)">B4: Gợi ý toa</button>
      <button class="step-tab" onclick="goToStep(5)">B5: Hiệu chỉnh</button>
    </div>
    
<!-- BƯỚC 0: TẠO HỒ SƠ -->
   
    <div id="step-0" class="step-section">
    <label>📅 Ngày giờ khám:</label>
    <input type="datetime-local" id="visit-datetime" class="border p-1 rounded w-full mb-3">
    <h2 class="text-2xl font-semibold mb-4">📁 Bước 0: Quản lý hồ sơ bệnh nhân</h2>

  <!-- Mở hồ sơ từ file JSON -->
  <div class="mb-6">
  <label class="block text-sm font-medium mb-1">📂 Chọn hồ sơ từ file JSON:</label>
  <input type="file" id="json-file-input" accept=".json" class="block w-full text-sm text-gray-600">
  <button onclick="loadPatientFromFile()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
    📥 Mở hồ sơ
  </button>
</div>

  <hr class="my-6">

  <!-- Tạo hồ sơ mới -->
  <div class="mb-6">
    <label class="block text-sm font-medium mb-1">🆕 Tạo hồ sơ mới:</label>
    <input id="new-patient-name" type="text" placeholder="Nhập tên bệnh nhân..." class="w-full border rounded px-3 py-2">
    <button onclick="createNewPatient()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
      ➕ Tạo hồ sơ
    </button>
  </div>

  <!-- Tiếp tục -->
  <div class="mt-6">
    <button onclick="populateStep1Fields(); goToStep(1)" class="...">
  ➡ Tiếp tục bước 1
</button>
  </div>
</div>

<!-- BƯỚC 1: THÔNG TIN LÂM SÀNG -->
<div id="step-1" class="step-section hidden">
  <h2 class="text-2xl font-semibold mb-4">📋 Bước 1: Nhập thông tin lâm sàng</h2>

  <!-- Thông tin bệnh nhân -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div>
      <label class="font-medium">👤 Họ tên:</label>
      <input id="patient-name" type="text" disabled class="w-full border rounded px-3 py-2 bg-gray-100">
    </div>
    <div>
      <label class="font-medium">🎂 Năm sinh:</label>
      <input id="patient-birth" type="number" placeholder="VD: 1985" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="font-medium">🚻 Giới tính:</label>
      <select id="patient-gender" class="w-full border rounded px-3 py-2">
        <option value="">-- Chọn --</option>
        <option value="Nam">Nam</option>
        <option value="Nữ">Nữ</option>
        <option value="Khác">Khác</option>
      </select>
    </div>
  </div>

  <!-- Nhập triệu chứng -->
  <div class="mb-6">
    <label class="font-medium">💬 Triệu chứng lâm sàng:</label>
    <textarea id="patient-symptoms" rows="6" placeholder="Nhập các triệu chứng thu thập qua tứ chẩn. Mỗi triệu chứng trên một dòng, bao gồm tên triệu chứng và các đặc điểm của triệu chứng như hoàn cảnh khởi phát, cường độ, tần suất, thời gian, yếu tố tăng giảm..." class="w-full border rounded px-3 py-2"></textarea>
  </div>

  <!-- Điều hướng -->
  <div class="flex justify-between">
    <button onclick="goToStep(0)" class="bg-gray-500 text-white px-4 py-2 rounded">⬅ Quay lại</button>
    <button onclick="saveStep1(); goToStep(2)" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Tiếp tục ➡</button>
  </div>
</div>

<!-- BƯỚC 2: ĐÁNH GIÁ TRIỆU CHỨNG -->

<div id="step-2" class="step-section hidden">
  <h2 class="text-2xl font-semibold mb-4">📊 Bước 2: Đánh giá mức độ triệu chứng</h2>

  <!-- Phần nhập triệu chứng của lần khám hiện tại -->
  <div class="mb-4 space-x-2">
    <button onclick="extractSymptoms()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      🧠 Tách triệu chứng từ bước 1
    </button>
    <button onclick="rankSymptoms()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
      🔃 Ranking theo VAS
    </button>
  </div>

  <div id="symptom-vas-list" class="space-y-4"></div>

  <!-- Nếu có dữ liệu tái khám trước → hiển thị biểu đồ -->
<div id="followup-section" class="mt-8 hidden border-t pt-6">
  <h3 class="text-lg font-semibold mb-4">📈 Biểu đồ tiến triển VAS các lần khám:</h3>
  <canvas id="followup-vas-chart" height="150"></canvas>
</div>

  <!-- Điều hướng -->
  <div class="mt-6 flex justify-between">
    <button onclick="goToStep(1)" class="bg-gray-500 text-white px-4 py-2 rounded">⬅ Quay lại</button>
    <button onclick="saveStep2(); goToStep(3)" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
      Tiếp ➡
    </button>
  </div>
</div>

<!-- BƯỚC 3: BIỆN CHỨNG -->

<div id="step-3" class="step-section hidden">
  <h2 class="text-2xl font-semibold mb-4">🧠 Bước 3: Biện chứng Y học cổ truyền</h2>

  <!-- 🕘 Lịch sử hội chứng đã chẩn đoán -->
  <div class="mb-6">
    <h3 class="text-lg font-semibold mb-2">📜 Hội chứng YHCT các lần khám trước:</h3>
    <ul id="past-syndrome-list" class="list-disc list-inside text-gray-700 text-sm"></ul>
  </div>

  <!-- 🧪 Phân tích hội chứng hiện tại -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div>
      <label class="font-semibold block mb-1">🔍 Tiếp cận theo sơ đồ:</label>
      <button onclick="autoGenerateDiagnosticTree()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
       🧠 Phân tích sơ đồ
      </button>
      <textarea id="syndrome-model" rows="3" class="w-full border rounded px-3 py-2" placeholder="VD: Tỳ hư thấp thịnh, Can khí uất kết..."></textarea>
      <div id="tree-extra-questions" class="mt-4 space-y-3"></div>
    </div>

    <div>
      <label class="font-semibold block mb-1">📚 GPT gợi ý theo triệu chứng:</label>
      <button onclick="autoSuggestClassicSyndrome()" class="bg-green-600 text-white px-4 py-2 rounded mt-2">
      ⚙️ Phân tích triệu chứng
      </button>
      <textarea id="syndrome-classic" rows="3" class="w-full border rounded px-3 py-2" placeholder="Trích dẫn từ sách hoặc kinh nghiệm..."></textarea>
    </div>

    <div class="md:col-span-2">
      <label class="font-semibold block mb-1">👩‍⚕️ Hội chứng theo bác sĩ quyết định:</label>
      <input id="syndrome-final" type="text" class="w-full border rounded px-3 py-2" placeholder="VD: Tỳ khí hư, Thận dương hư...">
    </div>
  </div>

  <!-- Điều hướng -->
  <div class="flex justify-between">
    <button onclick="goToStep(2)" class="bg-gray-500 text-white px-4 py-2 rounded">⬅ Quay lại</button>
    <button onclick="saveStep3(); goToStep(4)" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Tiếp tục ➡</button>
  </div>
</div>

<!-- BƯỚC 4: GỢI Ý LẬP PHƯƠNG -->

<div id="step-4" class="step-section hidden">
  <h2 class="text-2xl font-semibold mb-4">🧪 Bước 4: Gợi ý bài thuốc theo mô hình 6S</h2>

  <!-- 1. Hội chứng YHCT -->
  <div class="mb-6">
    <label class="font-semibold block mb-1">📌 Hội chứng Y học cổ truyền:</label>
    <div id="confirmed-syndrome" class="bg-gray-100 border px-4 py-2 rounded text-gray-800"></div>
  </div>

  <div class="mb-6">
    <label class="font-semibold block mb-1">🔍 Các triệu chứng nổi bật (VAS cao):</label>
    <ul id="step4-top-symptom-list" class="list-disc list-inside text-gray-700"></ul>
  </div>
  
<!-- 2. Pháp trị và Tra cứu đối dược -->
<div class="mb-6 border-t pt-6">
  <div class="flex flex-col md:flex-row gap-6">

    <!-- GPT gợi ý pháp trị -->
    <div class="flex-1 flex flex-col">
      <button onclick="autoSuggestMethod()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mb-3 w-full">
        ⚙️ GPT gợi ý pháp trị
      </button>
      <textarea id="treatmethod-gpt" rows="6"
        class="w-full border rounded px-3 py-2 bg-gray-100 text-gray-800 flex-grow"
        placeholder="GPT sẽ hiển thị pháp trị phù hợp cho bệnh nhân tại đây..." readonly></textarea>
    </div>

    <!-- Tra cứu đối dược -->
    <div class="flex-1 flex flex-col">
      <label for="keyword-doiduoc" class="block font-semibold mb-1">🔍 Nhập từ khóa để tra cứu đối dược:</label>
      <div class="flex space-x-2 mb-3">
        <input type="text" id="keyword-doiduoc" class="flex-grow border rounded px-3 py-2"
          placeholder="Ví dụ: Đau lưng, Thoái hóa khớp...">
        <button onclick="searchDoiDuocByKeyword()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          🔎 Tra cứu
        </button>
      </div>

      <label for="result-doiduoc" class="block font-semibold mb-1">📋 Kết quả tra cứu:</label>
      <textarea id="result-doiduoc" rows="6"
        class="w-full border rounded px-3 py-2 bg-gray-100 text-gray-800 flex-grow"
        placeholder="Kết quả sẽ hiển thị tại đây..." readonly></textarea>
    </div>

  </div>
</div>

<!-- 3. Mô tả mức độ vị thuốc -->
<div class="mt-8 flex flex-col items-center">
  <label for="effectSelector" class="font-semibold mb-2 text-center">
    🧪 Chọn pháp trị để xem biểu đồ vị thuốc:
  </label>
  <select id="effectSelector" class="border rounded px-2 py-1 mb-4"></select>

  <div id="herbChartWrapper" class="w-full overflow-x-auto">
    <div class="flex justify-center min-w-fit">
      <canvas id="herbBarChart" height="300"></canvas>
    </div>
  </div>
</div>

<!-- 4. Các ô nhập liệu 6S có chú thích trực tiếp -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">

  <div>
    <label class="font-semibold">S1 – Source:</label>
    <textarea id="sixs-source" rows="2" class="w-full border rounded px-3 py-2 mt-1"
      placeholder="Các vị thuốc điều trị trực tiếp vào tác nhân gây bệnh (ví dụ: thanh nhiệt, giải biểu, trừ thấp...)"></textarea>
  </div>

  <div>
    <label class="font-semibold">S2 – Symptom:</label>
    <textarea id="sixs-symptom" rows="2" class="w-full border rounded px-3 py-2 mt-1"
      placeholder="Các vị thuốc điều trị triệu chứng than phiền chính của bệnh nhân (ví dụ: chỉ thống, chỉ khái, thư cân...)"></textarea>
  </div>

  <div>
    <label class="font-semibold">S3 – Site:</label>
    <textarea id="sixs-site" rows="2" class="w-full border rounded px-3 py-2 mt-1"
      placeholder="Các vị thuốc có vị trí tác động đặc hiệu ngay vị trí bệnh (ví dụ: phế, tỳ, quan tiết, kinh lạc...)"></textarea>
  </div>

  <div>
    <label class="font-semibold">S4 – Strength:</label>
    <textarea id="sixs-strength" rows="2" class="w-full border rounded px-3 py-2 mt-1"
      placeholder="Chọn vị thuốc có hiệu lực tương ứng với mức độ nặng của bệnh (ví dụ: đau nhiều cần chọn thuốc chỉ thống có cường độ mạnh...)"></textarea>
  </div>

  <div>
    <label class="font-semibold">S5 – Side-effect:</label>
    <textarea id="sixs-sideeffect" rows="2" class="w-full border rounded px-3 py-2 mt-1"
      placeholder="Các vị thuốc làm giảm/mất tác dụng phụ do các thuốc khác gây ra (ví dụ: bổ âm khi thuốc cay nóng, kiện tỳ khi thuốc đắng lạnh...)"></textarea>
  </div>

  <div>
    <label class="font-semibold">S6 – Secondary Prevention:</label>
    <textarea id="sixs-secondary" rows="2" class="w-full border rounded px-3 py-2 mt-1"
      placeholder="Các vị thuốc cắt đứt con đường diễn tiến tiếp theo của bệnh (ví dụ: kiện tỳ ngăn can khí uất thừa tỳ...)"></textarea>
  </div>
</div>

<!-- 5. Toa tổng hợp -->
<div class="mb-6 border-t pt-6 mt-6">
<div class="mb-4">
    <button onclick="renderFinalGPTFormula()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mb-2">
    🤖 Tổng hợp và loại trùng</button>
    <textarea id="final-gpt-formula" rows="3" class="w-full border rounded px-3 py-2 bg-gray-100 text-gray-800"
              readonly placeholder="Toa thuốc tổng hợp từ mô hình GPT..."></textarea>
  </div>

  <div class="mb-4">
    <label class="font-semibold block mb-1">👨‍⚕️ Bác sĩ chỉnh sửa:</label>
    <textarea id="final-doctor-formula" rows="3" class="w-full border rounded px-3 py-2"
              placeholder="Bác sĩ hiệu chỉnh lại toa thuốc cuối cùng..."></textarea>
  </div>
</div>

  <!-- Điều hướng -->
  <div class="flex justify-between">
    <button onclick="goToStep(3)" class="bg-gray-500 text-white px-4 py-2 rounded">⬅ Quay lại</button>
    <button onclick="saveStep4(); goToStep(5)" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Tiếp tục ➡</button>
  </div>
</div>

<!-- BƯỚC 5: HIỆU CHỈNH TOA -->
<div id="step-5" class="step-section hidden">
  <h2 class="text-2xl font-semibold mb-4">🔧 Bước 5: Hiệu chỉnh toa thuốc</h2>

  <!-- LỊCH SỬ TOA CŨ -->
  <div class="mb-6">
  <h3 class="text-lg font-semibold mb-2">📜 Lịch sử toa thuốc</h3>
  <div id="previous-formulas" class="space-y-4"></div>
  </div>
  <hr class="my-6">

  <!-- HIỆU CHỈNH TOA HIỆN TẠI -->
  <div class="mb-6">
    <h3 class="text-lg font-semibold mb-2">✍️ Hiệu chỉnh toa thuốc lần này:</h3>

    <div class="mb-4">
      <label class="font-semibold block mb-1">📋 Toa bác sĩ đề xuất (từ bước 4):</label>
      <textarea id="step5-doctor-draft" class="w-full border rounded px-3 py-2 bg-gray-100" rows="3" readonly></textarea>
    </div>

    <div class="mb-6">
    <h3 class="text-lg font-semibold mb-2">💊 Toa thuốc cuối cùng</h3>

    <!-- Danh sách vị thuốc -->
    <div id="final-herb-list" class="space-y-2 mb-2" data-herbs="[]"></div>

    <!-- Nhập thêm vị thuốc -->
    <div class="flex gap-2 mb-4">
    <input type="text" id="final-new-herb" placeholder="Tên vị thuốc"
           class="flex-1 border rounded px-3 py-2">
    <input type="text" id="final-new-dose" placeholder="Liều"
           class="w-24 border rounded px-3 py-2">
    <button onclick="addFinalHerb()" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
      ➕ Thêm
    </button>
    </div>
    </div>

    <div class="mb-4">
      <label class="font-semibold block mb-1">💊 Cách dùng:</label>
      <textarea id="step5-usage" class="w-full border rounded px-3 py-2" rows="2"
                placeholder="Sắc 1 thang/ngày, chia 2 lần sau ăn..."></textarea>
    </div>

    <div class="mb-4">
      <button onclick="autoFillStep5Note()" class="text-blue-700 hover:underline mt-2">
  📝 Ghi chú thêm
      </button>
      <textarea id="step5-note" class="w-full border rounded px-3 py-2" rows="2"
                placeholder="Ghi chú về hiệu chỉnh: tăng liều X, giảm liều Y..."></textarea>
    </div>
  </div>

<!-- PHÂN TÍCH TOA THUỐC -->
<div id="formula-analysis-charts" class="mt-6 space-y-6">

 <!-- 1. Tứ khí -->
<div class="my-4">
  <button id="btn-render-tukhi" class="text-left text-lg font-semibold text-blue-700 hover:text-blue-900 hover:underline">
    1️⃣ Phân tích Tứ khí
  </button>
  <canvas id="chart-temperature" width="1000" height="80" class="mt-2 border rounded shadow"></canvas>
</div>

  <!-- 2-3. Ngũ vị và Quy kinh trên cùng một hàng -->
<div class="my-4 grid grid-cols-2 gap-4">
  <!-- 2. Ngũ vị -->
  <div>
    <button id="btn-render-flavor" class="text-blue-700 hover:underline text-lg font-semibold mb-2">
      📊 Phân tích Ngũ vị
    </button>
    <canvas id="chart-flavor" class="border rounded shadow" style="width: 100%; height: 300px;"></canvas>
  </div>

  <!-- 3. Quy kinh -->
  <div>
    <button id="btn-render-meridian" class="text-blue-700 hover:underline text-lg font-semibold mb-2">
      📈 Phân tích Quy kinh
    </button>
    <canvas id="chart-meridian" class="border rounded shadow" style="width: 100%; height: 300px;"></canvas>
  </div>
</div>

<!-- 4–5. Thăng – Giáng – Phù – Trầm và Tác dụng YHCT -->
<div class="my-4 grid grid-cols-1 md:grid-cols-2 gap-4">
  <!-- 4. Thăng – Giáng – Phù – Trầm -->
  <div class="h-[360px] flex flex-col">
    <button id="btn-render-direction" class="text-blue-700 hover:underline text-lg font-semibold mb-2">
      🧭 Phân tích Thăng – Giáng – Phù – Trầm
    </button>
    <div class="flex-1 overflow-x-auto">
      <canvas id="chart-direction" class="border rounded shadow w-full h-full"></canvas>
    </div>
  </div>

  <!-- 5. Phân tích tác dụng YHCT -->
  <div class="h-[360px] flex flex-col">
    <button id="btn-render-effect" class="text-blue-700 hover:underline text-lg font-semibold mb-2">
      🌿 Phân tích Tác dụng YHCT
    </button>
    <div class="flex-1 overflow-x-auto">
      <canvas id="chart-effect" class="border rounded shadow w-full h-full"></canvas>
    </div>
  </div>
</div>
  
  <div class="flex justify-between">
    <button onclick="goToStep(4)" class="bg-gray-500 text-white px-4 py-2 rounded">⬅ Quay lại</button>
    <button onclick="saveStep5(); downloadCurrentDataAsJSON()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">💾 Lưu hồ sơ</button>
  </div>
</div>
  
<script>

function goToStep(n) {
  // 1. Ẩn tất cả các bước
  document.querySelectorAll(".step-section").forEach(div => div.classList.add("hidden"));

  // 2. Hiện bước được chọn
  const step = document.getElementById(`step-${n}`);
  if (step) step.classList.remove("hidden");

  // 3. Đánh dấu tab đang chọn
  document.querySelectorAll(".step-tab").forEach((btn, index) => {
    if (index === n) {
      btn.classList.add("active");
    } else {
      btn.classList.remove("active");
    }
  });

  // 4. Nếu bước có hàm render riêng thì gọi
  if (n === 2 && typeof renderStep2 === "function") renderStep2();
  if (n === 3 && typeof populateStep3 === "function") populateStep3();
  if (n === 4 && typeof populateStep4 === "function") populateStep4();
  if (n === 5 && typeof populateStep5 === "function") populateStep5();
}


//Hàm cho Bước 0

  function loadPatientFromFile() {
  const input = document.getElementById("json-file-input");
  if (!input.files || input.files.length === 0) return alert("Vui lòng chọn một file JSON!");

  const file = input.files[0];
  const reader = new FileReader();

  reader.onload = function (e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.name) return alert("⚠️ File không hợp lệ: thiếu tên bệnh nhân");

      const key = "patient_" + data.name;
      localStorage.setItem(key, JSON.stringify(data));
      localStorage.setItem("currentPatient", key);
      localStorage.setItem("currentData", JSON.stringify(data));

      alert("✅ Đã tải hồ sơ từ file: " + data.name);
      populateStep1Fields();
      goToStep(1);
    } catch (err) {
      alert("❌ Lỗi khi đọc file JSON: " + err.message);
    }
  };

  reader.readAsText(file);
}

  function createNewPatient() {
     const name = document.getElementById("new-patient-name").value.trim();
     if (!name) return alert("Vui lòng nhập tên!");

     const key = "patient_" + name;
     if (localStorage.getItem(key)) {
     if (!confirm("Hồ sơ đã tồn tại. Ghi đè?")) return;
     }

   const data = {
      name: name,
      created: new Date().toISOString(),
     steps: {}
    };

    localStorage.setItem(key, JSON.stringify(data));
    localStorage.setItem("currentPatient", key);
    localStorage.setItem("currentData", JSON.stringify(data));
    alert("✅ Đã tạo hồ sơ mới: " + name);
  }

// Hàm cho bước 1

function loadPatientRecord() {
  const key = document.getElementById("patient-file-select").value;
  if (!key) return alert("Vui lòng chọn hồ sơ!");

  const data = JSON.parse(localStorage.getItem(key) || "{}");
  localStorage.setItem("currentPatient", key);
  localStorage.setItem("currentData", JSON.stringify(data));
  alert("✅ Đã tải hồ sơ: " + key.replace("patient_", ""));

  // 🩺 Gán thông tin vào Bước 1 nếu có
  document.getElementById("patient-name").value = data.name || "";
  document.getElementById("patient-birth").value = data.birth || "";
  document.getElementById("patient-gender").value = data.gender || "";
  document.getElementById("patient-symptoms").value = data.steps?.step1?.symptoms || "";
}

function saveStep1() {
  const name = document.getElementById("patient-name").value;
  const birth = document.getElementById("patient-birth").value;
  const gender = document.getElementById("patient-gender").value;
  const symptoms = document.getElementById("patient-symptoms").value.trim();

  const key = localStorage.getItem("currentPatient");
  if (!key) return alert("Chưa chọn hồ sơ!");

  const data = JSON.parse(localStorage.getItem(key) || "{}");
  data.birth = birth;
  data.gender = gender;
  data.steps = data.steps || {};
  data.steps.step1 = { birth, gender, symptoms };

  localStorage.setItem(key, JSON.stringify(data));
  localStorage.setItem("currentData", JSON.stringify(data));
}

function populateStep1Fields() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  document.getElementById("patient-name").value = data.name || "";
  document.getElementById("patient-birth").value = data.birth || "";
  document.getElementById("patient-gender").value = data.gender || "";
  document.getElementById("patient-symptoms").value = data.steps?.step1?.symptoms || "";
}


//Hàm cho bước 2

async function extractSymptoms() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const raw = data?.steps?.step1?.symptoms || "";

  if (!raw.trim()) {
    alert("⚠️ Không có dữ liệu triệu chứng để phân tích.");
    return;
  }

  const prompt = `
Bạn là bác sĩ Y học cổ truyền. Dưới đây là đoạn mô tả triệu chứng và kết quả hỏi bệnh của bệnh nhân:

"${raw}"

Hãy tách ra danh sách các triệu chứng cụ thể, mỗi dòng ghi 1 triệu chứng ngắn gọn và dễ hiểu (không lặp từ). Lưu ý chỉ lấy triệu chứng, không lấy các đặc điểm của triệu chứng đó. Không cần phân tích, chỉ liệt kê như sau:
1. [triệu chứng 1]
2. [triệu chứng 2]
...`;

  const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({ prompt: prompt })
});

  const result = await res.json();
  const reply = result.choices?.[0]?.message?.content || "";
  const lines = reply
    .split("\n")
    .map(line => line.replace(/^\d+\.\s*/, "").trim())
    .filter(line => line.length > 0);

  if (!lines.length) {
    alert("❌ GPT không trích xuất được triệu chứng.");
    return;
  }

  const container = document.getElementById("symptom-vas-list");
  container.innerHTML = "";
  lines.forEach(symptom => container.appendChild(createSymptomVASBlock(symptom)));
}

function updateSortedVAS() {
  const container = document.getElementById("symptom-vas-list");
  const items = Array.from(container.children);

  items.forEach(div => {
    const slider = div.querySelector("input[type=range]");
    slider.outputDiv.textContent = "VAS: " + slider.value;
  });

  // Sắp xếp lại theo VAS giảm dần
  items.sort((a, b) => {
    const va = parseInt(a.querySelector("input").value);
    const vb = parseInt(b.querySelector("input").value);
    return vb - va;
  });

  container.innerHTML = "";
  items.forEach(div => container.appendChild(div));
}

function createSymptomVASBlock(symptom, vas = 5) {
  const div = document.createElement("div");
  div.className = "bg-gray-100 p-3 rounded shadow relative symptom-item";

  const label = document.createElement("label");
  label.className = "block font-semibold mb-2";
  label.textContent = `🔹 ${symptom}`;
  div.appendChild(label);

  // Thanh trượt
  const slider = document.createElement("input");
  slider.type = "range";
  slider.min = 0;
  slider.max = 10;
  slider.step = 0.1;
  slider.value = vas;
  slider.className = "w-full mb-1";
  slider.dataset.symptom = symptom;
  div.appendChild(slider);

  // Ô nhập số
  const input = document.createElement("input");
  input.type = "number";
  input.min = 0;
  input.max = 10;
  input.step = 0.1;
  input.value = vas;
  input.className = "border border-gray-300 rounded w-20 p-1 text-right text-sm float-right";
  div.appendChild(input);

  // Text hiển thị
  const output = document.createElement("span");
  output.className = "text-sm text-gray-700 font-mono";
  output.textContent = "VAS: " + vas;
  div.appendChild(output);

  // Đồng bộ slider <-> input
slider.oninput = () => {
  input.value = slider.value;
  output.textContent = "VAS: " + parseFloat(slider.value).toFixed(1);
  triggerLiveVAS(); // 🔁 gọi lại biểu đồ
};

input.oninput = () => {
  const val = Math.max(0, Math.min(10, parseFloat(input.value) || 0));
  slider.value = val;
  output.textContent = "VAS: " + val.toFixed(1);
  triggerLiveVAS(); // 🔁 gọi lại biểu đồ
};

  // Nút xóa
  const btn = document.createElement("button");
  btn.textContent = "🗑️";
  btn.className = "absolute top-2 right-2 text-red-600 hover:text-red-800 text-lg";
  btn.onclick = () => div.remove();
  div.appendChild(btn);

  return div;
}

function rankSymptoms() {
  const container = document.getElementById("symptom-vas-list");
  const items = Array.from(container.querySelectorAll(".symptom-item"));

  items.sort((a, b) => {
    const va = parseFloat(a.querySelector("input[type=range]").value);
    const vb = parseFloat(b.querySelector("input[type=range]").value);
    return vb - va;
  });

  container.innerHTML = "";
  items.forEach(el => container.appendChild(el));
}

function renderStep2() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");

  // 🔁 Gộp tất cả triệu chứng trong lịch sử và triệu chứng mới
  const history = data.steps?.step2?.history || [];
  const allSymptoms = new Set();

  history.forEach(entry => entry.symptoms?.forEach(s => allSymptoms.add(s.symptom)));
  const newSymptoms = (data.steps?.step1?.symptoms || "").split("\n").map(s => s.trim()).filter(Boolean);
  newSymptoms.forEach(s => allSymptoms.add(s));

  const currentVAS = {};
  // Nếu có symptoms hiện tại → lấy lại VAS cũ
  (data.steps?.step2?.symptoms || []).forEach(s => {
    currentVAS[s.symptom] = s.vas;
  });

  // Render
  const container = document.getElementById("symptom-vas-list");
  container.innerHTML = "";
  Array.from(allSymptoms).forEach(symptom => {
    const vas = currentVAS[symptom] ?? 5;
    container.appendChild(createSymptomVASBlock(symptom, vas));
  });

  // Hiện biểu đồ nếu có history
  if (history.length > 0) {
    document.getElementById("followup-section").classList.remove("hidden");
    renderVASChart(); // giữ nguyên
  } else {
    document.getElementById("followup-section").classList.add("hidden");
  }
}

let followupChart = null;

function renderVASChart() {
  const ctx = document.getElementById("followup-vas-chart").getContext("2d");
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");

  const history = data.steps?.step6?.followupHistory || data.steps?.step2?.history || [];
  const temp = data.steps?.step6?.followupSymptoms || [];
  const initial = data.steps?.step2?.symptoms || [];

  // ✅ Tổng hợp tất cả triệu chứng từng xuất hiện
  const symptomSet = new Set();

  initial.forEach(s => symptomSet.add(s.symptom));
  history.forEach(entry => entry.symptoms.forEach(s => symptomSet.add(s.symptom)));
  temp.forEach(s => symptomSet.add(s.symptom));  // ❗ Bổ sung dòng này để nhận biết triệu chứng mới thêm

  const allSymptoms = Array.from(symptomSet);

  // ✅ Gán nhãn trục X
  const labels = ["VAS 0", ...history.map((_, i) => `VAS ${i + 1}`)];
  if (temp.length > 0) labels.push(`VAS ${history.length + 1}`);

  // ✅ Xây dựng dữ liệu theo từng triệu chứng
  const datasets = allSymptoms.map(symptom => {
    const dataPoints = [];

    // Lần 0: ban đầu
    const s0 = initial.find(s => s.symptom === symptom);
    dataPoints.push(s0 ? s0.vas : null);

    // Các lần tái khám cũ
    history.forEach(entry => {
      const match = entry.symptoms.find(s => s.symptom === symptom);
      dataPoints.push(match ? match.vas : null);
    });

    // Lần hiện tại (đang theo dõi)
    if (temp.length > 0) {
      const match = temp.find(s => s.symptom === symptom);
      dataPoints.push(match ? match.vas : null);
    }

    return {
      label: symptom,
      data: dataPoints,
      fill: false,
      tension: 0.3,
      borderWidth: 2
    };
  });

  // ✅ Xóa biểu đồ cũ nếu có
  if (followupChart) followupChart.destroy();

  // ✅ Vẽ biểu đồ mới
  followupChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: "bottom"
        },
        tooltip: {
          mode: "index",
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 10,
          title: {
            display: true,
            text: "VAS"
          }
        }
      }
    }
  });
}

function triggerLiveVAS() {
  const blocks = document.querySelectorAll(".symptom-item");
  const currentSymptoms = Array.from(blocks).map(block => {
    const symptom = block.querySelector("input[type=range]").dataset.symptom;
    const vas = parseFloat(block.querySelector("input[type=range]").value);
    return { symptom, vas };
  });

  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  data.steps = data.steps || {};
  data.steps.step6 = data.steps.step6 || {};
  data.steps.step6.followupSymptoms = currentSymptoms;

  localStorage.setItem("currentData", JSON.stringify(data));
  renderVASChart();
}

function saveStep2() {
  const key = localStorage.getItem("currentPatient");
  if (!key) return alert("Chưa chọn hồ sơ!");

  const data = JSON.parse(localStorage.getItem(key) || "{}");
  data.steps = data.steps || {};
  data.steps.step2 = data.steps.step2 || {};

  // Lưu VAS hiện tại tạm thời (chưa lưu vào history)
  const blocks = document.querySelectorAll(".symptom-item");
  const symptoms = Array.from(blocks).map(block => {
    const symptom = block.querySelector("input[type=range]").dataset.symptom;
    const vas = parseFloat(block.querySelector("input[type=range]").value);
    return { symptom, vas };
  });

  data.steps.step2.symptoms = symptoms;

  // Để biểu đồ vẽ đúng lần đang theo dõi
  data.steps.step6 = data.steps.step6 || {};
  data.steps.step6.followupSymptoms = symptoms;

  localStorage.setItem(key, JSON.stringify(data));
  localStorage.setItem("currentData", JSON.stringify(data));
}

//Hàm cho bước 3

function populateStep3() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const history = data.steps?.step2?.history || [];

  // Hiển thị danh sách hội chứng các lần khám trước
  const ul = document.getElementById("past-syndrome-list");
  ul.innerHTML = "";

  history.forEach((entry, index) => {
    const label = entry?.syndrome?.final || entry?.syndrome?.model || "(Chưa ghi)";
    const li = document.createElement("li");
    li.textContent = `Lần ${index + 1} – ${label}`;
    ul.appendChild(li);
  });

  // Hiển thị lại nội dung của lần hiện tại nếu có
  const current = data.steps?.step3 || {};
  document.getElementById("syndrome-model").value = current.model || "";
  document.getElementById("syndrome-classic").value = current.classic || "";
  document.getElementById("syndrome-final").value = current.final || "";
}

function renderStep3() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const current = data.steps?.step3 || {};

  // ✅ Nếu chưa có step3, nhưng step2.history có hội chứng → gán lại
  if (!current.final) {
    const lastEntry = data.steps?.step2?.history?.at(-1);
    if (lastEntry?.syndrome?.final || lastEntry?.syndrome?.model) {
      current.model = lastEntry.syndrome.model || "";
      current.classic = lastEntry.syndrome.classic || "";
      current.final = lastEntry.syndrome.final || "";
    }
  }

  // Đổ dữ liệu lên giao diện
  document.getElementById("syndrome-model").value = current.model || "";
  document.getElementById("syndrome-classic").value = current.classic || "";
  document.getElementById("syndrome-final").value = current.final || "";

  // Đồng thời hiển thị lịch sử hội chứng trước đó
  populateStep3();
}

function saveStep3() {
  const model = document.getElementById("syndrome-model").value.trim();
  const classic = document.getElementById("syndrome-classic").value.trim();
  const final = document.getElementById("syndrome-final").value.trim();

  const key = localStorage.getItem("currentPatient");
  if (!key) return alert("Chưa chọn hồ sơ!");

  const data = JSON.parse(localStorage.getItem(key) || "{}");

  // ✅ Chỉ lưu vào step3, không đụng tới history
  data.steps = data.steps || {};
  data.steps.step3 = { model, classic, final };

  localStorage.setItem(key, JSON.stringify(data));
  localStorage.setItem("currentData", JSON.stringify(data));
}

async function autoSuggestClassicSyndrome() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const rawText = data.steps?.step1?.symptoms || "";
  const outputBox = document.getElementById("syndrome-classic");

  if (!rawText.trim()) {
    alert("⚠️ Chưa có mô tả triệu chứng ở bước 1.");
    return;
  }

  outputBox.value = "⏳ Đang phân tích bằng GPT, vui lòng chờ...";

  const prompt = `
Bạn là chuyên gia Y học cổ truyền.

Dưới đây là mô tả bệnh cảnh của một bệnh nhân, bao gồm hỏi bệnh, triệu chứng và dấu hiệu lâm sàng:

"""
${rawText}
"""

🎯 YÊU CẦU:

1. Dựa trên mô tả trên, hãy xác định **hội chứng Y học cổ truyền phù hợp nhất** (có thể là 1 hoặc nhiều hội chứng phối hợp).
2. Với mỗi hội chứng, nêu tên hội chứng và giải thích ngắn gọn lý do chọn (triệu chứng nào dẫn đến hội chứng đó).
3. Trình bày kết quả như sau (chỉ văn bản, không mã hóa, không JSON):

📌 Hội chứng: ...
🔍 Lý do: ...
📌 Hội chứng: ...
🔍 Lý do: ...

❗Không thêm bất kỳ phần mở đầu, lời giải thích nào ngoài kết quả.
`.trim();

 try {
  const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    body: JSON.stringify({ prompt })
  });

  const gptJson = await res.json();  // ⬅️ lấy dạng JSON
  const gptText = gptJson?.choices?.[0]?.message?.content || "";

  if (!gptText.trim()) {
    outputBox.value = "⚠️ GPT không xác định được hội chứng phù hợp.";
    return;
  }

  outputBox.value = gptText.trim();

  data.steps = data.steps || {};
  data.steps.step3 = {
    classic: gptText.trim()
  };
  localStorage.setItem("currentData", JSON.stringify(data));

} catch (err) {
  outputBox.value = "❌ Lỗi khi gọi GPT API.";
  console.error("❌ Lỗi khi gọi GPT API:", err);
}
}

async function autoGenerateDiagnosticTree() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const symptoms = data.steps?.step2?.symptoms || [];
  const rawSymptoms = data.steps?.step1?.symptoms || "";
  const outputBoxModel = document.getElementById("syndrome-model");

  if (!symptoms.length) {
    alert("⚠️ Chưa có dữ liệu VAS từ bước 2.");
    return;
  }
  if (outputBoxModel) outputBoxModel.value = "⏳ Đang phân tích, vui lòng chờ...";

  // 1. Lấy danh sách triệu chứng + VAS, sắp xếp giảm dần
  const sorted = [...symptoms].sort((a, b) => b.vas - a.vas);
  const symptomList = sorted.map(s => `– ${s.symptom} (VAS: ${s.vas})`).join("\n");

  // 2. Thu thập thông tin bổ sung nếu có
  const extraAnswers = collectExtraAnswers();
  let extraText = "";

  if (extraAnswers.length > 0) {
    extraText = "\n\n🔶 **THÔNG TIN BỔ SUNG TỪ NGƯỜI DÙNG:**\n" +
                extraAnswers.map(e => `▫ ${e.question}: ${e.answer}`).join("\n");
  }

  // 3. Prompt chính
  const basePrompt = `Bạn là một bác sĩ Y học cổ truyền có kinh nghiệm chẩn đoán bệnh theo biện chứng luận trị.  
Tôi sẽ cung cấp danh sách các triệu chứng và điểm VAS (mức độ nặng nhẹ).  
Hãy làm theo các bước sau để xây dựng sơ đồ biện chứng 6 bước cho hội chứng YHCT:

🔶 **BƯỚC 1: Xác định chủ chứng**  
– Hãy lấy triệu chứng có VAS cao nhất làm chủ chứng.  
– Cho biết chủ chứng đó là cấp, mạn, hay cấp trên nền mạn?  
– Nếu thiếu thông tin, hãy hỏi rõ:  
  ▫ Chủ chứng xuất hiện gần đây hay đã lâu?  
  ▫ Trước đây đã từng có triệu chứng này chưa?  

🔶 **BƯỚC 2: Phân biệt Hư – Thực của chủ chứng**  
– Dựa trên:  
  ▫ Hoàn cảnh khởi phát: đột ngột (thực), từ từ (hư)  
  ▫ Mức độ: dữ dội (thực), âm ỉ (hư)  
  ▫ Thời gian: vài ngày (thực), nhiều tuần/tháng (hư)  
  ▫ Mạch: hồng, trường, khẩn, hoạt, sáp, đại, hữu lực (thực) / tế, vi, nhược, vô lực (hư)  
  ▫ Lưỡi: lưỡi đỏ tươi, lưỡi tím, lưỡi chắc, lưỡi thon, rêu dày (thực) / lưỡi bệu, lưỡi có dấu ấn răng, lưỡi nhạt, hình thể teo, ít rêu, rêu bong tróc (hư)  
– Nếu còn thiếu dữ kiện, hãy đặt từng câu hỏi cụ thể cho người dùng.

🔶 **BƯỚC 3: Xác định nhóm bệnh nguyên**

**Nếu là THỰC:**
– **Lục dâm**: có biểu hiện ngoại cảm như sợ gió, sợ lạnh, đau mỏi thân mình hoặc có dấu hiệu đặc trưng phong, hàn, thử, thấp, táo, hỏa  
– **Khí uất**: triệu chứng tăng khi uất ức, giảm khi thư giãn, nếu đau thì đau kiểu căng trướng tức, nếu là hòn khối thì lúc có lúc không  
– **Huyết ứ**: đau cố định, tăng về đêm, lưỡi tím, có ban ứ, tĩnh mạch dưới lưỡi nổi, nếu có xuất huyết thì có máu cục bầm đen, nếu sờ có khối u thì khối u đó cứng chắc  
– **Hỏa uất**: triệu chứng kèm nóng rát, diễn tiến nhanh, dữ dội, vùng tổn thương sẽ có màu đỏ, sờ nóng, có thể có lở loét, mụn nhọt có mủ  
– **Đàm thấp**: triệu chứng nặng nề, bài tiết ra cách chất tiết đục, dơ, mùi tanh hôi  

**Nếu là HƯ:**
– **Khí hư**: triệu chứng lúc có lúc không, nặng lên khi gắng sức, biếng nói, lười vận động, tay chân không có sức, thở ngắn, nói ngắt quãng  
– **Huyết hư**: triệu chứng liên tục, vùng bị ảnh hưởng có biểu hiện thiếu nuôi dưỡng như da niêm nhợt và khô, lông thưa, cơ nhục teo, gân co rút co cứng, khớp khó co duỗi 
– **Tinh bất túc**: người gầy, lưng gối mỏi, giảm trí nhớ, biểu hiện suy giảm công năng cuả tủy, não  

→ Dựa vào dữ kiện đã có, hãy chọn nhóm phù hợp và giải thích lý do. Nếu thiếu, hỏi cụ thể.

🔶 **BƯỚC 4: Xác định tạng phủ hoặc kinh lạc liên quan**  
– Dựa vào triệu chứng còn lại để gợi ý tạng phủ hoặc đường kinh đang bị tổn thương.

🔶 **BƯỚC 5: Xem xét tính hợp lý về thứ tự thời gian xuất hiện triệu chứng**  
– Dựa vào đặc điểm về thời gian xuất hiện các triệu chứng trong mô tả kèm theo, hãy xem xét đến tính hợp lý về mặt thứ tự xuất hiện các triệu chứng theo thời gian, để xem liệu rằng thứ tự đó có hợp lý theo lý luận y học cổ truyền hay không. Ví dụ: các triệu chứng của Can hỏa thượng viêm phải xuất hiện sau triệu chứng của Can khí uất kết, vì Can khí uất kết là nguyên nhân gây ra Can hỏa thượng viêm.
– Nếu còn thiếu dữ kiện, hãy đặt từng câu hỏi cụ thể cho người dùng là yêu cầu người dùng sắp xếp thứ tự triệu chứng mà bạn cần theo thời gian xuất hiện từ quá khứ đến hiện tại.

🔶 **BƯỚC 6: Giải thích các triệu chứng còn lại**  
– Sau khi có chẩn đoán hội chứng ở bước 4, hãy dùng hội chứng đó để kiểm tra xem còn triệu chứng nào của bệnh nhân đã được mô tả mà không thể được giải thích một cách hợp lý bởi hội chứng đó không? Nếu có, hãy lấy triệu chứng đó làm chủ chứng thứ 2 để lặp lại quy trình chẩn đoán từ bước 1 đến bước 5. Cứ làm vòng lặp như vậy cho đến khi tất cả triệu chứng đều có chẩn đoán hợp lý.
– Nếu còn thiếu dữ kiện, hãy đặt từng câu hỏi cụ thể cho người dùng để cung cấp thêm thông tin cho biện luận chẩn đoán hội chứng.

🔷 **DANH SÁCH TRIỆU CHỨNG VÀ VAS:**  
${symptomList}
${rawSymptoms}
${extraText}`; // 👈 Gộp phần bổ sung

  // 4. Gửi GPT
const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({ prompt: basePrompt })
});

  const result = await res.json();
  const reply = result.choices?.[0]?.message?.content || "Không nhận được phản hồi từ GPT.";
  const followupQuestions = reply
  .split("\n")
  .filter(line => line.trim().startsWith("▫") || line.trim().startsWith("❓"))
  .map(line => ({
    question: line.replace(/^(\▫|❓)\s*/, "").trim()
  }));

  renderExtraQuestions(followupQuestions);
  localStorage.setItem("extraFollowupQuestions", JSON.stringify(followupQuestions));
  const outputBox = document.getElementById("syndrome-model");
  if (outputBox) {
    outputBox.value = reply;
  } else {
    alert("❌ Không tìm thấy ô hiển thị kết quả (syndrome-model).");
  }
}

function renderExtraQuestions(questions) {
  const container = document.getElementById("tree-extra-questions");
  container.innerHTML = "";

  if (!questions || !questions.length) return;

  questions.forEach((q, index) => {
    const wrapper = document.createElement("div");
    wrapper.className = "mb-3";

    const label = document.createElement("label");
    label.textContent = `❓ ${q.question}`;
    label.className = "block text-sm font-medium text-gray-700 mb-1";

    const input = document.createElement("input");
    input.type = "text";
    input.name = `extra-${index}`;
    input.className = "extra-question-input w-full border rounded px-3 py-1 focus:outline-none focus:ring focus:ring-blue-200";
    input.placeholder = "Nhập câu trả lời...";

    wrapper.appendChild(label);
    wrapper.appendChild(input);
    container.appendChild(wrapper);
  });
}

function collectExtraAnswers() {
  const inputs = document.querySelectorAll(".extra-question-input");
  const answers = [];

  inputs.forEach((input, index) => {
    const questionLabel = input.previousElementSibling?.textContent || `Câu hỏi ${index + 1}`;
    const cleanQuestion = questionLabel.replace(/^❓\s*/, "").trim();
    const answer = input.value.trim();

    if (answer) {
      answers.push({ question: cleanQuestion, answer });
    }
  });

  return answers;
}


//Hàm cho bước 4

function populateStep4() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");

  // Hội chứng từ bước 3
  const syndrome = data.steps?.step3?.final || "(chưa xác định)";
  const syndromeDiv = document.getElementById("confirmed-syndrome");
  if (syndromeDiv) syndromeDiv.textContent = syndrome;

  // Triệu chứng nổi bật
  const symptoms = data.steps?.step2?.symptoms || [];
  const sorted = [...symptoms].sort((a, b) => b.vas - a.vas);
  const topSymptoms = sorted.slice(0, 5);

  const ul = document.getElementById("step4-top-symptom-list");
  if (ul) {
    ul.innerHTML = "";
    topSymptoms.forEach(s => {
      const li = document.createElement("li");
      li.textContent = `${s.symptom} (VAS ${s.vas})`;
      ul.appendChild(li);
    });
  }

  // Nạp dữ liệu các ô đã có
  const step4 = data.steps?.step4 || {};
  const sixs = step4.sixs || {};

  const fields = [
    ["classic-formula-gpt", step4.gptClassicFormula],
    ["final-gpt-formula", step4.finalGPT],
    ["final-doctor-formula", step4.finalDoctor],
    ["sixs-source", sixs.source],
    ["sixs-symptom", sixs.symptom],
    ["sixs-site", sixs.site],
    ["sixs-strength", sixs.strength],
    ["sixs-sideeffect", sixs.sideeffect],
    ["sixs-secondary", sixs.secondary]
  ];

  fields.forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.value = value || "";
  });
  setupHerbBarChartUI();
}

  // Gợi ý pháp trị YHCT
  async function autoSuggestMethod() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const syndrome = data.steps?.step3?.final?.trim();
  const symptoms = data.steps?.step2?.symptoms || [];

  const outputBox = document.getElementById("treatmethod-gpt");

  if (!syndrome || symptoms.length === 0) {
    outputBox.value = "⚠️ Thiếu dữ liệu hội chứng hoặc triệu chứng.";
    return;
  }

  outputBox.value = "⏳ Đang gợi ý pháp trị, vui lòng chờ...";

  const symptomList = symptoms
    .sort((a, b) => b.vas - a.vas)
    .map((s, i) => `${i + 1}. ${s.symptom} (VAS: ${s.vas})`)
    .join("\n");

  const prompt = `
Bạn là chuyên gia Y học cổ truyền.

Bệnh nhân được chẩn đoán theo YHCT là: **${syndrome}**

Danh sách các triệu chứng đã ghi nhận, sắp xếp theo mức độ VAS:

${symptomList}

Dựa trên chẩn đoán và triệu chứng, hãy xác định các pháp trị phù hợp theo nguyên tắc biện chứng luận trị. Pháp trị cần chia làm hai nhóm rõ ràng:

🔹 **Trị bản** (nhằm điều trị cơ chế sinh bệnh, gốc rễ bệnh theo lý luận tạng phủ, khí huyết, tà chính, hư thực...).

🔹 **Trị tiêu** (nhằm điều trị triệu chứng hiện tại đang gây khó chịu nhiều nhất).

Yêu cầu:
- Chỉ chọn trong các pháp trị chuẩn của Trung y, không được sáng tạo.
- Ưu tiên trình bày bằng thuật ngữ Hán Việt.
- Không viết thừa, không lan man.

Trình bày kết quả như sau:

🔸 **Trị bản:**  
– Pháp trị: ...  
– Lý do chọn pháp trị: ...

🔸 **Trị tiêu:**  
– Pháp trị: ...  
– Lý do chọn pháp trị: ...
`;

  const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ prompt: prompt })
  });

  const result = await res.json();
  const reply = result.choices?.[0]?.message?.content || "❌ GPT không trả về kết quả.";

  outputBox.value = reply;
}

  function searchDoiDuocByKeyword() {
  const input = document.getElementById("keyword-doiduoc");
  const keyword = input.value.trim().toLowerCase();
  const resultBox = document.getElementById("result-doiduoc");

  if (!keyword) {
    resultBox.value = "⚠️ Vui lòng nhập từ khóa.";
    return;
  }

  const keywords = keyword.split(/\s+/).filter(k => k); // tách từ

  const matches = (window.doiDuocData || []).filter(item => {
    const chutriText = item.chutri?.toLowerCase() || "";
    return keywords.every(word => chutriText.includes(word));
  });

  if (matches.length === 0) {
    resultBox.value = "❌ Không tìm thấy kết quả phù hợp.";
    return;
  }

  resultBox.value = matches.map(item =>
    `📌 Đối dược: ${item.doiduoc}\n📋 Chủ trị: ${item.chutri}`
  ).join("\n\n");
}
  
function setupHerbBarChartUI() {
  const select = document.getElementById("effectSelector");
  const effects = Object.keys(window.herbsByEffect || {});

  // Xóa cũ nếu có
  select.innerHTML = '<option value="">-- Chọn pháp trị --</option>';

  for (const eff of effects) {
    const option = document.createElement("option");
    option.value = eff;
    option.textContent = eff;
    select.appendChild(option);
  }

  select.addEventListener("change", () => {
    const selected = select.value;
    if (selected) {
      drawHerbBarChart(selected);
    }
  });
}

  let herbChartInstance;

 function drawHerbBarChart(effect) {
  const data = window.herbsByEffect?.[effect] || [];

  const labels = data.map(d => d.vietnamese);
  const scores = data.map(d => d.score);

  const canvas = document.getElementById("herbBarChart");
  const ctx = canvas.getContext("2d");

  // ✅ Huỷ biểu đồ cũ nếu có
  if (window.herbChartInstance) {
    window.herbChartInstance.destroy();
  }

  // ✅ Gán lại kích thước canvas theo số lượng cột
  const columnWidth = 60;
  const chartWidth = Math.max(400, labels.length * columnWidth);
  canvas.removeAttribute("style");
  canvas.setAttribute("width", chartWidth);
  canvas.setAttribute("height", 300);

  // ✅ enrich dữ liệu với thông tin từ herbalData
  const enrichedData = data.map(d => {
    const matched = window.herbalData.find(h => h.herb === d.vietnamese);
    return {
      ...d,
      tukhi: matched?.tukhi ?? null,
      sd_dose: matched?.sd_dose ?? null,
      latin: matched?.latin ?? null
    };
  });

  // ✅ màu theo tukhi
  function tukhiToColor(tukhi) {
    if (tukhi == null) return "white";
    const colors = [
      "#2c7bb6", "#00a6ca", "#00ccbc", "#ffffbf",
      "#fdae61", "#f46d43", "#d73027"
    ];
    if (tukhi <= -3.5) return colors[0];
    if (tukhi <= -2)   return colors[1];
    if (tukhi <= -0.5) return colors[2];
    if (tukhi < 0.5)   return colors[3];
    if (tukhi < 2)     return colors[4];
    if (tukhi < 3.5)   return colors[5];
    return colors[6];
  }

  const backgroundColors = enrichedData.map(d =>
    d.tukhi == null ? "white" : tukhiToColor(d.tukhi)
  );

  const borderColors = enrichedData.map(d =>
    d.tukhi == null ? "#cccccc" : "black"
  );

  // ✅ Vẽ biểu đồ sau khi DOM ổn định
  requestAnimationFrame(() => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    window.herbChartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "Điểm mạnh (score)",
          data: scores,
          backgroundColor: backgroundColors,
          borderColor: borderColors,
          borderWidth: 2,
          barThickness: 40
        }]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { autoSkip: false },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            grid: { display: true }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                const herb = enrichedData[ctx.dataIndex];
                const latin = herb.latin || "–";
                const dose = herb.sd_dose != null ? `${herb.sd_dose}g` : "Không rõ liều";
                return `${herb.vietnamese} (${latin}):\nĐiểm: ${herb.score}, Liều: ${dose}`;
              }
            }
          }
        }
      }
    });
  });
}

function renderFinalGPTFormula() {
  const fields = [
    "sixs-source",
    "sixs-symptom",
    "sixs-site",
    "sixs-strength",
    "sixs-sideeffect",
    "sixs-secondary"
  ];

  const herbSet = new Set();

  for (const id of fields) {
    const value = document.getElementById(id)?.value || "";
    const herbs = value.split(",").map(h => h.trim()).filter(h => h);
    herbs.forEach(h => herbSet.add(h));
  }

  const finalFormula = Array.from(herbSet).join(", ");

  const outputBox = document.getElementById("final-gpt-formula");
  if (outputBox) outputBox.value = finalFormula;
}

function saveStep4() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");

  // Thu thập dữ liệu từ các ô 6S
  const sixs = {
    source: document.getElementById("sixs-source")?.value || "",
    symptom: document.getElementById("sixs-symptom")?.value || "",
    site: document.getElementById("sixs-site")?.value || "",
    strength: document.getElementById("sixs-strength")?.value || "",
    sideeffect: document.getElementById("sixs-sideeffect")?.value || "",
    secondary: document.getElementById("sixs-secondary")?.value || ""
  };

  // Toa thuốc tổng hợp GPT và bác sĩ
  const finalGPT = document.getElementById("final-gpt-formula")?.value || "";
  const finalDoctor = document.getElementById("final-doctor-formula")?.value || "";

  // Lưu lại vào localStorage
  data.steps = data.steps || {};
  data.steps.step4 = {
    sixs: sixs,
    finalGPT: finalGPT,
    finalDoctor: finalDoctor
  };

  localStorage.setItem("currentData", JSON.stringify(data));
  console.log("✅ Đã lưu dữ liệu bước 4.");
}
  
//Hàm cho bước 5

function populateStep5() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");

  // PHẦN 1: Hiển thị lại các toa thuốc cũ
  const container = document.getElementById("previous-formulas");
  if (!container) return console.error("❌ Không tìm thấy phần tử #previous-formulas");
  container.innerHTML = "";

  const history = data.steps?.step2?.history || [];
  history.forEach((entry, i) => {
    const formulaText = [];

    const date = entry?.datetime || `(Chưa ghi ngày)`;
    const syndrome = entry?.syndrome?.final || "(chưa có hội chứng)";
    const finalFormula = entry?.step5?.finalFormula || "(chưa lưu)";
    const usage = entry?.step5?.usage || "(chưa ghi)";
    const note = entry?.step5?.note || "";

    formulaText.push(`🗓️ Lần ${i + 1} – Ngày: ${date} – Hội chứng: ${syndrome}`);
    formulaText.push(`🧾 Toa thuốc: ${finalFormula}`);
    formulaText.push(`💊 Cách dùng: ${usage}`);
    if (note) formulaText.push(`📝 Ghi chú: ${note}`);

    const box = document.createElement("textarea");
    box.className = "w-full border rounded px-3 py-2 bg-gray-100 mb-4";
    box.rows = 5;
    box.readOnly = true;
    box.value = formulaText.join("\n\n");

    container.appendChild(box);
  });

  // PHẦN 2: Hiển thị toa bác sĩ từ bước 4
  const doctorDraft = document.getElementById("step5-doctor-draft");
  if (doctorDraft) {
  doctorDraft.value = data.steps?.step4?.finalDoctor || "";
  parseDoctorDraftFormula();
  }

  const finalFormula = document.getElementById("step5-final-formula");
  if (finalFormula) finalFormula.value = data.steps?.step5?.finalFormula || "";

  const usage = document.getElementById("step5-usage");
  if (usage) usage.value = data.steps?.step5?.usage || "";

  const note = document.getElementById("step5-note");
  if (note) note.value = data.steps?.step5?.note || "";
}

function parseDoctorDraftFormula() {
  const draft = document.getElementById("step5-doctor-draft")?.value || "";
  const container = document.getElementById("final-herb-list");
  if (!draft || !container) return;

  const herbs = [];

  // Chuẩn hóa: tách bằng dấu phẩy hoặc dấu cộng
  const items = draft.split(/[,+]/);

  items.forEach(item => {
    const parts = item.trim().match(/^(.+?)\s*(\d+(?:[.,]\d+)?)/);
    if (parts && parts.length >= 3) {
      const name = parts[1].trim();
      const dose = parts[2].replace(",", "."); // chuyển 12,5 → 12.5
      herbs.push({ name, dose });
    }
  });

  renderFinalHerbList(herbs);
}

function renderFinalHerbList(herbs) {
  const container = document.getElementById("final-herb-list");
  container.innerHTML = "";

  herbs.forEach((item, index) => {
    const row = document.createElement("div");
    row.className = "flex items-center gap-2";

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.value = item.name;
    nameInput.className = "flex-1 border rounded px-3 py-2";
    nameInput.oninput = () => herbs[index].name = nameInput.value;

    const doseInput = document.createElement("input");
    doseInput.type = "text";
    doseInput.value = item.dose;
    doseInput.className = "w-24 border rounded px-3 py-2";
    doseInput.oninput = () => herbs[index].dose = doseInput.value;

    const btn = document.createElement("button");
    btn.textContent = "🗑️";
    btn.className = "text-red-600 hover:text-red-800";
    btn.onclick = () => {
      herbs.splice(index, 1);
      renderFinalHerbList(herbs);
    };

    row.appendChild(nameInput);
    row.appendChild(doseInput);
    row.appendChild(btn);
    container.appendChild(row);
  });

  container.dataset.herbs = JSON.stringify(herbs);
}

function renderPrescriptionHistory() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const history = data.steps?.step2?.history || [];
  const container = document.getElementById("prescription-history");
  container.innerHTML = "";

  if (history.length === 0) {
    container.innerHTML = "<p class='text-gray-500'>Chưa có lần khám nào trước đó.</p>";
    return;
  }

  history.forEach((entry, index) => {
    const div = document.createElement("div");
    div.className = "p-4 border rounded bg-white shadow";

    const datetime = entry.datetime || "(không rõ ngày)";
    const syndrome = entry.syndrome?.final || "(chưa ghi)";
    const formula = entry.step5?.finalFormula || "(chưa có)";
    const usage = entry.step5?.usage || "";
    const note = entry.step5?.note || "";

    div.innerHTML = `
      <div class="text-sm text-gray-700 mb-1">🕒 <b>Lần khám ${index + 1}</b> – ${datetime}</div>
      <div class="mb-1">🧠 <b>Hội chứng:</b> ${syndrome}</div>
      <div class="mb-1">💊 <b>Toa thuốc:</b> ${formula}</div>
      <div class="mb-1">📄 <b>Cách dùng:</b> ${usage}</div>
      <div class="mb-1">📝 <b>Ghi chú:</b> ${note}</div>
    `;
    container.appendChild(div);
  });
}

function renderFinalHerbList(herbs) {
  const container = document.getElementById("final-herb-list");
  container.innerHTML = "";

  herbs.forEach((item, index) => {
    const row = document.createElement("div");
    row.className = "flex items-center gap-2 herb-row";

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.value = item.name;
    nameInput.className = "flex-1 border rounded px-3 py-2 herb-name";
    nameInput.oninput = () => herbs[index].name = nameInput.value;

    const doseInput = document.createElement("input");
    doseInput.type = "text";
    doseInput.value = item.dose;
    doseInput.className = "w-24 border rounded px-3 py-2 herb-dose";
    doseInput.oninput = () => herbs[index].dose = doseInput.value;

    const btn = document.createElement("button");
    btn.textContent = "🗑️";
    btn.className = "text-red-600 hover:text-red-800";
    btn.onclick = () => {
      herbs.splice(index, 1);
      renderFinalHerbList(herbs);
    };

    row.appendChild(nameInput);
    row.appendChild(doseInput);
    row.appendChild(btn);
    container.appendChild(row);
  });

  container.dataset.herbs = JSON.stringify(herbs);
}

function addFinalHerb() {
  const name = document.getElementById("final-new-herb").value.trim();
  const dose = document.getElementById("final-new-dose").value.trim();
  if (!name || !dose) return;

  const container = document.getElementById("final-herb-list");
  const herbs = JSON.parse(container.dataset.herbs || "[]");

  herbs.push({ name, dose });
  document.getElementById("final-new-herb").value = "";
  document.getElementById("final-new-dose").value = "";
  renderFinalHerbList(herbs);
}

function getFinalHerbList() {
  const rows = document.querySelectorAll("#final-herb-list .herb-row");
  const herbs = [];
  rows.forEach(row => {
    const name = row.querySelector(".herb-name")?.value?.trim();
    const dose = row.querySelector(".herb-dose")?.value?.trim();
    if (name && dose && !isNaN(dose)) {
      herbs.push({ name, dose: parseFloat(dose) });
    }
  });
  return herbs;
}

function renderChartTemperature() {
  const herbs = getFinalHerbList();
  if (!herbs.length || !window.herbalData) {
    console.warn("❌ Không có vị thuốc hoặc dữ liệu herbalData chưa sẵn sàng.");
    return;
  }

  let sum = 0, count = 0;
  const missingTukhi = [];

  herbs.forEach(h => {
    const item = window.herbalData.find(x => x.herb === h.name);
    if (!item) {
      missingTukhi.push(h.name + " (không tìm thấy)");
      return;
    }

    const tukhi = parseFloat(item.tukhi);
    const sd_dose = parseFloat(item.sd_dose);
    const dose = h.dose;

    if (!isNaN(tukhi) && !isNaN(sd_dose) && sd_dose > 0) {
      const score = (dose / sd_dose) * tukhi;
      sum += score;
      count++;
    } else {
      missingTukhi.push(h.name + " (thiếu tứ khí hoặc SD)");
    }
  });

  if (missingTukhi.length > 0) {
    alert("⚠️ Thiếu dữ liệu cho các vị thuốc:\n- " + missingTukhi.join("\n- "));
  }

  const avgScore = count ? sum / count : 0;
  renderGradientScale(avgScore); // Gọi vẽ thanh gradient
}

function renderGradientScale(avgScore) {
  const canvas = document.getElementById("chart-temperature");
  const ctx = canvas.getContext("2d");

  const width = canvas.width;
  const height = canvas.height;

  // Xóa canvas cũ
  ctx.clearRect(0, 0, width, height);

  // Màu các vùng tứ khí
  const colors = [
    "#2c7bb6", // Đại Hàn
    "#00a6ca", // Hàn
    "#00ccbc", // Lương
    "#ffffbf", // Bình
    "#fdae61", // Ôn
    "#f46d43", // Nhiệt
    "#d73027"  // Đại Nhiệt
  ];

  const labels = ["Đại Hàn", "Hàn", "Lương", "Bình", "Ôn", "Nhiệt", "Đại Nhiệt"];
  const numZones = labels.length;
  const zoneWidth = width / numZones;

  // Vẽ từng vùng màu
  for (let i = 0; i < numZones; i++) {
    ctx.fillStyle = colors[i];
    ctx.fillRect(i * zoneWidth, 30, zoneWidth, 30);
  }

  // Vẽ nhãn vùng
  ctx.fillStyle = "#000";
  ctx.font = "12px sans-serif";
  ctx.textAlign = "center";

  labels.forEach((label, i) => {
    const x = i * zoneWidth + zoneWidth / 2;
    ctx.fillText(label, x, 75);
  });

  // Vẽ mũi tên chỉ vị trí avgScore [-5 đến +5]
  const normalized = (avgScore + 5) / 10;  // chuyển sang khoảng [0,1]
  const posX = normalized * width;

  ctx.fillStyle = "black";
  ctx.font = "20px sans-serif";
  ctx.fillText("⬇", posX, 25);
}

function renderChartFlavor() {
  const herbs = getFinalHerbList();
  if (!herbs.length || !window.herbalData) {
    console.warn("❌ Không có vị thuốc hoặc dữ liệu.");
    return;
  }

  const flavorLabels = ["Toan", "Tân", "Hàm", "Khổ", "Cam", "Phương hương"];
  const flavorKeys = ["chua", "cay", "man", "dang", "ngot", "muithom"];
  const flavorTotals = [0, 0, 0, 0, 0, 0];
  const missingFlavorData = [];

  herbs.forEach(h => {
    const item = window.herbalData.find(x => x.herb === h.name);
    if (!item) {
      missingFlavorData.push(h.name + " (không tìm thấy)");
      return;
    }

    const dose = parseFloat(h.dose);
    const sd_dose = parseFloat(item.sd_dose);

    if (isNaN(dose) || isNaN(sd_dose) || sd_dose === 0) {
      missingFlavorData.push(h.name + " (thiếu liều hoặc SD)");
      return;
    }

    let valid = true;
    const scores = flavorKeys.map(key => {
      const value = parseFloat(item[key]);
      if (isNaN(value)) {
        valid = false;
        return 0;
      }
      return (dose / sd_dose) * value;
    });

    if (!valid) {
      missingFlavorData.push(h.name + " (thiếu trị số ngũ vị)");
    }

    scores.forEach((s, i) => flavorTotals[i] += s);
  });

  // 🔔 Cảnh báo nếu thiếu thông tin
  if (missingFlavorData.length > 0) {
    alert("⚠️ Các vị thuốc sau thiếu dữ liệu vị hoặc mùi:\n- " + missingFlavorData.join("\n- "));
  }

  // 🎯 Vẽ biểu đồ radar
  const ctx = document.getElementById("chart-flavor").getContext("2d");

  if (window.flavorChart) {
    window.flavorChart.destroy();
  }

  window.flavorChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels: flavorLabels,
      datasets: [{
        label: "Tổng hợp ngũ vị & mùi",
        data: flavorTotals,
        fill: true,
        backgroundColor: "rgba(255, 99, 132, 0.2)",
        borderColor: "rgba(255, 99, 132, 1)"
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: {
          beginAtZero: true,
          suggestedMax: Math.max(...flavorTotals) + 1
        }
      }
    }
  });
}

function renderChartMeridian() {
  const herbs = getFinalHerbList();
  if (!herbs.length || !window.herbalData) {
    console.warn("❌ Không có vị thuốc hoặc dữ liệu herbalData chưa sẵn sàng.");
    return;
  }

  const meridianLabels = ["Tâm", "Can", "Tỳ", "Phế", "Thận", "Tâm bào", "Đại trường", "Tiểu trường", "Vị", "Đởm", "Bàng quang", "Tam tiêu"];
  const meridianKeys = ["tam", "can", "ty", "phe", "than", "tambao", "dai truong", "tieutruong", "vi", "dom", "bangquang", "tamtieu"];
  const meridianTotals = Array(12).fill(0);
  const missingMeridianData = [];

  herbs.forEach(h => {
    const item = window.herbalData.find(x => x.herb === h.name);
    if (!item) {
      missingMeridianData.push(h.name + " (không tìm thấy)");
      return;
    }

    const dose = parseFloat(h.dose);
    const sd_dose = parseFloat(item.sd_dose);

    if (isNaN(dose) || isNaN(sd_dose) || sd_dose === 0) {
      missingMeridianData.push(h.name + " (thiếu liều hoặc SD)");
      return;
    }

    let valid = true;
    const scores = meridianKeys.map(key => {
      const value = parseFloat(item[key]);
      if (isNaN(value)) {
        valid = false;
        return 0;
      }
      return (dose / sd_dose) * value;
    });

    if (!valid) {
      missingMeridianData.push(h.name + " (thiếu trị số quy kinh)");
    }

    scores.forEach((s, i) => meridianTotals[i] += s);
  });

  if (missingMeridianData.length > 0) {
    alert("⚠️ Các vị thuốc sau thiếu dữ liệu quy kinh:\n- " + missingMeridianData.join("\n- "));
  }

  const ctx = document.getElementById("chart-meridian").getContext("2d");

  if (window.meridianChart) {
    window.meridianChart.destroy();
  }

  window.meridianChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels: meridianLabels,
      datasets: [{
        label: "Tổng hợp quy kinh",
        data: meridianTotals,
        backgroundColor: "rgba(255, 205, 86, 0.2)",
        borderColor: "rgba(255, 205, 86, 1)"
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: {
          beginAtZero: true,
          suggestedMax: Math.max(...meridianTotals) + 1
        }
      }
    }
  });
}

function safeParseNumber(value) {
  if (value === null || value === undefined || value === "") return NaN;
  return typeof value === "number" ? value : parseFloat(String(value).trim());
}

function renderChartDirection() {
  const herbs = getFinalHerbList();
  if (!herbs.length || !window.herbalData) {
    alert("⚠️ Không có vị thuốc hoặc dữ liệu.");
    return;
  }

  let xTotal = 0;
  let yTotal = 0;
  const missing = [];

  herbs.forEach(h => {
    const item = window.herbalData.find(x => x.herb === h.name);
    if (!item) {
      missing.push(h.name + " (không tìm thấy)");
      return;
    }

    const dose = parseFloat(h.dose);
    const sd = parseFloat(item.sd_dose);
    const tg = parseFloat(item.thanggiang);
    const pt = parseFloat(item.phutram);

    if ([dose, sd, tg, pt].some(v => isNaN(v))) {
      missing.push(h.name + " (thiếu trị số Thăng – Giáng – Phù – Trầm)");
      return;
    }

    xTotal += (dose / sd) * pt;
    yTotal += (dose / sd) * tg;
  });

  if (missing.length) {
    alert("⚠️ Các vị thuốc thiếu dữ liệu:\n- " + missing.join("\n- "));
  }
   // ⚙️ Canvas setup
  const canvas = document.getElementById("chart-direction");
  const ctx = canvas.getContext("2d");
  const width = canvas.width;
  const height = canvas.height;
  ctx.clearRect(0, 0, width, height);

  // 📐 Tự động scale sao cho điểm M nằm trong khung
  const margin = 40; // px biên an toàn
  const maxAbsX = Math.abs(xTotal);
  const maxAbsY = Math.abs(yTotal);

  const scaleX = (width / 2 - margin) / (maxAbsX || 1); // tránh chia 0
  const scaleY = (height / 2 - margin) / (maxAbsY || 1);
  const scale = Math.min(scaleX, scaleY);

  const originX = width / 2;
  const originY = height / 2;

  // 🧭 Lưới động
  const step = 1;
  const maxGridX = Math.floor((width / 2) / scale);
  const maxGridY = Math.floor((height / 2) / scale);

  ctx.lineWidth = 1;
  ctx.strokeStyle = "#e5e7eb";

  for (let i = -maxGridX; i <= maxGridX; i++) {
    if (i === 0) continue;
    ctx.beginPath();
    ctx.moveTo(originX + i * scale, 0);
    ctx.lineTo(originX + i * scale, height);
    ctx.stroke();
  }

  for (let i = -maxGridY; i <= maxGridY; i++) {
    if (i === 0) continue;
    ctx.beginPath();
    ctx.moveTo(0, originY - i * scale);
    ctx.lineTo(width, originY - i * scale);
    ctx.stroke();
  }

  // 🧭 Trục X, Y
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0, originY);
  ctx.lineTo(width, originY);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(originX, 0);
  ctx.lineTo(originX, height);
  ctx.stroke();

  // ✍️ Nhãn trục
  ctx.font = "16px Segoe UI";
  ctx.fillStyle = "#1f2937";
  ctx.fillText("🡒 Phù", width - 60, originY - 10);
  ctx.fillText("🡐 Trầm", 10, originY - 10);
  ctx.fillText("🡑 Thăng", originX + 10, 20);
  ctx.fillText("🡓 Giáng", originX + 10, height - 10);

  // 🔵 Vẽ điểm M
  const pointX = originX + xTotal * scale;
  const pointY = originY - yTotal * scale;

  ctx.fillStyle = "#2563eb";
  ctx.shadowColor = "rgba(0,0,0,0.2)";
  ctx.shadowBlur = 4;
  ctx.beginPath();
  ctx.arc(pointX, pointY, 5, 0, 2 * Math.PI);
  ctx.fill();
  ctx.shadowBlur = 0;

  ctx.fillStyle = "#111827";
  ctx.fillText(`M (${xTotal.toFixed(2)}, ${yTotal.toFixed(2)})`, pointX + 10, pointY - 10);
}

function autoFillStep5Note() {
  const herbs = getFinalHerbList();
  if (!herbs.length || !window.herbalData) {
    alert("⚠️ Không có vị thuốc hoặc dữ liệu.");
    return;
  }

  const lines = [];

  herbs.forEach(h => {
    const item = window.herbalData.find(x => x.herb === h.name);
    if (!item) return;

    const toxicNote = item.toxic?.trim();
    const generalNote = item.note?.trim();

    let combinedNote = "";

    if (toxicNote) combinedNote += `☠️ ${toxicNote}`;
    if (generalNote) {
      if (combinedNote) combinedNote += " | ";
      combinedNote += `📝 ${generalNote}`;
    }

    if (combinedNote) {
      lines.push(`• ${h.name}: ${combinedNote}`);
    }
  });

  const noteBox = document.getElementById("step5-note");
  noteBox.value = lines.join("\n") || "Không có ghi chú đặc biệt.";
}

function renderChartEffect() {
  const herbsByEffect = window.herbsByEffect || {};
  const masterHerbData = window.herbalData || [];
  const formula = getFinalHerbList(); // ✅ Lấy đúng toa thuốc cuối cùng

  if (!Array.isArray(formula) || formula.length === 0) {
    alert("⚠️ Không có toa thuốc để phân tích.");
    return;
  }

  const effectScores = {};

  console.log("🌿 BẮT ĐẦU PHÂN TÍCH TÁC DỤNG YHCT");
  console.log("📦 Toa thuốc cần phân tích:", formula);

  for (const herbItem of formula) {
    const herbName = herbItem.name?.trim();
    const doseUsed = parseFloat(herbItem.dose || 0);

    if (!herbName || doseUsed <= 0) {
      console.warn(`⚠️ Bỏ qua vị thuốc không hợp lệ: ${herbName}`);
      continue;
    }

    const standard = masterHerbData.find(h => h.herb?.trim() === herbName && h.sd_dose);
    const sdDose = standard ? parseFloat(standard.sd_dose) : doseUsed;

    console.log(`➡️ Đang xử lý: ${herbName} (dùng ${doseUsed}g, chuẩn ${sdDose}g)`);

    let matched = false;

    for (const [effect, herbs] of Object.entries(herbsByEffect)) {
      for (const h of herbs) {
        const hName = h.vietnamese?.trim();
        const score = parseFloat(h.score || 0);

        if (hName === herbName && score > 0 && sdDose > 0) {
          matched = true;
          const weighted = (score * doseUsed) / sdDose;
          effectScores[effect] = (effectScores[effect] || 0) + weighted;

          console.log(`✅ Khớp: "${herbName}" → ${effect} (+${weighted.toFixed(2)})`);
        }
      }
    }

    if (!matched) {
      console.warn(`❌ Không tìm thấy tác dụng phù hợp cho: ${herbName}`);
    }
  }

  console.log("📊 Tổng hợp điểm theo tác dụng:", effectScores);

  const labels = Object.keys(effectScores);
  const values = Object.values(effectScores).map(x => +x.toFixed(2));

  if (labels.length === 0) {
    alert("⚠️ Không có tác dụng YHCT nào được xác định.");
    return;
  }

  const ctx = document.getElementById("chart-effect").getContext("2d");
  if (window.effectChart) window.effectChart.destroy();
  window.effectChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Tổng điểm tác dụng",
        data: values,
        backgroundColor: "rgba(255, 159, 64, 0.6)",
        borderColor: "rgba(255, 159, 64, 1)",
        borderWidth: 1,
        barThickness: labels.length > 15 ? 10 : labels.length > 10 ? 15 : 20
      }]
    },
    options: {
  indexAxis: "y",
  responsive: true,
  maintainAspectRatio: false, // ⚠️ để canvas cao theo div cha
  plugins: {
    title: {
      display: true,
      text: "Phân tích tổng điểm Tác dụng YHCT của bài thuốc"
    },
    legend: { display: false }
  },
  scales: {
    x: { beginAtZero: true },
    y: {
      ticks: {
        autoSkip: false,
        font: (ctx) => {
          const total = labels.length;
          const size = total > 15 ? 10 : total > 10 ? 12 : 14;
          return { size };
        }
      }
    }
  }
}
  });

  console.log("✅ Biểu đồ đã được vẽ.");
}
  
function saveStep5() {
  // ✅ Lấy dữ liệu vị thuốc từ khối nhập
  const herbContainer = document.getElementById("final-herb-list");
  const herbs = JSON.parse(herbContainer?.dataset.herbs || "[]");

  // ✅ Gộp thành chuỗi finalFormula: "Tên1 Liều1 + Tên2 Liều2 + ..."
  const finalFormula = herbs.map(h => `${h.name} ${h.dose}`).join(" + ");

  // ✅ Lấy các thông tin còn lại
  const usage = document.getElementById("step5-usage").value.trim();
  const note = document.getElementById("step5-note").value.trim();
  const datetime = document.getElementById("visit-datetime")?.value || new Date().toISOString();

  // ✅ Xác định bệnh nhân
  const key = localStorage.getItem("currentPatient");
  if (!key) return alert("Chưa chọn hồ sơ!");

  const data = JSON.parse(localStorage.getItem(key) || "{}");
  data.steps = data.steps || {};

  // ✅ Lưu thông tin bước 5 (để hiển thị lại nếu chưa nhấn Lưu Hồ sơ)
  data.steps.step5 = {
    finalFormula,
    usage,
    note
  };

  // ✅ Lấy dữ liệu từ các bước trước
  const symptoms = data.steps?.step2?.symptoms || [];
  const syndrome = data.steps?.step3 || {};  // Có model, classic, final

  // ✅ Tạo bản ghi cho lần khám mới
  const newEntry = {
    datetime,
    symptoms,
    syndrome: {
      model: syndrome.model || "",
      classic: syndrome.classic || "",
      final: syndrome.final || ""
    },
    step5: {
      finalFormula,
      usage,
      note
    }
  };

  // ✅ Đưa vào lịch sử
  data.steps.step2.history = data.steps.step2.history || [];
  data.steps.step2.history.push(newEntry);

  // ✅ Cập nhật cho biểu đồ (bước 6)
  data.steps.step6 = data.steps.step6 || {};
  data.steps.step6.followupHistory = data.steps.step2.history;

  // ✅ Xóa các dữ liệu tạm (cho lần khám tiếp theo)
  delete data.steps.step2.symptoms;
  delete data.steps.step3;
  delete data.steps.step4;
  delete data.steps.step5;

  // ✅ Lưu lại vào localStorage
  localStorage.setItem(key, JSON.stringify(data));
  localStorage.setItem("currentData", JSON.stringify(data));

  alert("✅ Đã lưu hoàn tất lần khám mới vào hồ sơ!");
}

function downloadCurrentDataAsJSON() {
  const data = localStorage.getItem("currentData");
  const patientKey = localStorage.getItem("currentPatient") || "patient_data";
  if (!data) return alert("Không có dữ liệu để lưu!");

  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;

  const fileName = patientKey.replace("patient_", "") + "_" + new Date().toISOString().split("T")[0] + ".json";
  a.download = fileName;

  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

  window.onload = () => {
    goToStep(0);
  };
  </script>

  <style>
  .step-tab {
    background-color: #dbeafe; /* bg-blue-100 */
    color: #1e40af;            /* text-blue-800 */
    font-weight: 600;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    transition: all 0.2s;
  }

  .step-tab:hover {
    background-color: #93c5fd; /* hover:bg-blue-300 */
  }

  .step-tab.active {
    background-color: #2563eb; /* bg-blue-600 */
    color: white;
  }
</style>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  // 👉 Các nút vẽ biểu đồ Tứ khí, Ngũ vị, Kinh lạc, Phương hướng
  document.getElementById("btn-render-tukhi")?.addEventListener("click", renderChartTemperature);
  document.getElementById("btn-render-flavor")?.addEventListener("click", renderChartFlavor);
  document.getElementById("btn-render-meridian")?.addEventListener("click", renderChartMeridian);
  document.getElementById("btn-render-direction")?.addEventListener("click", renderChartDirection);
  document.getElementById("btn-render-effect")?.addEventListener("click", renderChartEffect);

  // 👉 Dropdown chọn pháp trị để vẽ biểu đồ vị thuốc
  const selector = document.getElementById("effectSelector");
  if (selector) {
    const allEffects = Object.keys(window.herbsByEffect || {});
    for (const effect of allEffects) {
      const opt = document.createElement("option");
      opt.value = effect;
      opt.textContent = effect;
      selector.appendChild(opt);
    }

    selector.addEventListener("change", e => {
      drawHerbBarChart(e.target.value);
    });

    // ✅ Tự động vẽ biểu đồ đầu tiên
    if (allEffects.length > 0) {
      selector.value = allEffects[0];
      drawHerbBarChart(allEffects[0]);
    }
  } else {
    console.warn("⚠️ Không tìm thấy #effectSelector để gán dropdown pháp trị.");
  }
});
</script>
<footer class="mt-16 border-t bg-gray-100 text-center text-sm text-gray-600 py-6 shadow-inner">
    👨‍💻 Thiết kế bởi <strong>Võ Thanh Phong</strong> với sự hỗ trợ của <strong>ChatGPT</strong>.<br>
    © <span id="currentYear"></span> Bản quyền thuộc về <strong>Võ Thanh Phong</strong>.
  </footer>
  <script>
  document.getElementById("currentYear").textContent = new Date().getFullYear();
</script>
</body>
</html>
