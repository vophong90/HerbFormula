<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hỗ trợ lập phương YHCT</title>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js + annotation -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
  <script>Chart.register(window['chartjs-plugin-annotation']);</script>

  <!-- i18n strings -->
  <script src="js/lang/lang_vi.js"></script>
  <script src="js/lang/lang_zh.js"></script>

  <!-- Nạp động dữ liệu theo ngôn ngữ -->
  <script>
    // Cấu hình đường dẫn dữ liệu cho từng ngôn ngữ
    const DATA_FILES = {
      vi: [
        "./js/data/herbal_list.vi.js",
        "./js/data/doi_duoc_data.vi.js",
        "./js/data/strengherb.vi.js",
      ],
      zh: [
        "./js/data/herbal_list.zh.js",
        "./js/data/doi_duoc_data.zh.js",
        "./js/data/strengherb.zh.js",
      ],
    };

    // Ngôn ngữ đang dùng
    window.langCode = "vi";

    // Xoá biến dữ liệu toàn cục nếu có (tránh trộn khi đổi ngôn ngữ)
    function unloadDataGlobals() {
      try {
        delete window.herbalList;
        delete window.doiDuocData;
        delete window.strengHerb;
      } catch(e) {
        window.herbalList = null;
        window.doiDuocData = null;
        window.strengHerb = null;
      }
    }

    // Nạp tuần tự các file dữ liệu theo ngôn ngữ
    function loadDataForLang(lang) {
      if (!DATA_FILES[lang]) {
        console.warn("Thiếu cấu hình dữ liệu cho ngôn ngữ:", lang);
        return Promise.resolve();
      }
      // Gỡ các script dữ liệu cũ nếu có
      document.querySelectorAll('script[data-i18n-data="1"]').forEach(s => s.remove());
      unloadDataGlobals();

      // Chèn script theo thứ tự để đảm bảo phụ thuộc
      return DATA_FILES[lang].reduce((p, src) => {
        return p.then(() => new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.async = false;
          s.defer = false;
          s.dataset.i18nData = "1";
          s.onload = resolve;
          s.onerror = () => reject(new Error("Không tải được: " + src));
          document.head.appendChild(s);
        }));
      }, Promise.resolve()).then(() => {
        window.langCode = lang;
        // Thông báo cho app (main.js) biết dữ liệu đã sẵn sàng
        window.dispatchEvent(new CustomEvent("i18n-data-loaded", { detail: { lang } }));
      });
    }

    // Nạp dữ liệu ban đầu (VI) trước khi main.js chạy
    window._initialDataPromise = loadDataForLang(window.langCode);
  </script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

  <!-- Chọn ngôn ngữ -->
  <div class="fixed top-4 right-6 z-50">
    <select id="lang-select" class="border rounded px-2 py-1 shadow bg-white">
      <option value="vi">🇻🇳 Tiếng Việt</option>
      <option value="zh">🇨🇳 中文</option>
    </select>
  </div>

  <div class="flex-grow">
    <div class="max-w-5xl mx-auto px-4 py-6 w-full">
      <h1 id="main-app-title" class="text-3xl font-bold text-center mb-6">
        🧾 Ứng dụng hỗ trợ lập phương Y học cổ truyền
      </h1>

      <!-- Tabs điều hướng -->
      <div class="w-full flex justify-center px-4 py-4">
        <nav class="flex bg-white rounded-2xl shadow-inner border border-gray-200 overflow-x-auto" id="main-step-tabs">
          <button class="step-tab px-5 py-2 font-medium text-gray-600 hover:text-blue-700 hover:bg-blue-100 transition-all duration-200 focus:outline-none rounded-2xl"
            data-path="#/step0"><span class="mr-1">📂</span>B0: Hồ sơ</button>
          <button class="step-tab px-5 py-2 font-medium text-gray-600 hover:text-blue-700 hover:bg-blue-100 transition-all duration-200 focus:outline-none rounded-2xl"
            data-path="#/step1"><span class="mr-1">🩺</span>B1: Lâm sàng</button>
          <button class="step-tab px-5 py-2 font-medium text-gray-600 hover:text-blue-700 hover:bg-blue-100 transition-all duration-200 focus:outline-none rounded-2xl"
            data-path="#/step2"><span class="mr-1">📊</span>B2: Đánh giá</button>
          <button class="step-tab px-5 py-2 font-medium text-gray-600 hover:text-blue-700 hover:bg-blue-100 transition-all duration-200 focus:outline-none rounded-2xl"
            data-path="#/step3"><span class="mr-1">📖</span>B3: Biện chứng</button>
          <button class="step-tab px-5 py-2 font-medium text-gray-600 hover:text-blue-700 hover:bg-blue-100 transition-all duration-200 focus:outline-none rounded-2xl"
            data-path="#/step4"><span class="mr-1">💡</span>B4: Gợi ý toa</button>
          <button class="step-tab px-5 py-2 font-medium text-gray-600 hover:text-blue-700 hover:bg-blue-100 transition-all duration-200 focus:outline-none rounded-2xl"
            data-path="#/step5"><span class="mr-1">🛠️</span>B5: Hiệu chỉnh</button>
        </nav>
      </div>

      <!-- Nơi render nội dung từng bước -->
      <div id="app"></div>
    </div>
  </div>

  <!-- Khởi động app (nên await _initialDataPromise trong main.js trước khi render) -->
  <script type="module" src="./js/main.js"></script>

  <footer class="mt-16 border-t bg-gray-100 text-center text-sm text-gray-600 py-6 shadow-inner">
    👨‍💻 Thiết kế bởi <strong>Võ Thanh Phong</strong> với sự hỗ trợ của <strong>ChatGPT</strong>.<br>
    © <span id="currentYear"></span> Bản quyền thuộc về <strong>Võ Thanh Phong</strong>.
  </footer>

  <!-- Năm hiện tại -->
  <script>
    document.getElementById("currentYear").textContent = new Date().getFullYear();
  </script>

  <!-- Đổi ngôn ngữ cho tiêu đề app, tabs + nạp lại dữ liệu -->
  <script>
    function updateAppNavLang() {
      if (window.lang && window.lang.app_title)
        document.getElementById('main-app-title').textContent = window.lang.app_title;

      const stepTabs = document.querySelectorAll('.step-tab');
      if (window.lang && window.lang.step_tab && stepTabs.length === window.lang.step_tab.length) {
        stepTabs.forEach((btn, i) => {
          const icon = btn.querySelector('span')?.outerHTML || '';
          btn.innerHTML = icon + window.lang.step_tab[i];
        });
      }
    }

    // Lắng nghe chọn ngôn ngữ
    document.getElementById('lang-select').addEventListener('change', function() {
      const newLang = (this.value === 'zh') ? 'zh' : 'vi';
      window.lang = (newLang === 'zh') ? window.lang_zh : window.lang_vi;
      updateAppNavLang();

      // Nạp lại dữ liệu tương ứng ngôn ngữ rồi render lại
      loadDataForLang(newLang)
        .then(() => {
          // Nếu main.js có hàm re-render riêng, có thể gọi: window.app?.rerender?.();
          // Mặc định dùng hashchange để buộc render lại theo route hiện tại
          window.dispatchEvent(new Event("hashchange"));
        })
        .catch(err => {
          alert("Lỗi nạp dữ liệu cho ngôn ngữ mới: " + err.message);
          console.error(err);
        });
    });

    // Khởi tạo lần đầu (VI)
    window.lang = window.lang_vi;
    updateAppNavLang();
  </script>
</body>
</html>

