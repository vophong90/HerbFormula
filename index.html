<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ğŸ§  Há»— trá»£ láº­p phÆ°Æ¡ng YHCT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="herbal_list.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
  <script>Chart.register(window['chartjs-plugin-annotation']);</script>
  <script src="doi_duoc_data.js"></script>
  <script src="organ_effects.js"></script>
  <script src="strengherb.js"></script>
  <script src="treatment_terms.js"></script>

</head>
<body class="bg-gray-50 text-gray-800">

  <div class="max-w-5xl mx-auto px-4 py-6">
    <!-- TiÃªu Ä‘á» chÃ­nh -->
    <h1 class="text-3xl font-bold text-center mb-6">ğŸ§¾ á»¨ng dá»¥ng há»— trá»£ láº­p phÆ°Æ¡ng Y há»c cá»• truyá»n</h1>

    <!-- Thanh Ä‘iá»u hÆ°á»›ng bÆ°á»›c -->
    <div class="w-full max-w-none flex justify-center gap-2 px-4 py-4 whitespace-nowrap">
      <button class="step-tab" onclick="goToStep(0)">B0: Há»“ sÆ¡</button>
      <button class="step-tab" onclick="goToStep(1)">B1: LÃ¢m sÃ ng</button>
      <button class="step-tab" onclick="goToStep(2)">B2: ÄÃ¡nh giÃ¡</button>
      <button class="step-tab" onclick="goToStep(3)">B3: Biá»‡n chá»©ng</button>
      <button class="step-tab" onclick="goToStep(4)">B4: Gá»£i Ã½ toa</button>
      <button class="step-tab" onclick="goToStep(5)">B5: Hiá»‡u chá»‰nh</button>
    </div>


    <!-- CÃ¡c bÆ°á»›c (áº©n/hiá»‡n tá»«ng bÆ°á»›c báº±ng JS) -->
    
<!-- BÆ¯á»šC 0: Táº O Há»’ SÆ  -->
   
    <div id="step-0" class="step-section">
    <label>ğŸ“… NgÃ y giá» khÃ¡m:</label>
    <input type="datetime-local" id="visit-datetime" class="border p-1 rounded w-full mb-3">
    <h2 class="text-2xl font-semibold mb-4">ğŸ“ BÆ°á»›c 0: Quáº£n lÃ½ há»“ sÆ¡ bá»‡nh nhÃ¢n</h2>

  <!-- Má»Ÿ há»“ sÆ¡ tá»« file JSON -->
  <div class="mb-6">
  <label class="block text-sm font-medium mb-1">ğŸ“‚ Chá»n há»“ sÆ¡ tá»« file JSON:</label>
  <input type="file" id="json-file-input" accept=".json" class="block w-full text-sm text-gray-600">
  <button onclick="loadPatientFromFile()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
    ğŸ“¥ Má»Ÿ há»“ sÆ¡
  </button>
</div>

  <hr class="my-6">

  <!-- Táº¡o há»“ sÆ¡ má»›i -->
  <div class="mb-6">
    <label class="block text-sm font-medium mb-1">ğŸ†• Táº¡o há»“ sÆ¡ má»›i:</label>
    <input id="new-patient-name" type="text" placeholder="Nháº­p tÃªn bá»‡nh nhÃ¢n..." class="w-full border rounded px-3 py-2">
    <button onclick="createNewPatient()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
      â• Táº¡o há»“ sÆ¡
    </button>
  </div>

  <!-- Tiáº¿p tá»¥c -->
  <div class="mt-6">
    <button onclick="populateStep1Fields(); goToStep(1)" class="...">
  â¡ Tiáº¿p tá»¥c bÆ°á»›c 1
</button>
  </div>
</div>

<!-- BÆ¯á»šC 1: THÃ”NG TIN LÃ‚M SÃ€NG -->
<div id="step-1" class="step-section hidden">
  <h2 class="text-2xl font-semibold mb-4">ğŸ“‹ BÆ°á»›c 1: Nháº­p thÃ´ng tin lÃ¢m sÃ ng</h2>

  <!-- ThÃ´ng tin bá»‡nh nhÃ¢n -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div>
      <label class="font-medium">ğŸ‘¤ Há» tÃªn:</label>
      <input id="patient-name" type="text" disabled class="w-full border rounded px-3 py-2 bg-gray-100">
    </div>
    <div>
      <label class="font-medium">ğŸ‚ NÄƒm sinh:</label>
      <input id="patient-birth" type="number" placeholder="VD: 1985" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="font-medium">ğŸš» Giá»›i tÃ­nh:</label>
      <select id="patient-gender" class="w-full border rounded px-3 py-2">
        <option value="">-- Chá»n --</option>
        <option value="Nam">Nam</option>
        <option value="Ná»¯">Ná»¯</option>
        <option value="KhÃ¡c">KhÃ¡c</option>
      </select>
    </div>
  </div>

  <!-- Nháº­p triá»‡u chá»©ng -->
  <div class="mb-6">
    <label class="font-medium">ğŸ’¬ Triá»‡u chá»©ng lÃ¢m sÃ ng:</label>
    <textarea id="patient-symptoms" rows="6" placeholder="Nháº­p cÃ¡c triá»‡u chá»©ng thu tháº­p qua tá»© cháº©n. Má»—i triá»‡u chá»©ng trÃªn má»™t dÃ²ng, bao gá»“m tÃªn triá»‡u chá»©ng vÃ  cÃ¡c Ä‘áº·c Ä‘iá»ƒm cá»§a triá»‡u chá»©ng nhÆ° hoÃ n cáº£nh khá»Ÿi phÃ¡t, cÆ°á»ng Ä‘á»™, táº§n suáº¥t, thá»i gian, yáº¿u tá»‘ tÄƒng giáº£m..." class="w-full border rounded px-3 py-2"></textarea>
  </div>

  <!-- Äiá»u hÆ°á»›ng -->
  <div class="flex justify-between">
    <button onclick="goToStep(0)" class="bg-gray-500 text-white px-4 py-2 rounded">â¬… Quay láº¡i</button>
    <button onclick="saveStep1(); goToStep(2)" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Tiáº¿p tá»¥c â¡</button>
  </div>
</div>

<!-- BÆ¯á»šC 2: ÄÃNH GIÃ TRIá»†U CHá»¨NG -->

<div id="step-2" class="step-section hidden">
  <h2 class="text-2xl font-semibold mb-4">ğŸ“Š BÆ°á»›c 2: ÄÃ¡nh giÃ¡ má»©c Ä‘á»™ triá»‡u chá»©ng</h2>

  <!-- Pháº§n nháº­p triá»‡u chá»©ng cá»§a láº§n khÃ¡m hiá»‡n táº¡i -->
  <div class="mb-4 space-x-2">
    <button onclick="extractSymptoms()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      ğŸ§  TÃ¡ch triá»‡u chá»©ng tá»« bÆ°á»›c 1
    </button>
    <button onclick="rankSymptoms()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
      ğŸ”ƒ Ranking theo VAS
    </button>
  </div>

  <div id="symptom-vas-list" class="space-y-4"></div>

  <!-- Náº¿u cÃ³ dá»¯ liá»‡u tÃ¡i khÃ¡m trÆ°á»›c â†’ hiá»ƒn thá»‹ biá»ƒu Ä‘á»“ -->
<div id="followup-section" class="mt-8 hidden border-t pt-6">
  <h3 class="text-lg font-semibold mb-4">ğŸ“ˆ Biá»ƒu Ä‘á»“ tiáº¿n triá»ƒn VAS cÃ¡c láº§n khÃ¡m:</h3>
  <canvas id="followup-vas-chart" height="150"></canvas>
</div>

  <!-- Äiá»u hÆ°á»›ng -->
  <div class="mt-6 flex justify-between">
    <button onclick="goToStep(1)" class="bg-gray-500 text-white px-4 py-2 rounded">â¬… Quay láº¡i</button>
    <button onclick="saveStep2(); goToStep(3)" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
      Tiáº¿p â¡
    </button>
  </div>
</div>

<!-- BÆ¯á»šC 3: BIá»†N CHá»¨NG -->

<div id="step-3" class="step-section hidden">
  <h2 class="text-2xl font-semibold mb-4">ğŸ§  BÆ°á»›c 3: Biá»‡n chá»©ng Y há»c cá»• truyá»n</h2>

  <!-- ğŸ•˜ Lá»‹ch sá»­ há»™i chá»©ng Ä‘Ã£ cháº©n Ä‘oÃ¡n -->
  <div class="mb-6">
    <h3 class="text-lg font-semibold mb-2">ğŸ“œ Há»™i chá»©ng YHCT cÃ¡c láº§n khÃ¡m trÆ°á»›c:</h3>
    <ul id="past-syndrome-list" class="list-disc list-inside text-gray-700 text-sm"></ul>
  </div>

  <!-- ğŸ§ª PhÃ¢n tÃ­ch há»™i chá»©ng hiá»‡n táº¡i -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div>
      <label class="font-semibold block mb-1">ğŸ” Tiáº¿p cáº­n theo sÆ¡ Ä‘á»“:</label>
      <button onclick="autoGenerateDiagnosticTree()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
       ğŸ§  PhÃ¢n tÃ­ch sÆ¡ Ä‘á»“
      </button>
      <textarea id="syndrome-model" rows="3" class="w-full border rounded px-3 py-2" placeholder="VD: Tá»³ hÆ° tháº¥p thá»‹nh, Can khÃ­ uáº¥t káº¿t..."></textarea>
      <div id="tree-extra-questions" class="mt-4 space-y-3"></div>
    </div>

    <div>
      <label class="font-semibold block mb-1">ğŸ“š GPT gá»£i Ã½ theo triá»‡u chá»©ng:</label>
      <button onclick="autoSuggestClassicSyndrome()" class="bg-green-600 text-white px-4 py-2 rounded mt-2">
      âš™ï¸ PhÃ¢n tÃ­ch triá»‡u chá»©ng
      </button>
      <textarea id="syndrome-classic" rows="3" class="w-full border rounded px-3 py-2" placeholder="TrÃ­ch dáº«n tá»« sÃ¡ch hoáº·c kinh nghiá»‡m..."></textarea>
    </div>

    <div class="md:col-span-2">
      <label class="font-semibold block mb-1">ğŸ‘©â€âš•ï¸ Há»™i chá»©ng theo bÃ¡c sÄ© quyáº¿t Ä‘á»‹nh:</label>
      <input id="syndrome-final" type="text" class="w-full border rounded px-3 py-2" placeholder="VD: Tá»³ khÃ­ hÆ°, Tháº­n dÆ°Æ¡ng hÆ°...">
    </div>
  </div>

  <!-- Äiá»u hÆ°á»›ng -->
  <div class="flex justify-between">
    <button onclick="goToStep(2)" class="bg-gray-500 text-white px-4 py-2 rounded">â¬… Quay láº¡i</button>
    <button onclick="saveStep3(); goToStep(4)" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Tiáº¿p tá»¥c â¡</button>
  </div>
</div>

<!-- BÆ¯á»šC 4: Gá»¢I Ã Láº¬P PHÆ¯Æ NG -->

<div id="step-4" class="step-section hidden">
  <h2 class="text-2xl font-semibold mb-4">ğŸ§ª BÆ°á»›c 4: Gá»£i Ã½ bÃ i thuá»‘c theo mÃ´ hÃ¬nh 6S</h2>

  <!-- 1. Há»™i chá»©ng YHCT -->
  <div class="mb-6">
    <label class="font-semibold block mb-1">ğŸ“Œ Há»™i chá»©ng Y há»c cá»• truyá»n:</label>
    <div id="confirmed-syndrome" class="bg-gray-100 border px-4 py-2 rounded text-gray-800"></div>
  </div>

  <div class="mb-6">
    <label class="font-semibold block mb-1">ğŸ” CÃ¡c triá»‡u chá»©ng ná»•i báº­t (VAS cao):</label>
    <ul id="step4-top-symptom-list" class="list-disc list-inside text-gray-700"></ul>
  </div>
  <!-- 2. BÃ i thuá»‘c cá»• phÆ°Æ¡ng -->
  <div class="mb-6 border-t pt-6">
  <label class="font-semibold block mb-2">ğŸ¤– GPT gá»£i Ã½ bÃ i thuá»‘c cá»• phÆ°Æ¡ng:</label>
  <button onclick="autoSuggestClassicFormula()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mb-3">
    âš™ï¸ GPT gá»£i Ã½ cá»• phÆ°Æ¡ng
  </button>
  <textarea id="classic-formula-gpt" rows="6" class="w-full border rounded px-3 py-2 bg-gray-100 text-gray-800"
            placeholder="GPT sáº½ hiá»ƒn thá»‹ bÃ i thuá»‘c táº¡i Ä‘Ã¢y..." readonly></textarea>
</div>

<!-- 3. MÃ´ hÃ¬nh 6S -->
<div class="mb-6">
  <label class="font-semibold block mb-2">ğŸ”¬ MÃ´ hÃ¬nh 6S cá»§a bÃ i thuá»‘c:</label>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

    <!-- S1 -->
    <div>
      <label class="font-semibold flex items-center gap-2">
        S1 â€“ Source:
        <button onclick="suggestSourceHerbsByGPT()" class="bg-green-600 text-white px-2 py-1 rounded text-sm hover:bg-green-700">GPT Gá»£i Ã½</button>
      </label>
      <textarea id="sixs-source" rows="2" class="w-full border rounded px-3 py-2 mt-1"></textarea>
    </div>

    <!-- S2 -->
    <div>
      <label class="font-semibold flex items-center gap-2">
        S2 â€“ Symptom:
        <button onclick="suggestSymptomHerbsByGPT()" class="bg-green-600 text-white px-2 py-1 rounded text-sm hover:bg-green-700">GPT Gá»£i Ã½</button>
      </label>
      <textarea id="sixs-symptom" rows="2" class="w-full border rounded px-3 py-2 mt-1"></textarea>
    </div>

    <!-- S3 -->
    <div>
      <label class="font-semibold flex items-center gap-2">
        S3 â€“ Site:
        <button onclick="suggestSiteHerbsByGPT()" class="bg-green-600 text-white px-2 py-1 rounded text-sm hover:bg-green-700">GPT Gá»£i Ã½</button>
      </label>
      <textarea id="sixs-site" rows="2" class="w-full border rounded px-3 py-2 mt-1"></textarea>
    </div>

    <!-- S4 -->
    <div>
      <label class="font-semibold flex items-center gap-2">
        S4 â€“ Strength:
        <button onclick="suggestStrengthDoseByGPT()" class="bg-green-600 text-white px-2 py-1 rounded text-sm hover:bg-green-700">GPT Gá»£i Ã½</button>
      </label>
      <textarea id="sixs-strength" rows="2" class="w-full border rounded px-3 py-2 mt-1"></textarea>
    </div>

    <!-- S5 -->
    <div>
      <label class="font-semibold flex items-center gap-2">
        S5 â€“ Side-effect:
        <button onclick="suggestSideEffectModifiers()" class="bg-green-600 text-white px-2 py-1 rounded text-sm hover:bg-green-700">GPT Gá»£i Ã½</button>
      </label>
      <textarea id="sixs-sideeffect" rows="2" class="w-full border rounded px-3 py-2 mt-1"></textarea>
    </div>

    <!-- S6 -->
    <div>
      <label class="font-semibold flex items-center gap-2">
        S6 â€“ Secondary Prevention:
        <button onclick="suggestSecondaryPrevention()" class="bg-green-600 text-white px-2 py-1 rounded text-sm hover:bg-green-700">GPT Gá»£i Ã½</button>
      </label>
      <textarea id="sixs-secondary" rows="2" class="w-full border rounded px-3 py-2 mt-1"></textarea>
    </div>

  </div>
</div>

<!-- 4. Toa tá»•ng há»£p -->
<div class="mb-6 border-t pt-6 mt-6">
  <h3 class="text-lg font-semibold mb-2">ğŸ§¾ Toa thuá»‘c tá»•ng há»£p</h3>

  <div class="mb-4">
    <button onclick="renderFinalGPTFormula()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mb-2">
    ğŸ¤– GPT Ä‘á» xuáº¥t</button>
    <textarea id="final-gpt-formula" rows="3" class="w-full border rounded px-3 py-2 bg-gray-100 text-gray-800"
              readonly placeholder="Toa thuá»‘c tá»•ng há»£p tá»« mÃ´ hÃ¬nh GPT..."></textarea>
  </div>

  <div class="mb-4">
    <label class="font-semibold block mb-1">ğŸ‘¨â€âš•ï¸ BÃ¡c sÄ© chá»‰nh sá»­a:</label>
    <textarea id="final-doctor-formula" rows="3" class="w-full border rounded px-3 py-2"
              placeholder="BÃ¡c sÄ© hiá»‡u chá»‰nh láº¡i toa thuá»‘c cuá»‘i cÃ¹ng..."></textarea>
  </div>
</div>

  <!-- Äiá»u hÆ°á»›ng -->
  <div class="flex justify-between">
    <button onclick="goToStep(3)" class="bg-gray-500 text-white px-4 py-2 rounded">â¬… Quay láº¡i</button>
    <button onclick="saveStep4(); goToStep(5)" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Tiáº¿p tá»¥c â¡</button>
  </div>
</div>

<!-- BÆ¯á»šC 5: HIá»†U CHá»ˆNH TOA -->
<div id="step-5" class="step-section hidden">
  <h2 class="text-2xl font-semibold mb-4">ğŸ”§ BÆ°á»›c 5: Hiá»‡u chá»‰nh toa thuá»‘c</h2>

  <!-- Lá»ŠCH Sá»¬ TOA CÅ¨ -->
  <div class="mb-6">
  <h3 class="text-lg font-semibold mb-2">ğŸ“œ Lá»‹ch sá»­ toa thuá»‘c</h3>
  <div id="previous-formulas" class="space-y-4"></div>
  </div>
  <hr class="my-6">

  <!-- HIá»†U CHá»ˆNH TOA HIá»†N Táº I -->
  <div class="mb-6">
    <h3 class="text-lg font-semibold mb-2">âœï¸ Hiá»‡u chá»‰nh toa thuá»‘c láº§n nÃ y:</h3>

    <div class="mb-4">
      <label class="font-semibold block mb-1">ğŸ“‹ Toa bÃ¡c sÄ© Ä‘á» xuáº¥t (tá»« bÆ°á»›c 4):</label>
      <textarea id="step5-doctor-draft" class="w-full border rounded px-3 py-2 bg-gray-100" rows="3" readonly></textarea>
    </div>

    <div class="mb-6">
    <h3 class="text-lg font-semibold mb-2">ğŸ’Š Toa thuá»‘c cuá»‘i cÃ¹ng</h3>

    <!-- Danh sÃ¡ch vá»‹ thuá»‘c -->
    <div id="final-herb-list" class="space-y-2 mb-2" data-herbs="[]"></div>

    <!-- Nháº­p thÃªm vá»‹ thuá»‘c -->
    <div class="flex gap-2 mb-4">
    <input type="text" id="final-new-herb" placeholder="TÃªn vá»‹ thuá»‘c"
           class="flex-1 border rounded px-3 py-2">
    <input type="text" id="final-new-dose" placeholder="Liá»u"
           class="w-24 border rounded px-3 py-2">
    <button onclick="addFinalHerb()" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
      â• ThÃªm
    </button>
    </div>
    </div>

    <div class="mb-4">
      <label class="font-semibold block mb-1">ğŸ’Š CÃ¡ch dÃ¹ng:</label>
      <textarea id="step5-usage" class="w-full border rounded px-3 py-2" rows="2"
                placeholder="Sáº¯c 1 thang/ngÃ y, chia 2 láº§n sau Äƒn..."></textarea>
    </div>

    <div class="mb-4">
      <button onclick="autoFillStep5Note()" class="text-blue-700 hover:underline mt-2">
  ğŸ“ Ghi chÃº thÃªm
      </button>
      <textarea id="step5-note" class="w-full border rounded px-3 py-2" rows="2"
                placeholder="Ghi chÃº vá» hiá»‡u chá»‰nh: tÄƒng liá»u X, giáº£m liá»u Y..."></textarea>
    </div>
  </div>

<!-- PHÃ‚N TÃCH TOA THUá»C -->
<div id="formula-analysis-charts" class="mt-6 space-y-6">

 <!-- 1. Tá»© khÃ­ -->
<div class="my-4">
  <button id="btn-render-tukhi" class="text-left text-lg font-semibold text-blue-700 hover:text-blue-900 hover:underline">
    1ï¸âƒ£ PhÃ¢n tÃ­ch Tá»© khÃ­
  </button>
  <canvas id="chart-temperature" width="1000" height="80" class="mt-2 border rounded shadow"></canvas>
</div>

  <!-- 2-3. NgÅ© vá»‹ vÃ  Quy kinh trÃªn cÃ¹ng má»™t hÃ ng -->
<div class="my-4 grid grid-cols-2 gap-4">
  <!-- 2. NgÅ© vá»‹ -->
  <div>
    <button id="btn-render-flavor" class="text-blue-700 hover:underline text-lg font-semibold mb-2">
      ğŸ“Š PhÃ¢n tÃ­ch NgÅ© vá»‹
    </button>
    <canvas id="chart-flavor" class="border rounded shadow" style="width: 100%; height: 300px;"></canvas>
  </div>

  <!-- 3. Quy kinh -->
  <div>
    <button id="btn-render-meridian" class="text-blue-700 hover:underline text-lg font-semibold mb-2">
      ğŸ“ˆ PhÃ¢n tÃ­ch Quy kinh
    </button>
    <canvas id="chart-meridian" class="border rounded shadow" style="width: 100%; height: 300px;"></canvas>
  </div>
</div>

<!-- 4. ThÄƒng â€“ GiÃ¡ng â€“ PhÃ¹ â€“ Tráº§m -->
<div class="my-4">
  <button id="btn-render-direction" class="text-blue-700 hover:underline text-lg font-semibold mb-2">
    ğŸ§­ PhÃ¢n tÃ­ch ThÄƒng â€“ GiÃ¡ng â€“ PhÃ¹ â€“ Tráº§m
  </button>
  <canvas id="chart-direction" width="500" height="500" class="border rounded shadow mt-4"></canvas>
</div>

  <div class="flex justify-between">
    <button onclick="goToStep(4)" class="bg-gray-500 text-white px-4 py-2 rounded">â¬… Quay láº¡i</button>
    <button onclick="saveStep5(); downloadCurrentDataAsJSON()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">ğŸ’¾ LÆ°u há»“ sÆ¡</button>
  </div>
</div>


<script>

function goToStep(n) {
  // 1. áº¨n táº¥t cáº£ cÃ¡c bÆ°á»›c
  document.querySelectorAll(".step-section").forEach(div => div.classList.add("hidden"));

  // 2. Hiá»‡n bÆ°á»›c Ä‘Æ°á»£c chá»n
  const step = document.getElementById(`step-${n}`);
  if (step) step.classList.remove("hidden");

  // 3. ÄÃ¡nh dáº¥u tab Ä‘ang chá»n
  document.querySelectorAll(".step-tab").forEach((btn, index) => {
    if (index === n) {
      btn.classList.add("active");
    } else {
      btn.classList.remove("active");
    }
  });

  // 4. Náº¿u bÆ°á»›c cÃ³ hÃ m render riÃªng thÃ¬ gá»i
  if (n === 2 && typeof renderStep2 === "function") renderStep2();
  if (n === 3 && typeof populateStep3 === "function") populateStep3();
  if (n === 4 && typeof populateStep4 === "function") populateStep4();
  if (n === 5 && typeof populateStep5 === "function") populateStep5();
}


//HÃ m cho BÆ°á»›c 0

  function loadPatientFromFile() {
  const input = document.getElementById("json-file-input");
  if (!input.files || input.files.length === 0) return alert("Vui lÃ²ng chá»n má»™t file JSON!");

  const file = input.files[0];
  const reader = new FileReader();

  reader.onload = function (e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.name) return alert("âš ï¸ File khÃ´ng há»£p lá»‡: thiáº¿u tÃªn bá»‡nh nhÃ¢n");

      const key = "patient_" + data.name;
      localStorage.setItem(key, JSON.stringify(data));
      localStorage.setItem("currentPatient", key);
      localStorage.setItem("currentData", JSON.stringify(data));

      alert("âœ… ÄÃ£ táº£i há»“ sÆ¡ tá»« file: " + data.name);
      populateStep1Fields();
      goToStep(1);
    } catch (err) {
      alert("âŒ Lá»—i khi Ä‘á»c file JSON: " + err.message);
    }
  };

  reader.readAsText(file);
}

  function createNewPatient() {
     const name = document.getElementById("new-patient-name").value.trim();
     if (!name) return alert("Vui lÃ²ng nháº­p tÃªn!");

     const key = "patient_" + name;
     if (localStorage.getItem(key)) {
     if (!confirm("Há»“ sÆ¡ Ä‘Ã£ tá»“n táº¡i. Ghi Ä‘Ã¨?")) return;
     }

   const data = {
      name: name,
      created: new Date().toISOString(),
     steps: {}
    };

    localStorage.setItem(key, JSON.stringify(data));
    localStorage.setItem("currentPatient", key);
    localStorage.setItem("currentData", JSON.stringify(data));
    alert("âœ… ÄÃ£ táº¡o há»“ sÆ¡ má»›i: " + name);
  }

// HÃ m cho bÆ°á»›c 1

function loadPatientRecord() {
  const key = document.getElementById("patient-file-select").value;
  if (!key) return alert("Vui lÃ²ng chá»n há»“ sÆ¡!");

  const data = JSON.parse(localStorage.getItem(key) || "{}");
  localStorage.setItem("currentPatient", key);
  localStorage.setItem("currentData", JSON.stringify(data));
  alert("âœ… ÄÃ£ táº£i há»“ sÆ¡: " + key.replace("patient_", ""));

  // ğŸ©º GÃ¡n thÃ´ng tin vÃ o BÆ°á»›c 1 náº¿u cÃ³
  document.getElementById("patient-name").value = data.name || "";
  document.getElementById("patient-birth").value = data.birth || "";
  document.getElementById("patient-gender").value = data.gender || "";
  document.getElementById("patient-symptoms").value = data.steps?.step1?.symptoms || "";
}

function saveStep1() {
  const name = document.getElementById("patient-name").value;
  const birth = document.getElementById("patient-birth").value;
  const gender = document.getElementById("patient-gender").value;
  const symptoms = document.getElementById("patient-symptoms").value.trim();

  const key = localStorage.getItem("currentPatient");
  if (!key) return alert("ChÆ°a chá»n há»“ sÆ¡!");

  const data = JSON.parse(localStorage.getItem(key) || "{}");
  data.birth = birth;
  data.gender = gender;
  data.steps = data.steps || {};
  data.steps.step1 = { birth, gender, symptoms };

  localStorage.setItem(key, JSON.stringify(data));
  localStorage.setItem("currentData", JSON.stringify(data));
}

function populateStep1Fields() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  document.getElementById("patient-name").value = data.name || "";
  document.getElementById("patient-birth").value = data.birth || "";
  document.getElementById("patient-gender").value = data.gender || "";
  document.getElementById("patient-symptoms").value = data.steps?.step1?.symptoms || "";
}


//HÃ m cho bÆ°á»›c 2

async function extractSymptoms() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const raw = data?.steps?.step1?.symptoms || "";

  if (!raw.trim()) {
    alert("âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u triá»‡u chá»©ng Ä‘á»ƒ phÃ¢n tÃ­ch.");
    return;
  }

  const prompt = `
Báº¡n lÃ  bÃ¡c sÄ© Y há»c cá»• truyá»n. DÆ°á»›i Ä‘Ã¢y lÃ  Ä‘oáº¡n mÃ´ táº£ triá»‡u chá»©ng vÃ  káº¿t quáº£ há»i bá»‡nh cá»§a bá»‡nh nhÃ¢n:

"${raw}"

HÃ£y tÃ¡ch ra danh sÃ¡ch cÃ¡c triá»‡u chá»©ng cá»¥ thá»ƒ, má»—i dÃ²ng ghi 1 triá»‡u chá»©ng ngáº¯n gá»n vÃ  dá»… hiá»ƒu (khÃ´ng láº·p tá»«). LÆ°u Ã½ chá»‰ láº¥y triá»‡u chá»©ng, khÃ´ng láº¥y cÃ¡c Ä‘áº·c Ä‘iá»ƒm cá»§a triá»‡u chá»©ng Ä‘Ã³. KhÃ´ng cáº§n phÃ¢n tÃ­ch, chá»‰ liá»‡t kÃª nhÆ° sau:
1. [triá»‡u chá»©ng 1]
2. [triá»‡u chá»©ng 2]
...`;

  const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({ prompt: prompt })
});

  const result = await res.json();
  const reply = result.choices?.[0]?.message?.content || "";
  const lines = reply
    .split("\n")
    .map(line => line.replace(/^\d+\.\s*/, "").trim())
    .filter(line => line.length > 0);

  if (!lines.length) {
    alert("âŒ GPT khÃ´ng trÃ­ch xuáº¥t Ä‘Æ°á»£c triá»‡u chá»©ng.");
    return;
  }

  const container = document.getElementById("symptom-vas-list");
  container.innerHTML = "";
  lines.forEach(symptom => container.appendChild(createSymptomVASBlock(symptom)));
}

function updateSortedVAS() {
  const container = document.getElementById("symptom-vas-list");
  const items = Array.from(container.children);

  items.forEach(div => {
    const slider = div.querySelector("input[type=range]");
    slider.outputDiv.textContent = "VAS: " + slider.value;
  });

  // Sáº¯p xáº¿p láº¡i theo VAS giáº£m dáº§n
  items.sort((a, b) => {
    const va = parseInt(a.querySelector("input").value);
    const vb = parseInt(b.querySelector("input").value);
    return vb - va;
  });

  container.innerHTML = "";
  items.forEach(div => container.appendChild(div));
}

function createSymptomVASBlock(symptom, vas = 5) {
  const div = document.createElement("div");
  div.className = "bg-gray-100 p-3 rounded shadow relative symptom-item";

  const label = document.createElement("label");
  label.className = "block font-semibold mb-2";
  label.textContent = `ğŸ”¹ ${symptom}`;
  div.appendChild(label);

  // Thanh trÆ°á»£t
  const slider = document.createElement("input");
  slider.type = "range";
  slider.min = 0;
  slider.max = 10;
  slider.step = 0.1;
  slider.value = vas;
  slider.className = "w-full mb-1";
  slider.dataset.symptom = symptom;
  div.appendChild(slider);

  // Ã” nháº­p sá»‘
  const input = document.createElement("input");
  input.type = "number";
  input.min = 0;
  input.max = 10;
  input.step = 0.1;
  input.value = vas;
  input.className = "border border-gray-300 rounded w-20 p-1 text-right text-sm float-right";
  div.appendChild(input);

  // Text hiá»ƒn thá»‹
  const output = document.createElement("span");
  output.className = "text-sm text-gray-700 font-mono";
  output.textContent = "VAS: " + vas;
  div.appendChild(output);

  // Äá»“ng bá»™ slider <-> input
slider.oninput = () => {
  input.value = slider.value;
  output.textContent = "VAS: " + parseFloat(slider.value).toFixed(1);
  triggerLiveVAS(); // ğŸ” gá»i láº¡i biá»ƒu Ä‘á»“
};

input.oninput = () => {
  const val = Math.max(0, Math.min(10, parseFloat(input.value) || 0));
  slider.value = val;
  output.textContent = "VAS: " + val.toFixed(1);
  triggerLiveVAS(); // ğŸ” gá»i láº¡i biá»ƒu Ä‘á»“
};

  // NÃºt xÃ³a
  const btn = document.createElement("button");
  btn.textContent = "ğŸ—‘ï¸";
  btn.className = "absolute top-2 right-2 text-red-600 hover:text-red-800 text-lg";
  btn.onclick = () => div.remove();
  div.appendChild(btn);

  return div;
}

function rankSymptoms() {
  const container = document.getElementById("symptom-vas-list");
  const items = Array.from(container.querySelectorAll(".symptom-item"));

  items.sort((a, b) => {
    const va = parseFloat(a.querySelector("input[type=range]").value);
    const vb = parseFloat(b.querySelector("input[type=range]").value);
    return vb - va;
  });

  container.innerHTML = "";
  items.forEach(el => container.appendChild(el));
}

function renderStep2() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");

  // ğŸ” Gá»™p táº¥t cáº£ triá»‡u chá»©ng trong lá»‹ch sá»­ vÃ  triá»‡u chá»©ng má»›i
  const history = data.steps?.step2?.history || [];
  const allSymptoms = new Set();

  history.forEach(entry => entry.symptoms?.forEach(s => allSymptoms.add(s.symptom)));
  const newSymptoms = (data.steps?.step1?.symptoms || "").split("\n").map(s => s.trim()).filter(Boolean);
  newSymptoms.forEach(s => allSymptoms.add(s));

  const currentVAS = {};
  // Náº¿u cÃ³ symptoms hiá»‡n táº¡i â†’ láº¥y láº¡i VAS cÅ©
  (data.steps?.step2?.symptoms || []).forEach(s => {
    currentVAS[s.symptom] = s.vas;
  });

  // Render
  const container = document.getElementById("symptom-vas-list");
  container.innerHTML = "";
  Array.from(allSymptoms).forEach(symptom => {
    const vas = currentVAS[symptom] ?? 5;
    container.appendChild(createSymptomVASBlock(symptom, vas));
  });

  // Hiá»‡n biá»ƒu Ä‘á»“ náº¿u cÃ³ history
  if (history.length > 0) {
    document.getElementById("followup-section").classList.remove("hidden");
    renderVASChart(); // giá»¯ nguyÃªn
  } else {
    document.getElementById("followup-section").classList.add("hidden");
  }
}

let followupChart = null;

function renderVASChart() {
  const ctx = document.getElementById("followup-vas-chart").getContext("2d");
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");

  const history = data.steps?.step6?.followupHistory || data.steps?.step2?.history || [];
  const temp = data.steps?.step6?.followupSymptoms || [];
  const initial = data.steps?.step2?.symptoms || [];

  // âœ… Tá»•ng há»£p táº¥t cáº£ triá»‡u chá»©ng tá»«ng xuáº¥t hiá»‡n
  const symptomSet = new Set();

  initial.forEach(s => symptomSet.add(s.symptom));
  history.forEach(entry => entry.symptoms.forEach(s => symptomSet.add(s.symptom)));
  temp.forEach(s => symptomSet.add(s.symptom));  // â— Bá»• sung dÃ²ng nÃ y Ä‘á»ƒ nháº­n biáº¿t triá»‡u chá»©ng má»›i thÃªm

  const allSymptoms = Array.from(symptomSet);

  // âœ… GÃ¡n nhÃ£n trá»¥c X
  const labels = ["VAS 0", ...history.map((_, i) => `VAS ${i + 1}`)];
  if (temp.length > 0) labels.push(`VAS ${history.length + 1}`);

  // âœ… XÃ¢y dá»±ng dá»¯ liá»‡u theo tá»«ng triá»‡u chá»©ng
  const datasets = allSymptoms.map(symptom => {
    const dataPoints = [];

    // Láº§n 0: ban Ä‘áº§u
    const s0 = initial.find(s => s.symptom === symptom);
    dataPoints.push(s0 ? s0.vas : null);

    // CÃ¡c láº§n tÃ¡i khÃ¡m cÅ©
    history.forEach(entry => {
      const match = entry.symptoms.find(s => s.symptom === symptom);
      dataPoints.push(match ? match.vas : null);
    });

    // Láº§n hiá»‡n táº¡i (Ä‘ang theo dÃµi)
    if (temp.length > 0) {
      const match = temp.find(s => s.symptom === symptom);
      dataPoints.push(match ? match.vas : null);
    }

    return {
      label: symptom,
      data: dataPoints,
      fill: false,
      tension: 0.3,
      borderWidth: 2
    };
  });

  // âœ… XÃ³a biá»ƒu Ä‘á»“ cÅ© náº¿u cÃ³
  if (followupChart) followupChart.destroy();

  // âœ… Váº½ biá»ƒu Ä‘á»“ má»›i
  followupChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: "bottom"
        },
        tooltip: {
          mode: "index",
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 10,
          title: {
            display: true,
            text: "VAS"
          }
        }
      }
    }
  });
}

function triggerLiveVAS() {
  const blocks = document.querySelectorAll(".symptom-item");
  const currentSymptoms = Array.from(blocks).map(block => {
    const symptom = block.querySelector("input[type=range]").dataset.symptom;
    const vas = parseFloat(block.querySelector("input[type=range]").value);
    return { symptom, vas };
  });

  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  data.steps = data.steps || {};
  data.steps.step6 = data.steps.step6 || {};
  data.steps.step6.followupSymptoms = currentSymptoms;

  localStorage.setItem("currentData", JSON.stringify(data));
  renderVASChart();
}

function saveStep2() {
  const key = localStorage.getItem("currentPatient");
  if (!key) return alert("ChÆ°a chá»n há»“ sÆ¡!");

  const data = JSON.parse(localStorage.getItem(key) || "{}");
  data.steps = data.steps || {};
  data.steps.step2 = data.steps.step2 || {};

  // LÆ°u VAS hiá»‡n táº¡i táº¡m thá»i (chÆ°a lÆ°u vÃ o history)
  const blocks = document.querySelectorAll(".symptom-item");
  const symptoms = Array.from(blocks).map(block => {
    const symptom = block.querySelector("input[type=range]").dataset.symptom;
    const vas = parseFloat(block.querySelector("input[type=range]").value);
    return { symptom, vas };
  });

  data.steps.step2.symptoms = symptoms;

  // Äá»ƒ biá»ƒu Ä‘á»“ váº½ Ä‘Ãºng láº§n Ä‘ang theo dÃµi
  data.steps.step6 = data.steps.step6 || {};
  data.steps.step6.followupSymptoms = symptoms;

  localStorage.setItem(key, JSON.stringify(data));
  localStorage.setItem("currentData", JSON.stringify(data));
}

//HÃ m cho bÆ°á»›c 3

function populateStep3() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const history = data.steps?.step2?.history || [];

  // Hiá»ƒn thá»‹ danh sÃ¡ch há»™i chá»©ng cÃ¡c láº§n khÃ¡m trÆ°á»›c
  const ul = document.getElementById("past-syndrome-list");
  ul.innerHTML = "";

  history.forEach((entry, index) => {
    const label = entry?.syndrome?.final || entry?.syndrome?.model || "(ChÆ°a ghi)";
    const li = document.createElement("li");
    li.textContent = `Láº§n ${index + 1} â€“ ${label}`;
    ul.appendChild(li);
  });

  // Hiá»ƒn thá»‹ láº¡i ná»™i dung cá»§a láº§n hiá»‡n táº¡i náº¿u cÃ³
  const current = data.steps?.step3 || {};
  document.getElementById("syndrome-model").value = current.model || "";
  document.getElementById("syndrome-classic").value = current.classic || "";
  document.getElementById("syndrome-final").value = current.final || "";
}

function renderStep3() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const current = data.steps?.step3 || {};

  // âœ… Náº¿u chÆ°a cÃ³ step3, nhÆ°ng step2.history cÃ³ há»™i chá»©ng â†’ gÃ¡n láº¡i
  if (!current.final) {
    const lastEntry = data.steps?.step2?.history?.at(-1);
    if (lastEntry?.syndrome?.final || lastEntry?.syndrome?.model) {
      current.model = lastEntry.syndrome.model || "";
      current.classic = lastEntry.syndrome.classic || "";
      current.final = lastEntry.syndrome.final || "";
    }
  }

  // Äá»• dá»¯ liá»‡u lÃªn giao diá»‡n
  document.getElementById("syndrome-model").value = current.model || "";
  document.getElementById("syndrome-classic").value = current.classic || "";
  document.getElementById("syndrome-final").value = current.final || "";

  // Äá»“ng thá»i hiá»ƒn thá»‹ lá»‹ch sá»­ há»™i chá»©ng trÆ°á»›c Ä‘Ã³
  populateStep3();
}


function saveStep3() {
  const model = document.getElementById("syndrome-model").value.trim();
  const classic = document.getElementById("syndrome-classic").value.trim();
  const final = document.getElementById("syndrome-final").value.trim();

  const key = localStorage.getItem("currentPatient");
  if (!key) return alert("ChÆ°a chá»n há»“ sÆ¡!");

  const data = JSON.parse(localStorage.getItem(key) || "{}");

  // âœ… Chá»‰ lÆ°u vÃ o step3, khÃ´ng Ä‘á»¥ng tá»›i history
  data.steps = data.steps || {};
  data.steps.step3 = { model, classic, final };

  localStorage.setItem(key, JSON.stringify(data));
  localStorage.setItem("currentData", JSON.stringify(data));
}

async function autoSuggestClassicSyndrome() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const raw = data.steps?.step1?.symptoms || "";
  const vietSymptoms = raw.split("\n").map(s => s.trim()).filter(s => s);
  const outputBoxClassic = document.getElementById("syndrome-classic");

  if (!vietSymptoms.length) {
    alert("âš ï¸ ChÆ°a cÃ³ triá»‡u chá»©ng Ä‘á»ƒ phÃ¢n tÃ­ch.");
    return;
  }
  if (outputBoxClassic) outputBoxClassic.value = "â³ Äang xá»­ lÃ½, vui lÃ²ng chá»...";

  const prompt = `
Báº¡n lÃ  má»™t bÃ¡c sÄ© Y há»c cá»• truyá»n. Dá»±a vÃ o cÃ¡c triá»‡u chá»©ng sau:

${vietSymptoms.map((s, i) => `${i + 1}. ${s}`).join("\n")}

HÃ£y liá»‡t kÃª tá»‘i Ä‘a 5 há»™i chá»©ng Y há»c cá»• truyá»n phÃ¹ há»£p nháº¥t, theo thá»© tá»± Æ°u tiÃªn, kÃ¨m mÃ´ táº£ ngáº¯n cho tá»«ng há»™i chá»©ng táº¡i sao phÃ¹ há»£p vá»›i triá»‡u chá»©ng trÃªn. ChÃº Ã½ dÃ¹ng thuáº­t ngá»¯ chuyÃªn ngÃ nh Trung y, Æ°u tiÃªn giá»¯ cÃ¡c thuáº­t ngá»¯ HÃ¡n Viá»‡t. Chá»‰ tráº£ lá»i theo Ä‘á»‹nh dáº¡ng:

1. [TÃªn há»™i chá»©ng] â€“ [Giáº£i thÃ­ch ngáº¯n]
2. ...
  `;

  const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({ prompt: prompt })
});

  const result = await res.json();
  const reply = result.choices?.[0]?.message?.content || "âŒ GPT khÃ´ng tráº£ vá» káº¿t quáº£.";

  document.getElementById("syndrome-classic").value = reply;
  alert("âœ… ÄÃ£ gá»£i Ã½ há»™i chá»©ng theo kinh Ä‘iá»ƒn.");
}

async function autoGenerateDiagnosticTree() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const symptoms = data.steps?.step2?.symptoms || [];
  const rawSymptoms = data.steps?.step1?.symptoms || "";
  const outputBoxModel = document.getElementById("syndrome-model");

  if (!symptoms.length) {
    alert("âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u VAS tá»« bÆ°á»›c 2.");
    return;
  }
  if (outputBoxModel) outputBoxModel.value = "â³ Äang phÃ¢n tÃ­ch, vui lÃ²ng chá»...";

  // 1. Láº¥y danh sÃ¡ch triá»‡u chá»©ng + VAS, sáº¯p xáº¿p giáº£m dáº§n
  const sorted = [...symptoms].sort((a, b) => b.vas - a.vas);
  const symptomList = sorted.map(s => `â€“ ${s.symptom} (VAS: ${s.vas})`).join("\n");

  // 2. Thu tháº­p thÃ´ng tin bá»• sung náº¿u cÃ³
  const extraAnswers = collectExtraAnswers();
  let extraText = "";

  if (extraAnswers.length > 0) {
    extraText = "\n\nğŸ”¶ **THÃ”NG TIN Bá»” SUNG Tá»ª NGÆ¯á»œI DÃ™NG:**\n" +
                extraAnswers.map(e => `â–« ${e.question}: ${e.answer}`).join("\n");
  }

  // 3. Prompt chÃ­nh
  const basePrompt = `Báº¡n lÃ  má»™t bÃ¡c sÄ© Y há»c cá»• truyá»n cÃ³ kinh nghiá»‡m cháº©n Ä‘oÃ¡n bá»‡nh theo biá»‡n chá»©ng luáº­n trá»‹.  
TÃ´i sáº½ cung cáº¥p danh sÃ¡ch cÃ¡c triá»‡u chá»©ng vÃ  Ä‘iá»ƒm VAS (má»©c Ä‘á»™ náº·ng nháº¹).  
HÃ£y lÃ m theo cÃ¡c bÆ°á»›c sau Ä‘á»ƒ xÃ¢y dá»±ng sÆ¡ Ä‘á»“ biá»‡n chá»©ng 6 bÆ°á»›c cho há»™i chá»©ng YHCT:

ğŸ”¶ **BÆ¯á»šC 1: XÃ¡c Ä‘á»‹nh chá»§ chá»©ng**  
â€“ HÃ£y láº¥y triá»‡u chá»©ng cÃ³ VAS cao nháº¥t lÃ m chá»§ chá»©ng.  
â€“ Cho biáº¿t chá»§ chá»©ng Ä‘Ã³ lÃ  cáº¥p, máº¡n, hay cáº¥p trÃªn ná»n máº¡n?  
â€“ Náº¿u thiáº¿u thÃ´ng tin, hÃ£y há»i rÃµ:  
  â–« Chá»§ chá»©ng xuáº¥t hiá»‡n gáº§n Ä‘Ã¢y hay Ä‘Ã£ lÃ¢u?  
  â–« TrÆ°á»›c Ä‘Ã¢y Ä‘Ã£ tá»«ng cÃ³ triá»‡u chá»©ng nÃ y chÆ°a?  

ğŸ”¶ **BÆ¯á»šC 2: PhÃ¢n biá»‡t HÆ° â€“ Thá»±c cá»§a chá»§ chá»©ng**  
â€“ Dá»±a trÃªn:  
  â–« HoÃ n cáº£nh khá»Ÿi phÃ¡t: Ä‘á»™t ngá»™t (thá»±c), tá»« tá»« (hÆ°)  
  â–« Má»©c Ä‘á»™: dá»¯ dá»™i (thá»±c), Ã¢m á»‰ (hÆ°)  
  â–« Thá»i gian: vÃ i ngÃ y (thá»±c), nhiá»u tuáº§n/thÃ¡ng (hÆ°)  
  â–« Máº¡ch: há»“ng, trÆ°á»ng, kháº©n, hoáº¡t, sÃ¡p, Ä‘áº¡i, há»¯u lá»±c (thá»±c) / táº¿, vi, nhÆ°á»£c, vÃ´ lá»±c (hÆ°)  
  â–« LÆ°á»¡i: lÆ°á»¡i Ä‘á» tÆ°Æ¡i, lÆ°á»¡i tÃ­m, lÆ°á»¡i cháº¯c, lÆ°á»¡i thon, rÃªu dÃ y (thá»±c) / lÆ°á»¡i bá»‡u, lÆ°á»¡i cÃ³ dáº¥u áº¥n rÄƒng, lÆ°á»¡i nháº¡t, hÃ¬nh thá»ƒ teo, Ã­t rÃªu, rÃªu bong trÃ³c (hÆ°)  
â€“ Náº¿u cÃ²n thiáº¿u dá»¯ kiá»‡n, hÃ£y Ä‘áº·t tá»«ng cÃ¢u há»i cá»¥ thá»ƒ cho ngÆ°á»i dÃ¹ng.

ğŸ”¶ **BÆ¯á»šC 3: XÃ¡c Ä‘á»‹nh nhÃ³m bá»‡nh nguyÃªn**

**Náº¿u lÃ  THá»°C:**
â€“ **Lá»¥c dÃ¢m**: cÃ³ biá»ƒu hiá»‡n ngoáº¡i cáº£m nhÆ° sá»£ giÃ³, sá»£ láº¡nh, Ä‘au má»i thÃ¢n mÃ¬nh hoáº·c cÃ³ dáº¥u hiá»‡u Ä‘áº·c trÆ°ng phong, hÃ n, thá»­, tháº¥p, tÃ¡o, há»a  
â€“ **KhÃ­ uáº¥t**: triá»‡u chá»©ng tÄƒng khi uáº¥t á»©c, giáº£m khi thÆ° giÃ£n, náº¿u Ä‘au thÃ¬ Ä‘au kiá»ƒu cÄƒng trÆ°á»›ng tá»©c, náº¿u lÃ  hÃ²n khá»‘i thÃ¬ lÃºc cÃ³ lÃºc khÃ´ng  
â€“ **Huyáº¿t á»©**: Ä‘au cá»‘ Ä‘á»‹nh, tÄƒng vá» Ä‘Ãªm, lÆ°á»¡i tÃ­m, cÃ³ ban á»©, tÄ©nh máº¡ch dÆ°á»›i lÆ°á»¡i ná»•i, náº¿u cÃ³ xuáº¥t huyáº¿t thÃ¬ cÃ³ mÃ¡u cá»¥c báº§m Ä‘en, náº¿u sá» cÃ³ khá»‘i u thÃ¬ khá»‘i u Ä‘Ã³ cá»©ng cháº¯c  
â€“ **Há»a uáº¥t**: triá»‡u chá»©ng kÃ¨m nÃ³ng rÃ¡t, diá»…n tiáº¿n nhanh, dá»¯ dá»™i, vÃ¹ng tá»•n thÆ°Æ¡ng sáº½ cÃ³ mÃ u Ä‘á», sá» nÃ³ng, cÃ³ thá»ƒ cÃ³ lá»Ÿ loÃ©t, má»¥n nhá»t cÃ³ má»§  
â€“ **ÄÃ m tháº¥p**: triá»‡u chá»©ng náº·ng ná», bÃ i tiáº¿t ra cÃ¡ch cháº¥t tiáº¿t Ä‘á»¥c, dÆ¡, mÃ¹i tanh hÃ´i  

**Náº¿u lÃ  HÆ¯:**
â€“ **KhÃ­ hÆ°**: triá»‡u chá»©ng lÃºc cÃ³ lÃºc khÃ´ng, náº·ng lÃªn khi gáº¯ng sá»©c, biáº¿ng nÃ³i, lÆ°á»i váº­n Ä‘á»™ng, tay chÃ¢n khÃ´ng cÃ³ sá»©c, thá»Ÿ ngáº¯n, nÃ³i ngáº¯t quÃ£ng  
â€“ **Huyáº¿t hÆ°**: triá»‡u chá»©ng liÃªn tá»¥c, vÃ¹ng bá»‹ áº£nh hÆ°á»Ÿng cÃ³ biá»ƒu hiá»‡n thiáº¿u nuÃ´i dÆ°á»¡ng nhÆ° da niÃªm nhá»£t vÃ  khÃ´, lÃ´ng thÆ°a, cÆ¡ nhá»¥c teo, gÃ¢n co rÃºt co cá»©ng, khá»›p khÃ³ co duá»—i 
â€“ **Tinh báº¥t tÃºc**: ngÆ°á»i gáº§y, lÆ°ng gá»‘i má»i, giáº£m trÃ­ nhá»›, biá»ƒu hiá»‡n suy giáº£m cÃ´ng nÄƒng cuáº£ tá»§y, nÃ£o  

â†’ Dá»±a vÃ o dá»¯ kiá»‡n Ä‘Ã£ cÃ³, hÃ£y chá»n nhÃ³m phÃ¹ há»£p vÃ  giáº£i thÃ­ch lÃ½ do. Náº¿u thiáº¿u, há»i cá»¥ thá»ƒ.

ğŸ”¶ **BÆ¯á»šC 4: XÃ¡c Ä‘á»‹nh táº¡ng phá»§ hoáº·c kinh láº¡c liÃªn quan**  
â€“ Dá»±a vÃ o triá»‡u chá»©ng cÃ²n láº¡i Ä‘á»ƒ gá»£i Ã½ táº¡ng phá»§ hoáº·c Ä‘Æ°á»ng kinh Ä‘ang bá»‹ tá»•n thÆ°Æ¡ng.

ğŸ”¶ **BÆ¯á»šC 5: Xem xÃ©t tÃ­nh há»£p lÃ½ vá» thá»© tá»± thá»i gian xuáº¥t hiá»‡n triá»‡u chá»©ng**  
â€“ Dá»±a vÃ o Ä‘áº·c Ä‘iá»ƒm vá» thá»i gian xuáº¥t hiá»‡n cÃ¡c triá»‡u chá»©ng trong mÃ´ táº£ kÃ¨m theo, hÃ£y xem xÃ©t Ä‘áº¿n tÃ­nh há»£p lÃ½ vá» máº·t thá»© tá»± xuáº¥t hiá»‡n cÃ¡c triá»‡u chá»©ng theo thá»i gian, Ä‘á»ƒ xem liá»‡u ráº±ng thá»© tá»± Ä‘Ã³ cÃ³ há»£p lÃ½ theo lÃ½ luáº­n y há»c cá»• truyá»n hay khÃ´ng. VÃ­ dá»¥: cÃ¡c triá»‡u chá»©ng cá»§a Can há»a thÆ°á»£ng viÃªm pháº£i xuáº¥t hiá»‡n sau triá»‡u chá»©ng cá»§a Can khÃ­ uáº¥t káº¿t, vÃ¬ Can khÃ­ uáº¥t káº¿t lÃ  nguyÃªn nhÃ¢n gÃ¢y ra Can há»a thÆ°á»£ng viÃªm.
â€“ Náº¿u cÃ²n thiáº¿u dá»¯ kiá»‡n, hÃ£y Ä‘áº·t tá»«ng cÃ¢u há»i cá»¥ thá»ƒ cho ngÆ°á»i dÃ¹ng lÃ  yÃªu cáº§u ngÆ°á»i dÃ¹ng sáº¯p xáº¿p thá»© tá»± triá»‡u chá»©ng mÃ  báº¡n cáº§n theo thá»i gian xuáº¥t hiá»‡n tá»« quÃ¡ khá»© Ä‘áº¿n hiá»‡n táº¡i.

ğŸ”¶ **BÆ¯á»šC 6: Giáº£i thÃ­ch cÃ¡c triá»‡u chá»©ng cÃ²n láº¡i**  
â€“ Sau khi cÃ³ cháº©n Ä‘oÃ¡n há»™i chá»©ng á»Ÿ bÆ°á»›c 4, hÃ£y dÃ¹ng há»™i chá»©ng Ä‘Ã³ Ä‘á»ƒ kiá»ƒm tra xem cÃ²n triá»‡u chá»©ng nÃ o cá»§a bá»‡nh nhÃ¢n Ä‘Ã£ Ä‘Æ°á»£c mÃ´ táº£ mÃ  khÃ´ng thá»ƒ Ä‘Æ°á»£c giáº£i thÃ­ch má»™t cÃ¡ch há»£p lÃ½ bá»Ÿi há»™i chá»©ng Ä‘Ã³ khÃ´ng? Náº¿u cÃ³, hÃ£y láº¥y triá»‡u chá»©ng Ä‘Ã³ lÃ m chá»§ chá»©ng thá»© 2 Ä‘á»ƒ láº·p láº¡i quy trÃ¬nh cháº©n Ä‘oÃ¡n tá»« bÆ°á»›c 1 Ä‘áº¿n bÆ°á»›c 5. Cá»© lÃ m vÃ²ng láº·p nhÆ° váº­y cho Ä‘áº¿n khi táº¥t cáº£ triá»‡u chá»©ng Ä‘á»u cÃ³ cháº©n Ä‘oÃ¡n há»£p lÃ½.
â€“ Náº¿u cÃ²n thiáº¿u dá»¯ kiá»‡n, hÃ£y Ä‘áº·t tá»«ng cÃ¢u há»i cá»¥ thá»ƒ cho ngÆ°á»i dÃ¹ng Ä‘á»ƒ cung cáº¥p thÃªm thÃ´ng tin cho biá»‡n luáº­n cháº©n Ä‘oÃ¡n há»™i chá»©ng.

ğŸ”· **DANH SÃCH TRIá»†U CHá»¨NG VÃ€ VAS:**  
${symptomList}
${rawSymptoms}
${extraText}`; // ğŸ‘ˆ Gá»™p pháº§n bá»• sung

  // 4. Gá»­i GPT
const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({ prompt: prompt })
});

  const result = await res.json();
  const reply = result.choices?.[0]?.message?.content || "KhÃ´ng nháº­n Ä‘Æ°á»£c pháº£n há»“i tá»« GPT.";
  const followupQuestions = reply
  .split("\n")
  .filter(line => line.trim().startsWith("â–«") || line.trim().startsWith("â“"))
  .map(line => ({
    question: line.replace(/^(\â–«|â“)\s*/, "").trim()
  }));

  renderExtraQuestions(followupQuestions);
  localStorage.setItem("extraFollowupQuestions", JSON.stringify(followupQuestions));
  const outputBox = document.getElementById("syndrome-model");
  if (outputBox) {
    outputBox.value = reply;
  } else {
    alert("âŒ KhÃ´ng tÃ¬m tháº¥y Ã´ hiá»ƒn thá»‹ káº¿t quáº£ (syndrome-model).");
  }
}

function renderExtraQuestions(questions) {
  const container = document.getElementById("tree-extra-questions");
  container.innerHTML = "";

  if (!questions || !questions.length) return;

  questions.forEach((q, index) => {
    const wrapper = document.createElement("div");
    wrapper.className = "mb-3";

    const label = document.createElement("label");
    label.textContent = `â“ ${q.question}`;
    label.className = "block text-sm font-medium text-gray-700 mb-1";

    const input = document.createElement("input");
    input.type = "text";
    input.name = `extra-${index}`;
    input.className = "extra-question-input w-full border rounded px-3 py-1 focus:outline-none focus:ring focus:ring-blue-200";
    input.placeholder = "Nháº­p cÃ¢u tráº£ lá»i...";

    wrapper.appendChild(label);
    wrapper.appendChild(input);
    container.appendChild(wrapper);
  });
}

function collectExtraAnswers() {
  const inputs = document.querySelectorAll(".extra-question-input");
  const answers = [];

  inputs.forEach((input, index) => {
    const questionLabel = input.previousElementSibling?.textContent || `CÃ¢u há»i ${index + 1}`;
    const cleanQuestion = questionLabel.replace(/^â“\s*/, "").trim();
    const answer = input.value.trim();

    if (answer) {
      answers.push({ question: cleanQuestion, answer });
    }
  });

  return answers;
}


//HÃ m cho bÆ°á»›c 4

function populateStep4() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");

  // Há»™i chá»©ng tá»« bÆ°á»›c 3
  const syndrome = data.steps?.step3?.final || "(chÆ°a xÃ¡c Ä‘á»‹nh)";
  const syndromeDiv = document.getElementById("confirmed-syndrome");
  if (syndromeDiv) syndromeDiv.textContent = syndrome;

  // Triá»‡u chá»©ng ná»•i báº­t
  const symptoms = data.steps?.step2?.symptoms || [];
  const sorted = [...symptoms].sort((a, b) => b.vas - a.vas);
  const topSymptoms = sorted.slice(0, 5);

  const ul = document.getElementById("step4-top-symptom-list");
  if (ul) {
    ul.innerHTML = "";
    topSymptoms.forEach(s => {
      const li = document.createElement("li");
      li.textContent = `${s.symptom} (VAS ${s.vas})`;
      ul.appendChild(li);
    });
  }

  // Náº¡p dá»¯ liá»‡u cÃ¡c Ã´ Ä‘Ã£ cÃ³
  const step4 = data.steps?.step4 || {};
  const sixs = step4.sixs || {};

  const fields = [
    ["classic-formula-gpt", step4.gptClassicFormula],
    ["final-gpt-formula", step4.finalGPT],
    ["final-doctor-formula", step4.finalDoctor],
    ["sixs-source", sixs.source],
    ["sixs-symptom", sixs.symptom],
    ["sixs-site", sixs.site],
    ["sixs-strength", sixs.strength],
    ["sixs-sideeffect", sixs.sideeffect],
    ["sixs-secondary", sixs.secondary]
  ];

  fields.forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.value = value || "";
  });
}

  // Gá»£i Ã½ bÃ i thuá»‘c cá»• phÆ°Æ¡ng
  
async function autoSuggestClassicFormula() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const syndrome = data.steps?.step3?.final?.trim();
  const symptoms = data.steps?.step2?.symptoms || [];

  const outputBoxClassicFormula = document.getElementById("classic-formula-gpt");

  if (!syndrome || symptoms.length === 0) {
    outputBoxClassicFormula.value = "âš ï¸ Thiáº¿u dá»¯ liá»‡u há»™i chá»©ng hoáº·c triá»‡u chá»©ng.";
    return;
  }

  outputBoxClassicFormula.value = "â³ Äang gá»£i Ã½ bÃ i thuá»‘c, vui lÃ²ng chá»...";

  const symptomList = symptoms
    .sort((a, b) => b.vas - a.vas)
    .map((s, i) => `${i + 1}. ${s.symptom} (VAS: ${s.vas})`)
    .join("\n");

  const prompt = `
Báº¡n lÃ  bÃ¡c sÄ© Y há»c cá»• truyá»n. Dá»±a vÃ o há»™i chá»©ng cháº©n Ä‘oÃ¡n lÃ : **${syndrome}** vÃ  danh sÃ¡ch triá»‡u chá»©ng cÃ³ má»©c Ä‘á»™ nhÆ° sau:

${symptomList}

HÃ£y gá»£i Ã½ má»™t bÃ i thuá»‘c cá»• phÆ°Æ¡ng phÃ¹ há»£p nháº¥t vá»›i há»™i chá»©ng nÃ y. TrÃ¬nh bÃ y thÃ´ng tin bÃ i thuá»‘c theo Ä‘á»‹nh dáº¡ng Ä‘áº§y Ä‘á»§ sau:

ğŸ”¸ **TÃªn bÃ i thuá»‘c:**  
ğŸ”¸ **Xuáº¥t xá»© (sÃ¡ch nÃ o):**  
ğŸ”¸ **CÃ´ng nÄƒng:**  
ğŸ”¸ **Chá»§ trá»‹:**  
ğŸ”¸ **ThÃ nh pháº§n & liá»u lÆ°á»£ng:**  
ğŸ”¸ **CÃ¡ch dÃ¹ng:**  
ğŸ”¸ **LÆ°u Ã½ khi sá»­ dá»¥ng (náº¿u cÃ³):**  

Chá»‰ chá»n má»™t bÃ i thuá»‘c cá»• phÆ°Æ¡ng duy nháº¥t, lÃ½ giáº£i ngáº¯n gá»n vÃ¬ sao phÃ¹ há»£p náº¿u cáº§n. ChÃº Ã½ dÃ¹ng thuáº­t ngá»¯ chuyÃªn ngÃ nh Trung y, Æ°u tiÃªn giá»¯ cÃ¡c thuáº­t ngá»¯ HÃ¡n Viá»‡t
`;

const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({ prompt: prompt })
});

  const result = await res.json();
  const reply = result.choices?.[0]?.message?.content || "âŒ GPT khÃ´ng tráº£ vá» káº¿t quáº£.";

  outputBoxClassicFormula.value = reply;
}

function saveStep4() {
  const getVal = id => document.getElementById(id)?.value.trim() || "";

  const key = localStorage.getItem("currentPatient");
  if (!key) return alert("ChÆ°a chá»n há»“ sÆ¡!");

  const data = JSON.parse(localStorage.getItem(key) || "{}");

  data.steps = data.steps || {};
  data.steps.step4 = {
    gptClassicFormula: getVal("classic-formula-gpt"),
    finalGPT: getVal("final-gpt-formula"),
    finalDoctor: getVal("final-doctor-formula"),
    sixs: {
      source: getVal("sixs-source"),
      symptom: getVal("sixs-symptom"),
      site: getVal("sixs-site"),
      strength: getVal("sixs-strength"),
      sideeffect: getVal("sixs-sideeffect"),
      secondary: getVal("sixs-secondary"),
    }
  };

  localStorage.setItem(key, JSON.stringify(data));
  localStorage.setItem("currentData", JSON.stringify(data));
}

async function suggestSourceHerbsByGPT() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const syndrome = data.steps?.step3?.final?.trim();

  if (!syndrome) {
    alert("âš ï¸ ChÆ°a cÃ³ há»™i chá»©ng YHCT á»Ÿ bÆ°á»›c 3.");
    return;
  }

  const outputBox = document.getElementById("sixs-source");
  if (outputBox) outputBox.value = "â³ Äang truy váº¥n GPT, vui lÃ²ng chá»...";

  // Danh sÃ¡ch phÃ¡p trá»‹ chuáº©n
  const allTreatments = Array.isArray(window.treatmentTerms)
    ? window.treatmentTerms
    : [];

  const treatmentListText = allTreatments.join(", ");

  const prompt = `
Báº¡n lÃ  chuyÃªn gia Y há»c cá»• truyá»n. DÆ°á»›i Ä‘Ã¢y lÃ  danh sÃ¡ch phÃ¡p trá»‹ Ä‘Æ°á»£c phÃ©p sá»­ dá»¥ng:

${window.treatmentTerms.join(", ")}

HÃ£y Ä‘á»c ká»¹ danh sÃ¡ch nÃ y. Chá»‰ Ä‘Æ°á»£c chá»n tá»« danh sÃ¡ch nÃ y, khÃ´ng Ä‘Æ°á»£c táº¡o phÃ¡p trá»‹ má»›i, khÃ´ng viáº¿t linh tinh.

Há»™i chá»©ng Y há»c cá»• truyá»n: ${syndrome}

HÃ£y tráº£ lá»i Ä‘Ãºng Ä‘á»‹nh dáº¡ng sau:

+ NguyÃªn nhÃ¢n: (1 cÃ¢u mÃ´ táº£)
+ CÆ¡ cháº¿ bá»‡nh sinh: (1â€“2 cÃ¢u mÃ´ táº£)
+ PhÃ¡p trá»‹: (3â€“7 phÃ¡p trá»‹, cÃ¡ch nhau báº±ng dáº¥u pháº©y, chá»‰ dÃ¹ng tá»« danh sÃ¡ch Ä‘Æ°á»£c cung cáº¥p)

KhÃ´ng thÃªm vá»‹ thuá»‘c, khÃ´ng viáº¿t "Tá»« khÃ³a", khÃ´ng giáº£i thÃ­ch.
âš ï¸ Náº¿u báº¡n viáº¿t sai Ä‘á»‹nh dáº¡ng hoáº·c tá»± táº¡o phÃ¡p trá»‹ ngoÃ i danh sÃ¡ch, báº¡n sáº½ bá»‹ Ä‘Ã¡nh giÃ¡ lÃ  sai.
`;
try {
 const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });  
    const result = await res.json();
    const reply = result.choices?.[0]?.message?.content || "";

    // TrÃ­ch xuáº¥t dÃ²ng phÃ¡p trá»‹
    const line = reply.split("\n").find(l => l.toLowerCase().includes("phÃ¡p trá»‹"));
    if (!line) {
      outputBox.value = "âŒ KhÃ´ng trÃ­ch xuáº¥t Ä‘Æ°á»£c phÃ¡p trá»‹ tá»« GPT.";
      return;
    }

    const effectList = line.split(":")[1]
      .split(",")
      .map(s => s.trim())
      .filter(s => allTreatments.includes(s));

    const uniqueHerbs = new Set();

    // Duyá»‡t cÃ¡c phÃ¡p trá»‹, tÃ¬m vá»‹ thuá»‘c tá»« 2 nguá»“n
    for (const effect of effectList) {
      // 1. Tá»« organEffects
      for (const organ in window.organEffects) {
        const herbs = window.organEffects[organ]?.[effect];
        if (Array.isArray(herbs)) {
          herbs.forEach(h => uniqueHerbs.add(h));
        }
      }

      // 2. Tá»« herbsByEffect
      const herbs = window.herbsByEffect?.[effect];
      if (Array.isArray(herbs)) {
        herbs.forEach(h => uniqueHerbs.add(h.vietnamese));
      }
    }

    // Xuáº¥t ra textarea
    const resultText = Array.from(uniqueHerbs).join(", ");
    outputBox.value = resultText || "âŒ KhÃ´ng tÃ¬m tháº¥y vá»‹ thuá»‘c phÃ¹ há»£p vá»›i cÃ¡c phÃ¡p trá»‹.";
  } catch (error) {
    outputBox.value = `âŒ Lá»—i GPT: ${error.message}`;
  }
}
  
async function suggestSymptomHerbsByGPT() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const syndrome = data.steps?.step3?.final?.trim();
  const symptoms = data.steps?.step2?.symptoms || [];

  if (!symptoms.length) {
    alert("âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u triá»‡u chá»©ng.");
    return;
  }

  const outputBox = document.getElementById("sixs-symptom");
  if (outputBox) outputBox.value = "â³ Äang phÃ¢n tÃ­ch, vui lÃ²ng chá»...";

  // Load dá»¯ liá»‡u ná»™i bá»™
let organEffects = typeof window.organEffects === "string"
  ? JSON.parse(window.organEffects)
  : window.organEffects || {};

let herbsByEffect = typeof window.herbsByEffect === "string"
  ? JSON.parse(window.herbsByEffect)
  : window.herbsByEffect || {};

let doiDuoc = Array.isArray(window.doiDuocData)
  ? window.doiDuocData
  : typeof window.doiDuocData === "string"
  ? JSON.parse(window.doiDuocData)
  : [];

  // Táº¡o prompt GPT
  const symptomList = symptoms
    .sort((a, b) => b.vas - a.vas)
    .map(s => `- ${s.symptom} (VAS ${s.vas})`)
    .join("\n");

const prompt = `
Báº¡n lÃ  chuyÃªn gia Y há»c cá»• truyá»n (Trung y, ä¸­é†«), quen thuá»™c vá»›i thuáº­t ngá»¯ trong cÃ¡c sÃ¡ch kinh Ä‘iá»ƒn nhÆ° Ná»™i Kinh, ThÆ°Æ¡ng HÃ n Luáº­n, Kim Quá»¹ Yáº¿u LÆ°á»£c.

DÆ°á»›i Ä‘Ã¢y lÃ  danh sÃ¡ch triá»‡u chá»©ng ngÆ°á»i bá»‡nh Ä‘ang cÃ³:
${symptomList}

YÃªu cáº§u:
- Vá»›i má»—i triá»‡u chá»©ng, hÃ£y liá»‡t kÃª cÃ¡c tá»« khÃ³a Ä‘á»“ng nghÄ©a hoáº·c tÆ°Æ¡ng Ä‘Æ°Æ¡ng.
- Bao gá»“m cáº£ tá»« thuáº§n Viá»‡t (thá»±c táº¿ lÃ¢m sÃ ng) vÃ  tá»« HÃ¡n Viá»‡t Ä‘Ãºng thuáº­t ngá»¯ Trung y.
- Tá»‘i thiá»ƒu 3 tá»« khÃ³a cho má»—i triá»‡u chá»©ng, Æ°u tiÃªn cÃ¡c tá»« thÆ°á»ng dÃ¹ng trong biá»‡n chá»©ng luáº­n trá»‹ vÃ  cháº©n Ä‘oÃ¡n Trung y.

Äá»‹nh dáº¡ng káº¿t quáº£:

ğŸ”¹ Máº¥t ngá»§: khÃ³ ngá»§, ngá»§ Ã­t, tháº¥t miÃªn, báº¥t má»‹
ğŸ”¹ Äau tháº¯t lÆ°ng: Ä‘au vÃ¹ng tháº¯t lÆ°ng, yÃªu thá»‘ng, Ä‘au lÆ°ng, tháº¯t lÆ°ng Ä‘au, yÃªu táº¥t toan nhuyá»…n
`;

  const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const result = await res.json();
  const reply = result.choices?.[0]?.message?.content || "";

  if (!reply) {
    alert("âŒ GPT khÃ´ng tráº£ káº¿t quáº£.");
    return;
  }

  // Xá»­ lÃ½ káº¿t quáº£ tá»« GPT
  const keywordMap = new Map(); // symptom -> [keyword1, keyword2, ...]
  const lines = reply.split("\n").map(l => l.trim()).filter(l => l.includes(":"));

  lines.forEach(line => {
    const [symptom, keywordsStr] = line.split(":").map(s => s.trim());
    const keywords = keywordsStr.split(",").map(k => k.trim()).filter(k => k);
    if (symptom && keywords.length) {
      keywordMap.set(symptom, keywords);
    }
  });

  const resultLines = [];
  
for (const [symptomLabel, keywords] of keywordMap.entries()) {
  const vasValue = symptoms.find(s => symptomLabel.includes(s.symptom))?.vas || 50;
  const herbsSet = new Set();

  keywords.forEach(keyword => {
    // âœ… Tra trong organEffects (object)
    Object.entries(organEffects).forEach(([organ, effectMap]) => {
      Object.entries(effectMap).forEach(([effect, herbs]) => {
        if (effect.includes(keyword)) {
          herbs.forEach(h => herbsSet.add(h));
        }
      });
    });

    // âœ… Tra trong herbsByEffect (object)
    Object.entries(herbsByEffect).forEach(([effect, herbs]) => {
      if (effect.includes(keyword)) {
        herbs.forEach(h => herbsSet.add(h.vietnamese)); // hoáº·c `${h.vietnamese} (${h.latin})`
      }
    });

    // âœ… Tra trong doiDuoc (array)
    doiDuoc.forEach(item => {
      if ((item.doiduoc || "").includes(keyword) || (item.chutri || "").includes(keyword)) {
        const herbs = (item.doiduoc || "").split("â€“").map(h => h.trim());
        herbs.forEach(h => herbsSet.add(h));
      }
    });
  });

const allHerbs = Array.from(herbsSet);

// 1. Láº¥y cÃ¡c vá»‹ cÃ³ score tá»« herbsByEffect
const herbsWithScore = allHerbs.map(h => {
  let found = null;
  Object.values(herbsByEffect).some(effectList => {
    const match = effectList.find(item => item.vietnamese === h);
    if (match) {
      found = match;
      return true;
    }
    return false;
  });

  const score = found?.score ?? null;
  const diff = score !== null ? Math.abs(score - vasValue) : Infinity;
  return { herb: h, score, diff };
});

// 2. Láº¥y top 3 theo score gáº§n VAS
const scoredSelected = herbsWithScore
  .filter(h => h.score !== null)
  .sort((a, b) => a.diff - b.diff)
  .slice(0, 3)
  .map(h => h.herb);

// 3. Láº¥y táº¥t cáº£ vá»‹ thuá»‘c chá»‰ xuáº¥t hiá»‡n tá»« doiDuoc (khÃ´ng cÃ³ score)
const doiDuocOnly = allHerbs.filter(h => {
  const hasScore = Object.values(herbsByEffect).some(effectList =>
    effectList.some(item => item.vietnamese === h)
  );
  return !hasScore;
});

// 4. Gá»™p láº¡i: vá»‹ cÃ³ score gáº§n VAS + táº¥t cáº£ vá»‹ tá»« doiDuoc
const selected = [...scoredSelected, ...doiDuocOnly];

    if (selected.length === 0) {
    resultLines.push(`${symptomLabel}: (KhÃ´ng tÃ¬m tháº¥y vá»‹ thuá»‘c phÃ¹ há»£p vá»›i tá»« khÃ³a)`);
  } else {
    resultLines.push(`${symptomLabel}: ${selected.join(", ")}`);
}
  }
  if (outputBox) outputBox.value = resultLines.join("\n");
  alert("âœ… ÄÃ£ gá»£i Ã½ vá»‹ thuá»‘c theo triá»‡u chá»©ng vÃ  má»©c Ä‘á»™ VAS.");
}

async function suggestSiteHerbsByGPT() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");

  const syndrome = data.steps?.step3?.final?.trim();
  const symptoms = data.steps?.step2?.symptoms || [];

  if (!syndrome || symptoms.length === 0) {
    alert("âš ï¸ Thiáº¿u há»™i chá»©ng hoáº·c triá»‡u chá»©ng Ä‘á»ƒ phÃ¢n tÃ­ch.");
    return;
  }

  const outputBox = document.getElementById("sixs-site");
  if (outputBox) outputBox.value = "â³ Äang phÃ¢n tÃ­ch, vui lÃ²ng chá»...";

  const topSymptomsText = [...symptoms]
    .sort((a, b) => b.vas - a.vas)
    .slice(0, 5)
    .map(s => `â€“ ${s.symptom} (VAS ${s.vas})`)
    .join("\n");

let organEffects = window.organEffects;
if (typeof organEffects === "string") {
  try {
    organEffects = JSON.parse(organEffects);
  } catch (e) {
    organEffects = [];
  }
}
if (!Array.isArray(organEffects)) organEffects = [];

let strengherb = window.strengherb;
if (typeof strengherb === "string") {
  try {
    strengherb = JSON.parse(strengherb);
  } catch (e) {
    strengherb = [];
  }
}
if (!Array.isArray(strengherb)) strengherb = [];

let doiDuoc = window.doiDuocData;
if (typeof doiDuoc === "string") {
  try {
    doiDuoc = JSON.parse(doiDuoc);
  } catch (e) {
    doiDuoc = [];
  }
}
if (!Array.isArray(doiDuoc)) doiDuoc = [];

  // Giai Ä‘oáº¡n 1: GPT phÃ¢n tÃ­ch vÃ¹ng bá»‹ áº£nh hÆ°á»Ÿng
  async function getAffectedSitesFromGPT(syndrome, topSymptomsText) {
    const prompt = `
Báº¡n lÃ  chuyÃªn gia Y há»c cá»• truyá»n. TÃ´i cung cáº¥p:

ğŸ”¸ Há»™i chá»©ng YHCT: ${syndrome}
ğŸ”¸ Triá»‡u chá»©ng ná»•i báº­t:
${topSymptomsText}

HÃ£y liá»‡t kÃª nhá»¯ng vÃ¹ng hoáº·c táº¡ng phá»§ nÃ o cá»§a cÆ¡ thá»ƒ Ä‘ang bá»‹ áº£nh hÆ°á»Ÿng chÃ­nh (vÃ­ dá»¥: lÆ°ng, Ä‘áº§u, bá»¥ng dÆ°á»›i, ngá»±c, vÃ¹ng máº¯t, táº¡ng TÃ¢m, táº¡ng Canâ€¦).  
Chá»‰ tráº£ vá» danh sÃ¡ch tá»«ng vÃ¹ng, má»—i dÃ²ng má»™t má»¥c, khÃ´ng kÃ¨m phÃ¢n tÃ­ch.
    `;

    const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });

    const result = await res.json();
    const content = result.choices?.[0]?.message?.content || "";
    return content.split("\n").map(line => line.replace(/^-?\s*/, "").trim()).filter(Boolean);
  }

  // Giai Ä‘oáº¡n 2: tra dá»¯ liá»‡u ná»™i bá»™ Ä‘á»ƒ tÃ¬m vá»‹ thuá»‘c Ä‘áº·c hiá»‡u vÃ¹ng Ä‘Ã³
  function findSiteHerbsFromData(site, organEffects, strengherb, doiDuoc) {
    const herbs = new Set();

    // Tra organEffects
    organEffects.forEach(item => {
      if ((item.organ || "").includes(site) || (item.effect || "").includes(site)) {
        herbs.add(item.herb);
      }
    });

    // Tra strengherb
    strengherb.forEach(item => {
      if ((item.action || "").includes(site)) {
        herbs.add(item.herb);
      }
    });

    // Tra doiDuoc: náº¿u báº¥t ká»³ thÃ´ng tin nÃ o trong má»™t nhÃ³m khá»›p vá»›i site, láº¥y toÃ n bá»™ nhÃ³m
    doiDuoc.forEach(group => {
      const groupMatch = group.group?.some(g =>
        Object.values(g).some(val => (val || "").includes(site))
      );
      if (groupMatch) {
        group.group?.forEach(g => herbs.add(g.name));
      }
    });

    return Array.from(herbs);
  }

  // Giai Ä‘oáº¡n 3: náº¿u khÃ´ng Ä‘á»§ thuá»‘c, gá»i GPT Ä‘á»ƒ há»i
  async function getHerbsForSiteFromGPT(site) {
    const prompt = `
Báº¡n lÃ  chuyÃªn gia Y há»c cá»• truyá»n. HÃ£y liá»‡t kÃª cÃ¡c vá»‹ thuá»‘c thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ dáº«n thuá»‘c hoáº·c cÃ³ tÃ¡c dá»¥ng Ä‘áº·c hiá»‡u táº¡i vÃ¹ng sau:

ğŸ”¸ VÃ¹ng bá»‹ bá»‡nh: ${site}

Chá»‰ tráº£ vá» tÃªn cÃ¡c vá»‹ thuá»‘c, cÃ¡ch nhau dáº¥u pháº©y, khÃ´ng kÃ¨m phÃ¢n tÃ­ch.
    `;

    const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });

    const result = await res.json();
    const content = result.choices?.[0]?.message?.content || "";
    return content.split(",").map(h => h.trim()).filter(Boolean);
  }

  // Gá»i GPT láº¥y danh sÃ¡ch vÃ¹ng bá»‹ bá»‡nh
  const sites = await getAffectedSitesFromGPT(syndrome, topSymptomsText);

  const resultLines = [];

  for (const site of sites) {
    let herbs = findSiteHerbsFromData(site, organEffects, strengherb, doiDuoc);

    // Náº¿u dá»¯ liá»‡u ná»™i bá»™ khÃ´ng cÃ³, gá»i GPT há»— trá»£
    if (herbs.length === 0) {
      herbs = await getHerbsForSiteFromGPT(site);
    }

    // Chá»n tá»‘i Ä‘a 3 vá»‹ thuá»‘c
    const selected = herbs.length > 3
      ? herbs.sort(() => 0.5 - Math.random()).slice(0, 3)
      : herbs;

    resultLines.push(`${site}: ${selected.join(", ")}`);
  }

  if (outputBox) outputBox.value = resultLines.join("\n");
  alert("âœ… ÄÃ£ gá»£i Ã½ vá»‹ thuá»‘c cÃ³ tÃ¡c dá»¥ng vÃ o vÃ¹ng bá»‹ bá»‡nh.");
}

async function suggestStrengthDoseByGPT() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const symptoms = data.steps?.step2?.symptoms || [];
  const keywordMap = data.steps?.step4?.keywordMap; // keywordMap Ä‘Æ°á»£c lÆ°u tá»« suggestSymptomHerbsByGPT
  const outputBox = document.getElementById("sixs-strength");

  if (!keywordMap || !symptoms.length) {
    alert("âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u keyword hoáº·c VAS.");
    return;
  }

  if (outputBox) outputBox.value = "â³ Äang phÃ¢n tÃ­ch liá»u lÆ°á»£ng...";

  // Load herbalData
  const herbList = Array.isArray(window.herbalData)
    ? window.herbalData
    : typeof window.herbalData === "string"
    ? JSON.parse(window.herbalData)
    : [];

  // Map<herb â†’ VAS>
  const herbVASMap = new Map();

  for (const [symptomLabel, keywords] of Object.entries(keywordMap)) {
    const vas = symptoms.find(s => symptomLabel.includes(s.symptom))?.vas || 5;

    keywords.forEach(keyword => {
      // Danh sÃ¡ch vá»‹ thuá»‘c tá»« suggestSymptomHerbsByGPT Ä‘Ã£ cÃ³ rá»“i
      const matchedHerbs = data.steps?.step4?.symptomHerbs?.[symptomLabel] || [];

      matchedHerbs.forEach(h => {
        const prev = herbVASMap.get(h) || 0;
        if (vas > prev) herbVASMap.set(h, vas);
      });
    });
  }

  // HÃ m láº¥y sd_dose tá»« herbalData hoáº·c GPT
  async function getStandardDose(herbName) {
    const found = herbList.find(h => h.herb === herbName);
    if (found && found.sd_dose) return found.sd_dose;

    // GPT fallback náº¿u khÃ´ng cÃ³ sd_dose
    const gptPrompt = `Báº¡n lÃ  chuyÃªn gia Y há»c cá»• truyá»n. Liá»u dÃ¹ng trung bÃ¬nh má»—i ngÃ y (gam) cá»§a vá»‹ thuá»‘c "${herbName}" lÃ  bao nhiÃªu? Tráº£ lá»i duy nháº¥t má»™t con sá»‘ (g), khÃ´ng thÃªm chÃº thÃ­ch.`;

    try {
      const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: gptPrompt })
      });

      const result = await res.json();
      const text = result.choices?.[0]?.message?.content || "";
      const match = text.match(/(\d+([.,]\d+)?)/);
      if (match) return parseFloat(match[1].replace(",", "."));
    } catch (e) {
      console.warn(`GPT khÃ´ng tráº£ lá»i liá»u cho ${herbName}`, e);
    }

    return 8; // fallback náº¿u GPT cÅ©ng khÃ´ng tráº£ vá»
  }

  const resultLines = [];

  for (const [herb, vas] of herbVASMap.entries()) {
    const sd_dose = await getStandardDose(herb);
    let dose = sd_dose;

    if (vas >= 8) dose = sd_dose * 3;
    else if (vas >= 6) dose = sd_dose * 2;
    else if (vas >= 4) dose = sd_dose * 1.5;
    else dose = sd_dose;

    dose = Math.round(dose * 10) / 10;
    resultLines.push(`${herb}: ${dose}g (VAS ${vas})`);
  }

  if (outputBox) outputBox.value = resultLines.join("\n");
  alert("âœ… ÄÃ£ gá»£i Ã½ liá»u lÆ°á»£ng theo má»©c Ä‘á»™ triá»‡u chá»©ng.");
}

async function suggestSideEffectModifiers() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");

  const syndrome = data.steps?.step3?.final?.trim() || "(khÃ´ng ghi)";
  const herbsS1 = (document.getElementById("sixs-source")?.value || "").split(",").map(s => s.trim()).filter(Boolean);
  const herbsS2 = (document.getElementById("sixs-symptom")?.value || "").split(",").map(s => s.trim()).filter(Boolean);
  const herbsS3 = (document.getElementById("sixs-site")?.value || "").split(",").map(s => s.trim()).filter(Boolean);
  const herbRawList = [...new Set([...herbsS1, ...herbsS2, ...herbsS3])];

  if (herbRawList.length === 0) {
    alert("âš ï¸ ChÆ°a cÃ³ vá»‹ thuá»‘c tá»« cÃ¡c bÆ°á»›c trÆ°á»›c.");
    return;
  }

  const outputBox = document.getElementById("sixs-sideeffect");
  if (outputBox) outputBox.value = "â³ GPT Ä‘ang phÃ¢n tÃ­ch, vui lÃ²ng chá»...";

  const prompt = `
Báº¡n lÃ  chuyÃªn gia Trung y. DÆ°á»›i Ä‘Ã¢y lÃ  danh sÃ¡ch vá»‹ thuá»‘c Ä‘Ã£ dÃ¹ng trong toa (thuá»™c vÃ¹ng S1â€“S3):

ğŸ”¸ Danh sÃ¡ch vá»‹ thuá»‘c: ${herbRawList.join(", ")}
ğŸ”¸ Há»™i chá»©ng chÃ­nh: ${syndrome}

YÃªu cáº§u:
1. Dá»±a vÃ o lÃ½ luáº­n Trung y, hÃ£y phÃ¢n tÃ­ch cÃ¡c vá»‹ thuá»‘c trÃªn cÃ³ thá»ƒ gÃ¢y ra **tÃ¡c dá»¥ng phá»¥ tiá»m áº©n** nÃ o (VD: hao khÃ­, thÆ°Æ¡ng Ã¢m, tá»•n thÆ°Æ¡ng Tá»³ vá»‹, sinh tháº¥p trá»‡...).
2. Vá»›i má»—i loáº¡i tÃ¡c dá»¥ng phá»¥, hÃ£y Ä‘á» xuáº¥t **1â€“2 vá»‹ thuá»‘c bá»• sung** Ä‘á»ƒ **Ä‘iá»u hÃ²a â€“ phÃ²ng ngá»«a â€“ bá»“i bá»•**, giÃºp cÃ¢n báº±ng tÃ¡c dá»¥ng toÃ n toa.
3. Vá»›i má»—i vá»‹ thuá»‘c Ä‘á» xuáº¥t, cung cáº¥p:
   â€“ âœ… TÃªn vá»‹ thuá»‘c
   â€“ ğŸ’¡ Giáº£i thÃ­ch ngáº¯n gá»n cÃ´ng nÄƒng Ä‘iá»u hÃ²a
   â€“ âš–ï¸ Liá»u dÃ¹ng thÆ°á»ng gáº·p (Ä‘Æ¡n vá»‹ gam, theo y vÄƒn Trung y)

Tráº£ vá» theo Ä‘á»‹nh dáº¡ng tá»«ng dÃ²ng nhÆ° sau:

[TÃªn vá»‹ thuá»‘c] â€“ [giáº£i thÃ­ch ngáº¯n gá»n]. Liá»u thÆ°á»ng dÃ¹ng: [xâ€“y]g

Chá»‰ tráº£ vá» danh sÃ¡ch, khÃ´ng phÃ¢n tÃ­ch dÃ i dÃ²ng.
`;

  const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ prompt: prompt })
  });

  const result = await res.json();
  const reply = result.choices?.[0]?.message?.content || "";

  if (outputBox) outputBox.value = reply;

  alert("âœ… ÄÃ£ gá»£i Ã½ thuá»‘c Ä‘iá»u hÃ²a Ä‘á»ƒ phÃ²ng tÃ¡c dá»¥ng phá»¥.");
}

async function suggestSecondaryPrevention() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");

  const syndrome = data.steps?.step3?.final?.trim();
  const symptoms = data.steps?.step2?.symptoms || [];

  if (!syndrome || symptoms.length === 0) {
    alert("âš ï¸ Thiáº¿u há»™i chá»©ng hoáº·c triá»‡u chá»©ng Ä‘á»ƒ phÃ¢n tÃ­ch.");
    return;
  }

  const outputBox = document.getElementById("sixs-secondary");
  if (outputBox) outputBox.value = "â³ GPT Ä‘ang phÃ¢n tÃ­ch kháº£ nÄƒng biáº¿n chá»©ng...";

  const symptomList = symptoms
    .sort((a, b) => b.vas - a.vas)
    .map(s => `â€“ ${s.symptom} (VAS: ${s.vas})`)
    .join("\n");

  const prompt = `
Báº¡n lÃ  chuyÃªn gia Y há»c cá»• truyá»n. TÃ´i cung cáº¥p thÃ´ng tin:

ğŸ”¸ Há»™i chá»©ng hiá»‡n táº¡i: ${syndrome}
ğŸ”¸ Triá»‡u chá»©ng ná»•i báº­t:
${symptomList}

YÃªu cáº§u:
1. Dá»± Ä‘oÃ¡n cÃ¡c **biáº¿n chá»©ng tiá»m tÃ ng cÃ³ thá»ƒ xáº£y ra trong diá»…n tiáº¿n** cá»§a há»™i chá»©ng nÃ y, theo lÃ½ luáº­n Trung y (vÃ­ dá»¥: thÆ°Æ¡ng Ã¢m, huyáº¿t á»©, tháº¥p trá»‡ lÃ¢u ngÃ y hÃ³a nhiá»‡t...).
2. Vá»›i má»—i nguy cÆ¡ biáº¿n chá»©ng, Ä‘á» xuáº¥t **1â€“2 vá»‹ thuá»‘c** cÃ³ thá»ƒ **dá»± phÃ²ng hoáº·c lÃ m giáº£m nguy cÆ¡ Ä‘Ã³**.
3. Vá»›i má»—i vá»‹ thuá»‘c, cung cáº¥p:
   â€“ âœ… TÃªn vá»‹ thuá»‘c
   â€“ ğŸ’¡ Giáº£i thÃ­ch ngáº¯n gá»n lÃ½ do dÃ¹ng (phÃ²ng biáº¿n chá»©ng gÃ¬)
   â€“ âš–ï¸ Liá»u dÃ¹ng thÆ°á»ng gáº·p (Ä‘Æ¡n vá»‹ gam)

Chá»‰ tráº£ vá» danh sÃ¡ch dáº¡ng tá»«ng dÃ²ng nhÆ° sau:

[TÃªn vá»‹ thuá»‘c] â€“ [giáº£i thÃ­ch ngáº¯n gá»n]. Liá»u thÆ°á»ng dÃ¹ng: [xâ€“y]g

KhÃ´ng kÃ¨m phÃ¢n tÃ­ch dÃ i dÃ²ng.
`;

  const res = await fetch("https://gpt-api-19xu.onrender.com/gpt.php", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ prompt: prompt })
  });

  const result = await res.json();
  const reply = result.choices?.[0]?.message?.content || "";

  if (outputBox) outputBox.value = reply;

  alert("âœ… ÄÃ£ gá»£i Ã½ vá»‹ thuá»‘c dá»± phÃ²ng biáº¿n chá»©ng.");
}

 function renderFinalGPTFormula() {
  const strengthText = document.getElementById("sixs-strength")?.value || "";
  const sideEffectText = document.getElementById("sixs-sideeffect")?.value || "";
  const secondaryText = document.getElementById("sixs-secondary")?.value || "";

  const allLines = [strengthText, sideEffectText, secondaryText]
    .join("\n")
    .split("\n")
    .map(line => line.trim())
    .filter(line => line.includes(":"));

  const herbMap = new Map();

  for (const line of allLines) {
    const [herb, doseRaw] = line.split(":").map(p => p.trim());
    if (!herb) continue;

    // TÃ¬m táº¥t cáº£ sá»‘ trong chuá»—i (g, gam)
    const numbers = (doseRaw.match(/\d+/g) || []).map(Number);
    const maxDose = numbers.length > 0 ? Math.max(...numbers) : 0;

    // Náº¿u Ä‘Ã£ cÃ³, láº¥y liá»u cao hÆ¡n
    if (!herbMap.has(herb)) {
      herbMap.set(herb, maxDose);
    } else {
      const existing = herbMap.get(herb);
      if (maxDose > existing) {
        herbMap.set(herb, maxDose);
      }
    }
  }

  const finalFormula = Array.from(herbMap.entries())
    .map(([herb, dose]) => `${herb} ${dose}g`)
    .join(", ");

  const outputBox = document.getElementById("final-gpt-formula");
  if (outputBox) outputBox.value = finalFormula;
}

//HÃ m cho bÆ°á»›c 5

function populateStep5() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");

  // PHáº¦N 1: Hiá»ƒn thá»‹ láº¡i cÃ¡c toa thuá»‘c cÅ©
  const container = document.getElementById("previous-formulas");
  if (!container) return console.error("âŒ KhÃ´ng tÃ¬m tháº¥y pháº§n tá»­ #previous-formulas");
  container.innerHTML = "";

  const history = data.steps?.step2?.history || [];
  history.forEach((entry, i) => {
    const formulaText = [];

    const date = entry?.datetime || `(ChÆ°a ghi ngÃ y)`;
    const syndrome = entry?.syndrome?.final || "(chÆ°a cÃ³ há»™i chá»©ng)";
    const finalFormula = entry?.step5?.finalFormula || "(chÆ°a lÆ°u)";
    const usage = entry?.step5?.usage || "(chÆ°a ghi)";
    const note = entry?.step5?.note || "";

    formulaText.push(`ğŸ—“ï¸ Láº§n ${i + 1} â€“ NgÃ y: ${date} â€“ Há»™i chá»©ng: ${syndrome}`);
    formulaText.push(`ğŸ§¾ Toa thuá»‘c: ${finalFormula}`);
    formulaText.push(`ğŸ’Š CÃ¡ch dÃ¹ng: ${usage}`);
    if (note) formulaText.push(`ğŸ“ Ghi chÃº: ${note}`);

    const box = document.createElement("textarea");
    box.className = "w-full border rounded px-3 py-2 bg-gray-100 mb-4";
    box.rows = 5;
    box.readOnly = true;
    box.value = formulaText.join("\n\n");

    container.appendChild(box);
  });

  // PHáº¦N 2: Hiá»ƒn thá»‹ toa bÃ¡c sÄ© tá»« bÆ°á»›c 4
  const doctorDraft = document.getElementById("step5-doctor-draft");
  if (doctorDraft) {
  doctorDraft.value = data.steps?.step4?.finalDoctor || "";
  parseDoctorDraftFormula();
  }

  const finalFormula = document.getElementById("step5-final-formula");
  if (finalFormula) finalFormula.value = data.steps?.step5?.finalFormula || "";

  const usage = document.getElementById("step5-usage");
  if (usage) usage.value = data.steps?.step5?.usage || "";

  const note = document.getElementById("step5-note");
  if (note) note.value = data.steps?.step5?.note || "";
}

function parseDoctorDraftFormula() {
  const draft = document.getElementById("step5-doctor-draft")?.value || "";
  const container = document.getElementById("final-herb-list");
  if (!draft || !container) return;

  const herbs = [];

  // Chuáº©n hÃ³a: tÃ¡ch báº±ng dáº¥u pháº©y hoáº·c dáº¥u cá»™ng
  const items = draft.split(/[,+]/);

  items.forEach(item => {
    const parts = item.trim().match(/^(.+?)\s*(\d+(?:[.,]\d+)?)/);
    if (parts && parts.length >= 3) {
      const name = parts[1].trim();
      const dose = parts[2].replace(",", "."); // chuyá»ƒn 12,5 â†’ 12.5
      herbs.push({ name, dose });
    }
  });

  renderFinalHerbList(herbs);
}

function renderFinalHerbList(herbs) {
  const container = document.getElementById("final-herb-list");
  container.innerHTML = "";

  herbs.forEach((item, index) => {
    const row = document.createElement("div");
    row.className = "flex items-center gap-2";

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.value = item.name;
    nameInput.className = "flex-1 border rounded px-3 py-2";
    nameInput.oninput = () => herbs[index].name = nameInput.value;

    const doseInput = document.createElement("input");
    doseInput.type = "text";
    doseInput.value = item.dose;
    doseInput.className = "w-24 border rounded px-3 py-2";
    doseInput.oninput = () => herbs[index].dose = doseInput.value;

    const btn = document.createElement("button");
    btn.textContent = "ğŸ—‘ï¸";
    btn.className = "text-red-600 hover:text-red-800";
    btn.onclick = () => {
      herbs.splice(index, 1);
      renderFinalHerbList(herbs);
    };

    row.appendChild(nameInput);
    row.appendChild(doseInput);
    row.appendChild(btn);
    container.appendChild(row);
  });

  container.dataset.herbs = JSON.stringify(herbs);
}

function renderPrescriptionHistory() {
  const data = JSON.parse(localStorage.getItem("currentData") || "{}");
  const history = data.steps?.step2?.history || [];
  const container = document.getElementById("prescription-history");
  container.innerHTML = "";

  if (history.length === 0) {
    container.innerHTML = "<p class='text-gray-500'>ChÆ°a cÃ³ láº§n khÃ¡m nÃ o trÆ°á»›c Ä‘Ã³.</p>";
    return;
  }

  history.forEach((entry, index) => {
    const div = document.createElement("div");
    div.className = "p-4 border rounded bg-white shadow";

    const datetime = entry.datetime || "(khÃ´ng rÃµ ngÃ y)";
    const syndrome = entry.syndrome?.final || "(chÆ°a ghi)";
    const formula = entry.step5?.finalFormula || "(chÆ°a cÃ³)";
    const usage = entry.step5?.usage || "";
    const note = entry.step5?.note || "";

    div.innerHTML = `
      <div class="text-sm text-gray-700 mb-1">ğŸ•’ <b>Láº§n khÃ¡m ${index + 1}</b> â€“ ${datetime}</div>
      <div class="mb-1">ğŸ§  <b>Há»™i chá»©ng:</b> ${syndrome}</div>
      <div class="mb-1">ğŸ’Š <b>Toa thuá»‘c:</b> ${formula}</div>
      <div class="mb-1">ğŸ“„ <b>CÃ¡ch dÃ¹ng:</b> ${usage}</div>
      <div class="mb-1">ğŸ“ <b>Ghi chÃº:</b> ${note}</div>
    `;
    container.appendChild(div);
  });
}

function renderFinalHerbList(herbs) {
  const container = document.getElementById("final-herb-list");
  container.innerHTML = "";

  herbs.forEach((item, index) => {
    const row = document.createElement("div");
    row.className = "flex items-center gap-2 herb-row";

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.value = item.name;
    nameInput.className = "flex-1 border rounded px-3 py-2 herb-name";
    nameInput.oninput = () => herbs[index].name = nameInput.value;

    const doseInput = document.createElement("input");
    doseInput.type = "text";
    doseInput.value = item.dose;
    doseInput.className = "w-24 border rounded px-3 py-2 herb-dose";
    doseInput.oninput = () => herbs[index].dose = doseInput.value;

    const btn = document.createElement("button");
    btn.textContent = "ğŸ—‘ï¸";
    btn.className = "text-red-600 hover:text-red-800";
    btn.onclick = () => {
      herbs.splice(index, 1);
      renderFinalHerbList(herbs);
    };

    row.appendChild(nameInput);
    row.appendChild(doseInput);
    row.appendChild(btn);
    container.appendChild(row);
  });

  container.dataset.herbs = JSON.stringify(herbs);
}

function addFinalHerb() {
  const name = document.getElementById("final-new-herb").value.trim();
  const dose = document.getElementById("final-new-dose").value.trim();
  if (!name || !dose) return;

  const container = document.getElementById("final-herb-list");
  const herbs = JSON.parse(container.dataset.herbs || "[]");

  herbs.push({ name, dose });
  document.getElementById("final-new-herb").value = "";
  document.getElementById("final-new-dose").value = "";
  renderFinalHerbList(herbs);
}

function getFinalHerbList() {
  const rows = document.querySelectorAll("#final-herb-list .herb-row");
  const herbs = [];
  rows.forEach(row => {
    const name = row.querySelector(".herb-name")?.value?.trim();
    const dose = row.querySelector(".herb-dose")?.value?.trim();
    if (name && dose && !isNaN(dose)) {
      herbs.push({ name, dose: parseFloat(dose) });
    }
  });
  return herbs;
}

function renderChartTemperature() {
  const herbs = getFinalHerbList();
  if (!herbs.length || !window.herbalData) {
    console.warn("âŒ KhÃ´ng cÃ³ vá»‹ thuá»‘c hoáº·c dá»¯ liá»‡u herbalData chÆ°a sáºµn sÃ ng.");
    return;
  }

  let sum = 0, count = 0;
  const missingTukhi = [];

  herbs.forEach(h => {
    const item = window.herbalData.find(x => x.herb === h.name);
    if (!item) {
      missingTukhi.push(h.name + " (khÃ´ng tÃ¬m tháº¥y)");
      return;
    }

    const tukhi = parseFloat(item.tukhi);
    const sd_dose = parseFloat(item.sd_dose);
    const dose = h.dose;

    if (!isNaN(tukhi) && !isNaN(sd_dose) && sd_dose > 0) {
      const score = (dose / sd_dose) * tukhi;
      sum += score;
      count++;
    } else {
      missingTukhi.push(h.name + " (thiáº¿u tá»© khÃ­ hoáº·c SD)");
    }
  });

  if (missingTukhi.length > 0) {
    alert("âš ï¸ Thiáº¿u dá»¯ liá»‡u cho cÃ¡c vá»‹ thuá»‘c:\n- " + missingTukhi.join("\n- "));
  }

  const avgScore = count ? sum / count : 0;
  renderGradientScale(avgScore); // Gá»i váº½ thanh gradient
}

function renderGradientScale(avgScore) {
  const canvas = document.getElementById("chart-temperature");
  const ctx = canvas.getContext("2d");

  const width = canvas.width;
  const height = canvas.height;

  // XÃ³a canvas cÅ©
  ctx.clearRect(0, 0, width, height);

  // MÃ u cÃ¡c vÃ¹ng tá»© khÃ­
  const colors = [
    "#2c7bb6", // Äáº¡i HÃ n
    "#00a6ca", // HÃ n
    "#00ccbc", // LÆ°Æ¡ng
    "#ffffbf", // BÃ¬nh
    "#fdae61", // Ã”n
    "#f46d43", // Nhiá»‡t
    "#d73027"  // Äáº¡i Nhiá»‡t
  ];

  const labels = ["Äáº¡i HÃ n", "HÃ n", "LÆ°Æ¡ng", "BÃ¬nh", "Ã”n", "Nhiá»‡t", "Äáº¡i Nhiá»‡t"];
  const numZones = labels.length;
  const zoneWidth = width / numZones;

  // Váº½ tá»«ng vÃ¹ng mÃ u
  for (let i = 0; i < numZones; i++) {
    ctx.fillStyle = colors[i];
    ctx.fillRect(i * zoneWidth, 30, zoneWidth, 30);
  }

  // Váº½ nhÃ£n vÃ¹ng
  ctx.fillStyle = "#000";
  ctx.font = "12px sans-serif";
  ctx.textAlign = "center";

  labels.forEach((label, i) => {
    const x = i * zoneWidth + zoneWidth / 2;
    ctx.fillText(label, x, 75);
  });

  // Váº½ mÅ©i tÃªn chá»‰ vá»‹ trÃ­ avgScore [-5 Ä‘áº¿n +5]
  const normalized = (avgScore + 5) / 10;  // chuyá»ƒn sang khoáº£ng [0,1]
  const posX = normalized * width;

  ctx.fillStyle = "black";
  ctx.font = "20px sans-serif";
  ctx.fillText("â¬‡", posX, 25);
}

function renderChartFlavor() {
  const herbs = getFinalHerbList();
  if (!herbs.length || !window.herbalData) {
    console.warn("âŒ KhÃ´ng cÃ³ vá»‹ thuá»‘c hoáº·c dá»¯ liá»‡u.");
    return;
  }

  const flavorLabels = ["Toan", "TÃ¢n", "HÃ m", "Khá»•", "Cam", "PhÆ°Æ¡ng hÆ°Æ¡ng"];
  const flavorKeys = ["chua", "cay", "man", "dang", "ngot", "muithom"];
  const flavorTotals = [0, 0, 0, 0, 0, 0];
  const missingFlavorData = [];

  herbs.forEach(h => {
    const item = window.herbalData.find(x => x.herb === h.name);
    if (!item) {
      missingFlavorData.push(h.name + " (khÃ´ng tÃ¬m tháº¥y)");
      return;
    }

    const dose = parseFloat(h.dose);
    const sd_dose = parseFloat(item.sd_dose);

    if (isNaN(dose) || isNaN(sd_dose) || sd_dose === 0) {
      missingFlavorData.push(h.name + " (thiáº¿u liá»u hoáº·c SD)");
      return;
    }

    let valid = true;
    const scores = flavorKeys.map(key => {
      const value = parseFloat(item[key]);
      if (isNaN(value)) {
        valid = false;
        return 0;
      }
      return (dose / sd_dose) * value;
    });

    if (!valid) {
      missingFlavorData.push(h.name + " (thiáº¿u trá»‹ sá»‘ ngÅ© vá»‹)");
    }

    scores.forEach((s, i) => flavorTotals[i] += s);
  });

  // ğŸ”” Cáº£nh bÃ¡o náº¿u thiáº¿u thÃ´ng tin
  if (missingFlavorData.length > 0) {
    alert("âš ï¸ CÃ¡c vá»‹ thuá»‘c sau thiáº¿u dá»¯ liá»‡u vá»‹ hoáº·c mÃ¹i:\n- " + missingFlavorData.join("\n- "));
  }

  // ğŸ¯ Váº½ biá»ƒu Ä‘á»“ radar
  const ctx = document.getElementById("chart-flavor").getContext("2d");

  if (window.flavorChart) {
    window.flavorChart.destroy();
  }

  window.flavorChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels: flavorLabels,
      datasets: [{
        label: "Tá»•ng há»£p ngÅ© vá»‹ & mÃ¹i",
        data: flavorTotals,
        fill: true,
        backgroundColor: "rgba(255, 99, 132, 0.2)",
        borderColor: "rgba(255, 99, 132, 1)"
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: {
          beginAtZero: true,
          suggestedMax: Math.max(...flavorTotals) + 1
        }
      }
    }
  });
}

function renderChartMeridian() {
  const herbs = getFinalHerbList();
  if (!herbs.length || !window.herbalData) {
    console.warn("âŒ KhÃ´ng cÃ³ vá»‹ thuá»‘c hoáº·c dá»¯ liá»‡u herbalData chÆ°a sáºµn sÃ ng.");
    return;
  }

  const meridianLabels = ["TÃ¢m", "Can", "Tá»³", "Pháº¿", "Tháº­n", "TÃ¢m bÃ o", "Äáº¡i trÆ°á»ng", "Tiá»ƒu trÆ°á»ng", "Vá»‹", "Äá»Ÿm", "BÃ ng quang", "Tam tiÃªu"];
  const meridianKeys = ["tam", "can", "ty", "phe", "than", "tambao", "dai truong", "tieutruong", "vi", "dom", "bangquang", "tamtieu"];
  const meridianTotals = Array(12).fill(0);
  const missingMeridianData = [];

  herbs.forEach(h => {
    const item = window.herbalData.find(x => x.herb === h.name);
    if (!item) {
      missingMeridianData.push(h.name + " (khÃ´ng tÃ¬m tháº¥y)");
      return;
    }

    const dose = parseFloat(h.dose);
    const sd_dose = parseFloat(item.sd_dose);

    if (isNaN(dose) || isNaN(sd_dose) || sd_dose === 0) {
      missingMeridianData.push(h.name + " (thiáº¿u liá»u hoáº·c SD)");
      return;
    }

    let valid = true;
    const scores = meridianKeys.map(key => {
      const value = parseFloat(item[key]);
      if (isNaN(value)) {
        valid = false;
        return 0;
      }
      return (dose / sd_dose) * value;
    });

    if (!valid) {
      missingMeridianData.push(h.name + " (thiáº¿u trá»‹ sá»‘ quy kinh)");
    }

    scores.forEach((s, i) => meridianTotals[i] += s);
  });

  if (missingMeridianData.length > 0) {
    alert("âš ï¸ CÃ¡c vá»‹ thuá»‘c sau thiáº¿u dá»¯ liá»‡u quy kinh:\n- " + missingMeridianData.join("\n- "));
  }

  const ctx = document.getElementById("chart-meridian").getContext("2d");

  if (window.meridianChart) {
    window.meridianChart.destroy();
  }

  window.meridianChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels: meridianLabels,
      datasets: [{
        label: "Tá»•ng há»£p quy kinh",
        data: meridianTotals,
        backgroundColor: "rgba(255, 205, 86, 0.2)",
        borderColor: "rgba(255, 205, 86, 1)"
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: {
          beginAtZero: true,
          suggestedMax: Math.max(...meridianTotals) + 1
        }
      }
    }
  });
}

function safeParseNumber(value) {
  if (value === null || value === undefined || value === "") return NaN;
  return typeof value === "number" ? value : parseFloat(String(value).trim());
}

function renderChartDirection() {
  const herbs = getFinalHerbList();
  if (!herbs.length || !window.herbalData) {
    alert("âš ï¸ KhÃ´ng cÃ³ vá»‹ thuá»‘c hoáº·c dá»¯ liá»‡u.");
    return;
  }

  let xTotal = 0;
  let yTotal = 0;
  const missing = [];

  herbs.forEach(h => {
    const item = window.herbalData.find(x => x.herb === h.name);
    if (!item) {
      missing.push(h.name + " (khÃ´ng tÃ¬m tháº¥y)");
      return;
    }

    const dose = parseFloat(h.dose);
    const sd = parseFloat(item.sd_dose);
    const tg = parseFloat(item.thanggiang);
    const pt = parseFloat(item.phutram);

    if ([dose, sd, tg, pt].some(v => isNaN(v))) {
      missing.push(h.name + " (thiáº¿u trá»‹ sá»‘ ThÄƒng â€“ GiÃ¡ng â€“ PhÃ¹ â€“ Tráº§m)");
      return;
    }

    xTotal += (dose / sd) * pt;
    yTotal += (dose / sd) * tg;
  });

  if (missing.length) {
    alert("âš ï¸ CÃ¡c vá»‹ thuá»‘c thiáº¿u dá»¯ liá»‡u:\n- " + missing.join("\n- "));
  }

  // âš™ï¸ Canvas setup
  const canvas = document.getElementById("chart-direction");
  const ctx = canvas.getContext("2d");
  const width = canvas.width;
  const height = canvas.height;

  ctx.clearRect(0, 0, width, height);

  // ğŸŸ¦ Tá»a Ä‘á»™ gá»‘c
  const originX = width / 2;
  const originY = height / 2;
  const scale = 20;      // 1 Ä‘Æ¡n vá»‹ = 20px
  const maxUnit = 20;    // biá»ƒu Ä‘á»“ hiá»ƒn thá»‹ tá»« -20 Ä‘áº¿n 20

  ctx.lineWidth = 1;
  ctx.strokeStyle = "#e5e7eb"; // lÆ°á»›i nháº¡t

  // ğŸ¯ LÆ°á»›i tá»a Ä‘á»™
  for (let i = -maxUnit; i <= maxUnit; i++) {
    if (i === 0) continue;

    // Dá»c
    ctx.beginPath();
    ctx.moveTo(originX + i * scale, 0);
    ctx.lineTo(originX + i * scale, height);
    ctx.stroke();

    // Ngang
    ctx.beginPath();
    ctx.moveTo(0, originY - i * scale);
    ctx.lineTo(width, originY - i * scale);
    ctx.stroke();
  }

  // ğŸ§­ Trá»¥c chÃ­nh
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2;

  // Trá»¥c X
  ctx.beginPath();
  ctx.moveTo(0, originY);
  ctx.lineTo(width, originY);
  ctx.stroke();

  // Trá»¥c Y
  ctx.beginPath();
  ctx.moveTo(originX, 0);
  ctx.lineTo(originX, height);
  ctx.stroke();

  // âœï¸ NhÃ£n trá»¥c
  ctx.font = "16px Segoe UI";
  ctx.fillStyle = "#1f2937";
  ctx.fillText("ğŸ¡’ PhÃ¹", width - 60, originY - 10);
  ctx.fillText("ğŸ¡ Tráº§m", 10, originY - 10);
  ctx.fillText("ğŸ¡‘ ThÄƒng", originX + 10, 20);
  ctx.fillText("ğŸ¡“ GiÃ¡ng", originX + 10, height - 10);

  // ğŸ”µ Äiá»ƒm M
  const pointX = originX + xTotal * scale;
  const pointY = originY - yTotal * scale;

  ctx.fillStyle = "#2563eb"; // Indigo
  ctx.shadowColor = "rgba(0,0,0,0.2)";
  ctx.shadowBlur = 4;
  ctx.beginPath();
  ctx.arc(pointX, pointY, 5, 0, 2 * Math.PI);
  ctx.fill();
  ctx.shadowBlur = 0;

  ctx.fillStyle = "#111827";
  ctx.fillText(`M (${xTotal.toFixed(2)}, ${yTotal.toFixed(2)})`, pointX + 10, pointY - 10);
}

function autoFillStep5Note() {
  const herbs = getFinalHerbList();
  if (!herbs.length || !window.herbalData) {
    alert("âš ï¸ KhÃ´ng cÃ³ vá»‹ thuá»‘c hoáº·c dá»¯ liá»‡u.");
    return;
  }

  const lines = [];

  herbs.forEach(h => {
    const item = window.herbalData.find(x => x.herb === h.name);
    if (!item) return;

    const toxicNote = item.toxic?.trim();
    const generalNote = item.note?.trim();

    let combinedNote = "";

    if (toxicNote) combinedNote += `â˜ ï¸ ${toxicNote}`;
    if (generalNote) {
      if (combinedNote) combinedNote += " | ";
      combinedNote += `ğŸ“ ${generalNote}`;
    }

    if (combinedNote) {
      lines.push(`â€¢ ${h.name}: ${combinedNote}`);
    }
  });

  const noteBox = document.getElementById("step5-note");
  noteBox.value = lines.join("\n") || "KhÃ´ng cÃ³ ghi chÃº Ä‘áº·c biá»‡t.";
}


function saveStep5() {
  // âœ… Láº¥y dá»¯ liá»‡u vá»‹ thuá»‘c tá»« khá»‘i nháº­p
  const herbContainer = document.getElementById("final-herb-list");
  const herbs = JSON.parse(herbContainer?.dataset.herbs || "[]");

  // âœ… Gá»™p thÃ nh chuá»—i finalFormula: "TÃªn1 Liá»u1 + TÃªn2 Liá»u2 + ..."
  const finalFormula = herbs.map(h => `${h.name} ${h.dose}`).join(" + ");

  // âœ… Láº¥y cÃ¡c thÃ´ng tin cÃ²n láº¡i
  const usage = document.getElementById("step5-usage").value.trim();
  const note = document.getElementById("step5-note").value.trim();
  const datetime = document.getElementById("visit-datetime")?.value || new Date().toISOString();

  // âœ… XÃ¡c Ä‘á»‹nh bá»‡nh nhÃ¢n
  const key = localStorage.getItem("currentPatient");
  if (!key) return alert("ChÆ°a chá»n há»“ sÆ¡!");

  const data = JSON.parse(localStorage.getItem(key) || "{}");
  data.steps = data.steps || {};

  // âœ… LÆ°u thÃ´ng tin bÆ°á»›c 5 (Ä‘á»ƒ hiá»ƒn thá»‹ láº¡i náº¿u chÆ°a nháº¥n LÆ°u Há»“ sÆ¡)
  data.steps.step5 = {
    finalFormula,
    usage,
    note
  };

  // âœ… Láº¥y dá»¯ liá»‡u tá»« cÃ¡c bÆ°á»›c trÆ°á»›c
  const symptoms = data.steps?.step2?.symptoms || [];
  const syndrome = data.steps?.step3 || {};  // CÃ³ model, classic, final

  // âœ… Táº¡o báº£n ghi cho láº§n khÃ¡m má»›i
  const newEntry = {
    datetime,
    symptoms,
    syndrome: {
      model: syndrome.model || "",
      classic: syndrome.classic || "",
      final: syndrome.final || ""
    },
    step5: {
      finalFormula,
      usage,
      note
    }
  };

  // âœ… ÄÆ°a vÃ o lá»‹ch sá»­
  data.steps.step2.history = data.steps.step2.history || [];
  data.steps.step2.history.push(newEntry);

  // âœ… Cáº­p nháº­t cho biá»ƒu Ä‘á»“ (bÆ°á»›c 6)
  data.steps.step6 = data.steps.step6 || {};
  data.steps.step6.followupHistory = data.steps.step2.history;

  // âœ… XÃ³a cÃ¡c dá»¯ liá»‡u táº¡m (cho láº§n khÃ¡m tiáº¿p theo)
  delete data.steps.step2.symptoms;
  delete data.steps.step3;
  delete data.steps.step4;
  delete data.steps.step5;

  // âœ… LÆ°u láº¡i vÃ o localStorage
  localStorage.setItem(key, JSON.stringify(data));
  localStorage.setItem("currentData", JSON.stringify(data));

  alert("âœ… ÄÃ£ lÆ°u hoÃ n táº¥t láº§n khÃ¡m má»›i vÃ o há»“ sÆ¡!");
}

function downloadCurrentDataAsJSON() {
  const data = localStorage.getItem("currentData");
  const patientKey = localStorage.getItem("currentPatient") || "patient_data";
  if (!data) return alert("KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ lÆ°u!");

  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;

  const fileName = patientKey.replace("patient_", "") + "_" + new Date().toISOString().split("T")[0] + ".json";
  a.download = fileName;

  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

  window.onload = () => {
    goToStep(0);
  };
  </script>

  <style>
  .step-tab {
    background-color: #dbeafe; /* bg-blue-100 */
    color: #1e40af;            /* text-blue-800 */
    font-weight: 600;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    transition: all 0.2s;
  }

  .step-tab:hover {
    background-color: #93c5fd; /* hover:bg-blue-300 */
  }

  .step-tab.active {
    background-color: #2563eb; /* bg-blue-600 */
    color: white;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btn-render-tukhi");
    if (btn) {
      btn.addEventListener("click", renderChartTemperature);
    } else {
      console.warn("âŒ KhÃ´ng tÃ¬m tháº¥y nÃºt 'PhÃ¢n tÃ­ch Tá»© khÃ­'.");
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    const btnFlavor = document.getElementById("btn-render-flavor");
    btnFlavor.addEventListener("click", () => {
      renderChartFlavor();
    });
  });

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("btn-render-meridian").addEventListener("click", renderChartMeridian);
    document.getElementById("btn-render-flavor").addEventListener("click", renderChartFlavor);
  });

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btn-render-direction")?.addEventListener("click", renderChartDirection);
});

</script>

</body>
</html>
